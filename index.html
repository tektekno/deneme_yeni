<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Duraklara Göre Sıralama</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kode+Mono:wght@400..700&family=Madimi+One&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
      /* Genel ayarlar */
      body {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        height: 100vh;
        width: 100vw;
        background-color: black;
        color: white;
        font-family: 'Kode Mono', monospace;
        overflow: hidden;
      }

      /* Tüm içeriği kapsayan container */
      .content {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
      }

      /* Güncelleme yazısı ve yükleme simgesi için container */
      .updatetime-container {
        text-align: center;
        font-size: 1.2rem;
        min-height: 1.2rem; /* Metin/yükleyici için yer ayırır */
      }

      /* Yükleme Simgesi */
      .loader {
        border: 4px solid #f3f3f3; /* Açık gri */
        border-top: 4px solid #3498db; /* Mavi */
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 2s linear infinite;
        margin: 0 auto;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* Durakları içeren container */
      .container {
        display: flex;
        flex-wrap: nowrap;
        width: 100%;
        height: auto;
        justify-content: center;
      }

      /* Durak kutuları */
      .durak {
        padding: 1vw 1vh;
        border: 0.2vw solid #ccc;
        border-radius: 2vw;
        text-align: center;
        background-color: #333 !important;
        box-shadow: 0 1vw 1vw rgba(255, 255, 255, 0);
        color: white;
        overflow: hidden;
        line-height: 1.2;
        /* Varsayılan çerçeve kalınlığı */
        border: 0.2vw solid #ccc;
        transition: border-color 0.5s ease;
      }

      /* Dinamik renk sınıfları */
      .durak.hizli {
        border-color: #00ff00; /* Yeşil */
        border-width: 0.5vw;
      }

      .durak.orta {
        border-color: #ffff00; /* Sarı */
        border-width: 0.5vw;
      }

      .durak.yavas {
        border-color: #ff0000; /* Kırmızı */
        border-width: 0.5vw;
      }

      /* Araç listesi için tablo stili */
      .vehicle-table {
        width: 100%;
        table-layout: fixed; /* Tablo sütunlarının genişliğini sabitle */
        border-collapse: collapse; /* Kenarlıkları birleştir */
        margin-top: 0.5rem;
      }

      .vehicle-table td {
        white-space: nowrap; /* Metnin satır atlamasını engelle */
        overflow: hidden; /* Taşmayı gizle */
        text-overflow: ellipsis; /* Taşma durumunda üç nokta göster */
        padding: 0 0.2vw;
      }

      .vehicle-table .right-align {
        text-align: right;
      }

      /* Viewport Bilgi Kutusu */
      #viewport-info {
        position: fixed;
        top: 10px;
        left: 10px;
        padding: 5px 10px;
        background-color: transparent; /* Arka planı şeffaf yapıldı */
        color: rgba(0, 0, 0, 0); /* Yazı rengi tamamen şeffaf yapıldı */
        font-family: 'Kode Mono', monospace;
        font-size: 0.8rem;
        border-radius: 5px;
        cursor: pointer;
        z-index: 1000;
        user-select: none;
        transition: color 0.3s ease, background-color 0.3s ease;
      }
      
      /* Tıklanabilir olduğunda rengi biraz görünür yapma */
      #viewport-info:hover {
        background-color: rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.5);
      }

      /* Dikey düzen (width < height) */
      @media (min-aspect-ratio: 0) and (max-aspect-ratio: 0.499) {
        .content {
          padding-top: 2vw;
        }
        .updatetime-container {
          font-size: 4vw;
        }
        .container {
          padding-top: 5%;
          flex-direction: column;
          gap: 2.3vw;
          align-items: center;
          margin-bottom: 2%;
        }
        .durak {
          width: 60vw;
          height: 40vw;
          font-size: 2.5vw;
        }
      }

      /* Dikey düzen (width < height) */
      @media (min-aspect-ratio: 0.5) and (max-aspect-ratio: 0.799) {
        .content {
          padding-top: 1vw;
        }
        .updatetime-container {
          font-size: 4vw;
        }
        .container {
          padding-top: 5%;
          flex-direction: column;
          gap: 2.3vw;
          align-items: center;
          margin-bottom: 2%;
        }
        .durak {
          width: 50vw;
          height: 40vw;
          font-size: 2.5vw;
        }
      }

      /* Dikey düzen (width < height) */
      @media (min-aspect-ratio: 0.799) and (max-aspect-ratio: 0.99) {
        .content {
          padding-top: 1vw;
        }
        .updatetime-container {
          font-size: 3vw;
        }
        .container {
          padding-top: 5%;
          flex-direction: column;
          gap: 2vw;
          align-items: center;
          margin-bottom: 2%;
        }
        .durak {
          width: 40vw;
          height: 35vw;
          font-size: 1.8vw;
        }
      }

      /* Yatay düzen (width > height) */
      @media (min-aspect-ratio: 1) and (max-aspect-ratio: 1.499) {
        .content {
          padding-top: 2%;
        }
        .updatetime-container {
          font-size: 2.5vw;
        }
        .container {
          flex-direction: row;
          justify-content: center;
          gap: 5vh;
          margin-top: 2%;
          margin-bottom: 5%;
        }
        .durak {
          width: 20vw;
          height: 23vw;
          font-size: 0.9vw;
        }
      }

      @media (min-aspect-ratio: 1.5) and (max-aspect-ratio: 1.899) {
        .content {
          padding-top: 2%;
        }
        .updatetime-container {
          font-size: 2.5vw;
        }
        .container {
          flex-direction: row;
          justify-content: center;
          gap: 2vw;
          margin-top: 2%;
          margin-bottom: 5%;
        }
        .durak {
          width: 25vw;
          height: 23vw;
          font-size: 1.2vw;
        }
      }

      /* Bu kısım özellikle 1600x765 gibi geniş ekranlar için güncellendi */
      @media (min-aspect-ratio: 1.9) {
        .content {
          padding-top: 2%;
        }
        .updatetime-container {
          font-size: 2.7vw;
        }
        .container {
          flex-direction: row;
          justify-content: center;
          gap: 2vw;
          margin-top: 2%;
          margin-bottom: 5%;
        }
        .durak {
          width: 25vw;
          height: 20vw;
          font-size: 1.1vw;
        }
      }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  </head>
  <body>
    <div id="viewport-info"></div>
    <div class="content">
      <div id="main-container">
        <div class="updatetime-container">
          <!-- Yükleniyor simgesi -->
          <div id="loader" class="loader"></div>
          <!-- Son güncelleme zamanı metni -->
          <div id="updatetime" style="display: none;"></div>
          <!-- GPS bilgi metni -->
          <div id="gps-info" style="display: none; margin-top: 0.5rem; color: #90EE90;"></div>
        </div>
        <div id="duraklar-container" class="container">
          </div>
      </div>
    </div>
    <script>
      // Firebase yapılandırma bilgileri
      const firebaseConfig = {
        apiKey: "AIzaSyCTTDvLsIY3ZS8zNP77lxLG0SdoOke2vLk",
        authDomain: "kptakip.firebaseapp.com",
        databaseURL: "https://kptakip-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "kptakip",
        storageBucket: "kptakip.firebasestorage.app",
        messagingSenderId: "401633293269",
        appId: "1:401633293269:web:8386edc126aafe1929435c"
      };
      // Firebase uygulamasını başlat
      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();
      const ref = database.ref('taksi_verileri');
      // Elemanları seç
      const mainContainer = document.getElementById('main-container');
      const duraklarContainer = document.getElementById('duraklar-container');
      const updateTimeElement = document.getElementById('updatetime');
      const loaderElement = document.getElementById('loader');
      const gpsInfoElement = document.getElementById('gps-info'); // GPS bilgi elementini seç
      const viewportInfo = document.getElementById('viewport-info');

      /**
       * Saniye cinsinden verilen süreyi "Xgn Ysa Zdk Psn" formatına dönüştürür.
       * @param {number} totalSeconds - Toplam saniye süresi.
       * @returns {string} Formatlanmış süre metni.
       */
      function formatDuration(totalSeconds) {
        if (totalSeconds < 0) {
          totalSeconds = 0;
        }

        const days = Math.floor(totalSeconds / (24 * 60 * 60));
        const hours = Math.floor((totalSeconds % (24 * 60 * 60)) / (60 * 60));
        const minutes = Math.floor((totalSeconds % (60 * 60)) / 60);
        const seconds = totalSeconds % 60;

        const parts = [];
        if (days > 0) {
          parts.push(`${days}gn`);
        }
        if (hours > 0) {
          parts.push(`${hours}sa`);
        }
        if (minutes > 0) {
          parts.push(`${minutes}dk`);
        }
        parts.push(`${seconds}sn`);
        

        return parts.join(' ');
      }

      /**
       * Zaman birimini formatlar. Eğer değer 0 ise ve forceDisplayZero true değilse boş string döndürür.
       * Tek haneli değerler için bir boşluk ekler ve sağa yaslar.
       * @param {number} value - Zaman biriminin değeri (gün, saat, dakika, saniye).
       * @param {string} unit - Zaman biriminin kısaltması (örn: 'gn', 'sa', 'dk', 'sn').
       * @param {boolean} [forceDisplayZero=false] - Değer 0 olsa bile gösterilmesini zorlar.
       * @param {string} [padChar='&nbsp;'] - Tek haneli değerler için kullanılacak dolgu karakteri.
       * @returns {string} Doldurulmuş ve hizalanmış metin veya boş string.
       */
      function padTimeDisplay(value, unit, forceDisplayZero = false, padChar = '&nbsp;') {
        if (value === 0 && !forceDisplayZero) {
          return '';
        }
        // Tek haneli değerler için bir boşluk ekle
        if (value < 10 && value >= 0) {
          return `${padChar}${value}${unit}`;
        }
        return `${value}${unit}`;
      }

      function renderData(data) {
        // Yükleme simgesini gizle ve güncelleme metinlerini göster
        loaderElement.style.display = 'none';
        updateTimeElement.style.display = 'block';
        gpsInfoElement.style.display = 'block';

        // Güncelleme zamanını ve GPS bilgi metnini ayarla
        updateTimeElement.textContent = `Son Güncelleme: ${data.son_guncelleme}`;
        gpsInfoElement.textContent = "29 (5023) - 30 (7274) - 32 (6383) kodlu araçlarda GPS sorunu olduğu için burada görünmemektedir.";
        
        // Durak bilgilerini işle
        duraklarContainer.innerHTML = '';
        const duraklar = data.duraklar;
        const durak_names = {
          suvari: "Süvari",
          merkez: "Merkez",
          metro: "Metro"
        };
        
        // Durakları belirli bir sırada oluştur
        const orderedDuraks = ['merkez', 'metro', 'suvari'];
        
        // Ortalama kalkış sürelerini topla ve sırala
        const averageTimes = orderedDuraks.map(key => ({
            key,
            time: duraklar[key].ortalama_kalkis
        })).sort((a, b) => a.time - b.time);

        // En hızlı, orta ve en yavaş durakları belirle
        const fastest = averageTimes[0].key;
        const middle = averageTimes[1].key;
        const slowest = averageTimes[2].key;

        // Her bir durak için ayrı ayrı hizalama uzunluğunu belirle
        orderedDuraks.forEach(key => {
            if (duraklar.hasOwnProperty(key)) {
                const durak = duraklar[key];
                const durakDiv = document.createElement('div');
                durakDiv.className = 'durak';
                
                // Hız durumuna göre sınıf ekle
                if (key === fastest) {
                    durakDiv.classList.add('hizli');
                } else if (key === middle) {
                    durakDiv.classList.add('orta');
                } else if (key === slowest) {
                    durakDiv.classList.add('yavas');
                }
                
                let htmlContent = '';
                
                // Başlık satırı
                htmlContent += `${durak_names[key]} (${durak.liste ? durak.liste.length : 0})<br>`;
                
                // Ortalama kalkış satırı
                const formattedAverageDeparture = formatDuration(durak.ortalama_kalkis);
                htmlContent += `Ortalama Kalkış: ${formattedAverageDeparture}<br>`;

                // Ayırıcı çizgi
                htmlContent += `—————————————————————————<br>`;
                
                const aracListesi = durak.liste || [];
                const aracSayisi = aracListesi.length;
                
                // Araç listesi
                if (aracSayisi > 0) {
                    // Sütunların gösterilip gösterilmeyeceğini belirlemek için kontroller
                    const showDays = aracListesi.some(arac => arac.entry_duration >= 86400);
                    const showHours = aracListesi.some(arac => arac.entry_duration >= 3600);
                    const showMinutes = aracListesi.some(arac => arac.entry_duration >= 60);


                    htmlContent += '<table class="vehicle-table"><tbody>';
                    aracListesi.forEach((arac, index) => {
                        const totalSeconds = arac.entry_duration;
                        const days = Math.floor(totalSeconds / (24 * 60 * 60));
                        const hours = Math.floor((totalSeconds % (24 * 60 * 60)) / (60 * 60));
                        const minutes = Math.floor((totalSeconds % (60 * 60)) / 60);
                        const seconds = totalSeconds % 60;

                        htmlContent += `<tr>`;
                        htmlContent += `<td>${index + 1})</td>`;
                        htmlContent += `<td>${arac.code}</td>`;
                        htmlContent += `<td>${arac.plate}</td>`;
                        
                        if (showDays && days > 0) { // Gün 0 ise gösterme
                            htmlContent += `<td class="right-align">${padTimeDisplay(days, 'gn')}</td>`;
                        }
                        if (showHours) {
                            htmlContent += `<td class="right-align">${padTimeDisplay(hours, 'sa')}</td>`; // Saat 0 ise gösterme
                            htmlContent += `<td class="right-align">${padTimeDisplay(minutes, 'dk')}</td>`; // Dakika 0 ise gösterme
                            htmlContent += `<td class="right-align">${padTimeDisplay(seconds, 'sn', true)}</td>`; // Saniye her zaman göster
                        } else if (showMinutes) {
                            htmlContent += `<td class="right-align">${padTimeDisplay(minutes, 'dk')}</td>`; // Dakika 0 ise gösterme
                            htmlContent += `<td class="right-align">${padTimeDisplay(seconds, 'sn', true)}</td>`; // Saniye her zaman göster
                        } else {
                            htmlContent += `<td class="right-align">${padTimeDisplay(seconds, 'sn', true)}</td>`; // Saniye her zaman göster
                        }
                        
                        htmlContent += `</tr>`;
                    });
                    htmlContent += '</tbody></table>';
                } else {
                    htmlContent += 'Boş';
                }
                
                durakDiv.innerHTML = htmlContent;
                duraklarContainer.appendChild(durakDiv);
            }
        });
      }

      // Veritabanı referansındaki veriyi dinle
      ref.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data && data.duraklar) {
          renderData(data);
        } else {
          console.error("Veri alınamadı veya 'duraklar' anahtarı bulunamadı.");
          // Hata durumunda yükleyiciyi gizle ve hata mesajını göster
          loaderElement.style.display = 'none';
          updateTimeElement.style.display = 'block';
          duraklarContainer.innerHTML = '<p style="color:red; text-align:center;">Veri alınamadı. Lütfen Python betiğinin çalıştığından emin olun.</p>';
        }
      }, (error) => {
        console.error("Veri okuma hatası: ", error);
        // Hata durumunda yükleyiciyi gizle ve hata mesajını göster
        loaderElement.style.display = 'none';
        updateTimeElement.style.display = 'block';
        duraklarContainer.innerHTML = '<p style="color:red; text-align:center;">Veri okuma hatası oluştu. Konsolu kontrol edin.</p>';
      });

      // Viewport bilgisi fonksiyonları
      function updateViewportInfo() {
        const width = window.innerWidth;
        const height = window.innerHeight;
        // En/Boy oranını hesapla ve 2 ondalık basamağa yuvarla
        const aspectRatio = (width / height).toFixed(2);
        viewportInfo.textContent = `Viewport: ${width}x${height} | En/Boy Oranı: ${aspectRatio} w/h`;
      }
      
      // Viewport bilgisi div'ine tıklama olayı ekle
      viewportInfo.onclick = function() {
        const textToCopy = this.textContent;
        const tempTextArea = document.createElement('textarea');
        tempTextArea.value = textToCopy;
        document.body.appendChild(tempTextArea);
        tempTextArea.select();
        document.execCommand('copy');
        document.body.removeChild(tempTextArea);
        
        this.textContent = 'Kopyalandı!';
        // Kopyalama mesajı görünür hale getirildi
        this.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
        this.style.color = 'white';

        setTimeout(() => {
            // Mesajı eski haline döndür
            updateViewportInfo();
            this.style.backgroundColor = 'transparent';
            this.style.color = 'rgba(0, 0, 0, 0)';
        }, 1000);
      };

      // Sayfa yüklendiğinde ve pencere yeniden boyutlandırıldığında tüm ayarları yap
      window.addEventListener('load', () => {
          // İlk yüklemede viewport bilgisini güncelle
          updateViewportInfo();
      });

      // Pencere boyutu değiştiğinde viewport bilgisini güncelle
      window.addEventListener('resize', updateViewportInfo);
    </script>
  </body>
</html>
