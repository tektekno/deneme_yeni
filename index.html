<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Duraklara Göre Sıralama</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kode+Mono:wght@400..700&family=Madimi+One&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
      /* Genel ayarlar */
      body {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        height: 100vh;
        width: 100vw;
        background-color: black;
        color: white;
        font-family: 'Kode Mono', monospace;
        overflow: hidden;
      }

      /* Tüm içeriği kapsayan container */
      .content {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
      }

      /* Güncelleme yazısı ve yükleme simgesi için container */
      .updatetime-container {
        text-align: center;
        font-size: 1.2rem;
        min-height: 1.2rem; /* Metin/yükleyici için yer ayırır */
      }

      /* Yükleme Simgesi */
      .loader {
        border: 4px solid #f3f3f3; /* Açık gri */
        border-top: 4px solid #3498db; /* Mavi */
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 2s linear infinite;
        margin: 0 auto;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* Durakları içeren container */
      .container {
        display: flex;
        flex-wrap: nowrap;
        width: 100%;
        height: auto;
        justify-content: center;
      }

      /* Durak kutuları */
      .durak {
        padding: 1vw 1vh 2vw 1vh;
        border: 0.2vw solid #ccc;
        border-radius: 2vw;
        text-align: center;
        background-color: #333 !important;
        box-shadow: 0 1vw 1vw rgba(255, 255, 255, 0);
        color: white;
        overflow: hidden;
        line-height: 1.2;
        /* Varsayılan çerçeve kalınlığı */
        border: 0.2vw solid #ccc;
        transition: border-color 0.5s ease;
      }

      /* Dinamik renk sınıfları */
      .durak.hizli {
        border-color: #00ff00; /* Yeşil */
        border-width: 0.5vw;
      }

      .durak.orta {
        border-color: #ffff00; /* Sarı */
        border-width: 0.5vw;
      }

      .durak.yavas {
        border-color: #ff0000; /* Kırmızı */
        border-width: 0.5vw;
      }

      /* Araç listesi için tablo stili */
      .vehicle-table {
        width: 100%;
        border-collapse: collapse; /* Kenarlıkları birleştir */
        margin-top: 0.5rem;
        font-size: inherit; /* Yazı tipi boyutunu parent elementten (durak) al */
      }

      .vehicle-table td {
        white-space: nowrap; /* Metnin satır atlamasını engelle */
        overflow: hidden; /* Taşmayı gizle */
        text-overflow: ellipsis; /* Taşma durumunda üç nokta göster */
        padding: 0 0.2vw;
      }

      .vehicle-table .right-align {
        text-align: right;
      }

      /* Viewport Bilgi Kutusu */
      #viewport-info {
        position: fixed;
        top: 10px;
        left: 10px;
        padding: 8px 12px;
        background-color: transparent; /* Başlangıçta şeffaf */
        color: transparent; /* Başlangıçta şeffaf */
        font-family: 'Kode Mono', monospace;
        font-size: 0.8rem;
        border-radius: 5px;
        cursor: pointer;
        z-index: 1000;
        user-select: none;
        transition: color 0.3s ease, background-color 0.3s ease;
      }
      
      /* Tıklanabilir olduğunda rengi biraz görünür yapma */
      #viewport-info:hover {
        background-color: rgba(0, 0, 0, 0.6);
        color: white;
      }

      /* Debug Butonları için Stiller */
      #debug-controls {
        position: fixed;
        bottom: 10px;
        right: 10px;
        background-color: rgba(0, 0, 0, 0.7);
        padding: 10px;
        border-radius: 8px;
        z-index: 1001;
        display: flex;
        flex-direction: column;
        gap: 8px;
        font-size: 0.9rem;
      }
      #debug-controls div {
        display: flex;
        align-items: center;
        gap: 5px;
      }
      #debug-controls button {
        width: 25px;
        height: 25px;
        font-weight: bold;
        cursor: pointer;
      }

    </style>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  </head>
  <body>
    <div id="debug-controls" style="display: none;">
      <div>
        <span>Merkez:</span>
        <button id="add-merkez">+</button>
        <button id="remove-merkez">-</button>
      </div>
      <div>
        <span>Metro:</span>
        <button id="add-metro">+</button>
        <button id="remove-metro">-</button>
      </div>
      <div>
        <span>Süvari:</span>
        <button id="add-suvari">+</button>
        <button id="remove-suvari">-</button>
      </div>
    </div>
    <div id="viewport-info"></div>
    <div class="content">
      <div id="main-container">
        <div class="updatetime-container">
          <!-- Yükleniyor simgesi -->
          <div id="loader" class="loader"></div>
          <!-- Son güncelleme zamanı metni -->
          <div id="updatetime" style="display: none;"></div>
          <!-- GPS bilgi metni -->
          <div id="gps-info" style="display: none; margin-top: 0.5rem; color: #90EE90;"></div>
        </div>
        <div id="duraklar-container" class="container">
          </div>
      </div>
    </div>
    <script>
      // Firebase yapılandırma bilgileri
      const firebaseConfig = {
        apiKey: "AIzaSyCTTDvLsIY3ZS8zNP77lxLG0SdoOke2vLk",
        authDomain: "kptakip.firebaseapp.com",
        databaseURL: "https://kptakip-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "kptakip",
        storageBucket: "kptakip.firebasestorage.app",
        messagingSenderId: "401633293269",
        appId: "1:401633293269:web:8386edc126aafe1929435c"
      };
      // Firebase uygulamasını başlat
      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();
      const ref = database.ref('taksi_verileri');
      // Elemanları seç
      const mainContainer = document.getElementById('main-container');
      const duraklarContainer = document.getElementById('duraklar-container');
      const updateTimeElement = document.getElementById('updatetime');
      const loaderElement = document.getElementById('loader');
      const gpsInfoElement = document.getElementById('gps-info'); // GPS bilgi elementini seç
      const viewportInfo = document.getElementById('viewport-info');

      /**
       * Saniye cinsinden verilen süreyi "Xgn Ysa Zdk Psn" formatına dönüştürür.
       * @param {number} totalSeconds - Toplam saniye süresi.
       * @returns {string} Formatlanmış süre metni.
       */
      function formatDuration(totalSeconds) {
        if (totalSeconds < 0) {
          totalSeconds = 0;
        }

        const days = Math.floor(totalSeconds / (24 * 60 * 60));
        const hours = Math.floor((totalSeconds % (24 * 60 * 60)) / (60 * 60));
        const minutes = Math.floor((totalSeconds % (60 * 60)) / 60);
        const seconds = totalSeconds % 60;

        const parts = [];
        if (days > 0) {
          parts.push(`${days}gn`);
        }
        if (hours > 0) {
          parts.push(`${hours}sa`);
        }
        if (minutes > 0) {
          parts.push(`${minutes}dk`);
        }
        parts.push(`${seconds}sn`);
        

        return parts.join(' ');
      }

      /**
       * Zaman birimini formatlar. Eğer değer 0 ise ve forceDisplayZero true değilse boş string döndürür.
       * Tek haneli değerler için bir boşluk ekler ve sağa yaslar.
       * @param {number} value - Zaman biriminin değeri (gün, saat, dakika, saniye).
       * @param {string} unit - Zaman biriminin kısaltması (örn: 'gn', 'sa', 'dk', 'sn').
       * @param {boolean} [forceDisplayZero=false] - Değer 0 olsa bile gösterilmesini zorlar.
       * @param {string} [padChar='&nbsp;'] - Tek haneli değerler için kullanılacak dolgu karakteri.
       * @returns {string} Doldurulmuş ve hizalanmış metin veya boş string.
       */
      function padTimeDisplay(value, unit, forceDisplayZero = false, padChar = '&nbsp;') {
        if (value === 0 && !forceDisplayZero) {
          return '';
        }
        // Tek haneli değerler için bir boşluk ekle
        if (value < 10 && value >= 0) {
          return `${padChar}${value}${unit}`;
        }
        return `${value}${unit}`;
      }

      function renderData(data) {
        // Yükleme simgesini gizle ve güncelleme metinlerini göster
        loaderElement.style.display = 'none';
        updateTimeElement.style.display = 'block';
        gpsInfoElement.style.display = 'block';

        // Güncelleme zamanını ve GPS bilgi metnini ayarla
        updateTimeElement.textContent = `Son Güncelleme: ${data.son_guncelleme}`;
        gpsInfoElement.textContent = "29 (5023) - 30 (7274) - 32 (6383) kodlu araçlarda GPS sorunu olduğu için burada görünmemektedir.";

        // Stilleri sıfırlamak için bir fonksiyon (pencere yeniden boyutlandırıldığında kullanışlı)
        function resetDurakStyles(durakDiv) {
            durakDiv.style.width = '';
            durakDiv.style.height = '';
            durakDiv.style.fontSize = '';
            durakDiv.style.lineHeight = '';
            durakDiv.style.padding = '';
            // Font büyüklüğü sınıflarını temizle
            durakDiv.classList.remove('font-size-large', 'font-size-xlarge');
        }

        // Dinamik font büyüklüğü sınıfları için stilleri dinamik olarak ekle
        // Bu, media query'lerdeki .font-size-large gibi sınıfların yerini alır
        const contentDiv = document.querySelector('.content');
        const aspectRatio = window.innerWidth / window.innerHeight;

        const styleSheet = document.createElement("style");
        if (aspectRatio < 0.5) {
          styleSheet.innerText = `.durak.font-size-large { font-size: 3.2vw; } .durak.font-size-xlarge { font-size: 3.5vw; }`;
        } else if (aspectRatio < 0.85) {
          styleSheet.innerText = `.durak.font-size-large { font-size: 2.8vw; } .durak.font-size-xlarge { font-size: 3.1vw; }`;
        }
        document.head.appendChild(styleSheet);

        
        // Durak bilgilerini işle
        duraklarContainer.innerHTML = '';
        const duraklar = data.duraklar;
        const durak_names = {
          suvari: "Süvari",
          merkez: "Merkez",
          metro: "Metro"
        };
        
        // Durakları belirli bir sırada oluştur
        const orderedDuraks = ['merkez', 'metro', 'suvari'];
        
        // Ortalama kalkış sürelerini topla ve sırala
        const averageTimes = orderedDuraks.map(key => ({
            key,
            time: duraklar[key].ortalama_kalkis
        })).sort((a, b) => a.time - b.time);

        // En hızlı, orta ve en yavaş durakları belirle
        const fastest = averageTimes[0].key;
        const middle = averageTimes[1].key;
        const slowest = averageTimes[2].key;

        // Her bir durak için ayrı ayrı hizalama uzunluğunu belirle
        orderedDuraks.forEach(key => {
            if (duraklar.hasOwnProperty(key)) {
                const durak = duraklar[key];
                const durakDiv = document.createElement('div');
                durakDiv.className = 'durak';
                
                // Hız durumuna göre sınıf ekle
                if (key === fastest) {
                    durakDiv.classList.add('hizli');
                } else if (key === middle) {
                    durakDiv.classList.add('orta');
                } else if (key === slowest) {
                    durakDiv.classList.add('yavas');
                }
                
                let htmlContent = '';
                
                // Başlık satırı
                htmlContent += `${durak_names[key]} (${durak.liste ? durak.liste.length : 0})<br>`;
                
                // Ortalama kalkış satırı
                const formattedAverageDeparture = formatDuration(durak.ortalama_kalkis);
                htmlContent += `Ortalama Kalkış: ${formattedAverageDeparture}<br>`;

                // Ayırıcı çizgi
                htmlContent += `—————————————————————————<br>`;
                
                const aracListesi = durak.liste || [];
                const aracSayisi = aracListesi.length;

                // Önceki stilleri temizle
                resetDurakStyles(durakDiv);

                // --- En-boy oranına göre DURAK stilleri ve dinamik yükseklik ---
                // Genel container stilleri de artık burada, her bir durak için değil, sadece bir kez ayarlanacak.
                if (!duraklarContainer.style.flexDirection) { // Stillerin tekrar tekrar atanmasını önle
                  if (aspectRatio < 1.1) { // Dikey ve kareye yakın düzenler
                    duraklarContainer.style.flexDirection = 'column';
                    duraklarContainer.style.alignItems = 'center';
                    duraklarContainer.style.paddingTop = '5%';
                    duraklarContainer.style.marginBottom = '2%';
                  } else { // Yatay düzenler
                    duraklarContainer.style.flexDirection = 'row';
                    duraklarContainer.style.justifyContent = 'center';
                    duraklarContainer.style.marginTop = '2%';
                    duraklarContainer.style.marginBottom = '5%';
                  }
                }

                if (aspectRatio < 0.5) {
                  durakDiv.style.width = '67vw';
                  durakDiv.style.padding = '2.5vw 1vh';
                  durakDiv.style.fontSize = '4vw';
                  const baseHeight = 12.5;
                  const heightPerVehicle = 5.8; // Oranlandı
                  const totalHeight = baseHeight + (aracSayisi * heightPerVehicle);
                  durakDiv.style.height = `${totalHeight.toFixed(2)}vw`;
                  durakDiv.style.minHeight = '20vw';
                  // Genel stiller
                  contentDiv.style.paddingTop = '2vw';
                  updateTimeElement.style.fontSize = '4vw'; // durak başlıkları ile aynı boyutta
                  gpsInfoElement.style.fontSize = '4vw'; // durak başlıkları ile aynı boyutta
                  duraklarContainer.style.gap = '9vw';

                }else if (aspectRatio < 0.75) {
                  durakDiv.style.width = '60vw';
                  durakDiv.style.padding = '2.5vw 1vh';
                  durakDiv.style.fontSize = '3.2vw';
                  durakDiv.style.lineHeight = '1.15';
                  const baseHeight = 9.5;
                  const heightPerVehicle = 4; // Oranlandı
                  const totalHeight = baseHeight + (aracSayisi * heightPerVehicle);
                  durakDiv.style.height = `${totalHeight.toFixed(2)}vw`;
                  durakDiv.style.minHeight = '14vw';
                  // Genel stiller
                  contentDiv.style.paddingTop = '1vw';
                  updateTimeElement.style.fontSize = '3.2vw'; // durak başlıkları ile aynı boyutta
                  gpsInfoElement.style.fontSize = '3.2vw'; // durak başlıkları ile aynı boyutta
                  duraklarContainer.style.gap = '2vw';
                
                
                }else if (aspectRatio < 0.85) {
                  durakDiv.style.width = '60vw';
                  durakDiv.style.padding = '2.5vw 1vh';
                  durakDiv.style.fontSize = '2.3vw';
                  durakDiv.style.lineHeight = '1.15';
                  const baseHeight = 9.5;
                  const heightPerVehicle = 2.5; // Oranlandı
                  const totalHeight = baseHeight + (aracSayisi * heightPerVehicle);
                  durakDiv.style.height = `${totalHeight.toFixed(2)}vw`;
                  durakDiv.style.minHeight = '18vw';
                  // Genel stiller
                  contentDiv.style.paddingTop = '1vw';
                  updateTimeElement.style.fontSize = '2.3vw'; // durak başlıkları ile aynı boyutta
                  gpsInfoElement.style.fontSize = '2.3vw'; // durak başlıkları ile aynı boyutta
                  duraklarContainer.style.gap = '2vw';

                } else if (aspectRatio < 0.9) {
                  durakDiv.style.width = '50vw';
                  durakDiv.style.fontSize = '2.6vw';
                  const baseHeight = 8.5;
                  const heightPerVehicle = 3.6; // Oranlandı
                  const totalHeight = baseHeight + (aracSayisi * heightPerVehicle);
                  durakDiv.style.height = `${totalHeight.toFixed(2)}vw`;
                  durakDiv.style.minHeight = '15vw';
                  // Genel stiller
                  contentDiv.style.paddingTop = '1vw';
                  updateTimeElement.style.fontSize = '2.6vw'; // durak başlıkları ile aynı boyutta
                  gpsInfoElement.style.fontSize = '2.6vw'; // durak başlıkları ile aynı boyutta
                  duraklarContainer.style.gap = '2vw';
                } else if (aspectRatio < 1.2) {
                  durakDiv.style.width = '27vw';
                  durakDiv.style.height = '23vw';
                  durakDiv.style.fontSize = '1.4vw';
                  durakDiv.style.minHeight = '23vw';
                  // Genel stiller
                  contentDiv.style.paddingTop = '2%';
                  updateTimeElement.style.fontSize = '1.4vw'; // durak başlıkları ile aynı boyutta
                  gpsInfoElement.style.fontSize = '1.4vw'; // durak başlıkları ile aynı boyutta
                  duraklarContainer.style.gap = '2vh';

                } else if (aspectRatio < 1.5) {
                  durakDiv.style.width = '28vw';
                  durakDiv.style.height = '23vw';
                  durakDiv.style.fontSize = '1.4vw';
                  durakDiv.style.minHeight = '23vw';
                  // Genel stiller
                  contentDiv.style.paddingTop = '2%';
                  updateTimeElement.style.fontSize = '1.4vw'; // durak başlıkları ile aynı boyutta
                  gpsInfoElement.style.fontSize = '1.4vw'; // durak başlıkları ile aynı boyutta
                  duraklarContainer.style.gap = '2vh';

                } else if (aspectRatio < 1.9) {
                  durakDiv.style.width = '25vw';
                  durakDiv.style.height = '23vw';
                  durakDiv.style.fontSize = '1.4vw';
                  durakDiv.style.minHeight = '23vw';
                  // Genel stiller
                  contentDiv.style.paddingTop = '2%';
                  updateTimeElement.style.fontSize = '1.4vw'; // durak başlıkları ile aynı boyutta
                  gpsInfoElement.style.fontSize = '1.4vw'; // durak başlıkları ile aynı boyutta
                  duraklarContainer.style.gap = '2vw';

                } else {
                  durakDiv.style.width = '25vw';
                  durakDiv.style.height = '20vw';
                  durakDiv.style.fontSize = '1.3vw';
                  durakDiv.style.minHeight = '20vw';
                  // Genel stiller
                  contentDiv.style.paddingTop = '2%';
                  updateTimeElement.style.fontSize = '1.3vw'; // durak başlıkları ile aynı boyutta
                  gpsInfoElement.style.fontSize = '1.3vw'; // durak başlıkları ile aynı boyutta
                  duraklarContainer.style.gap = '2vw';
                }

                // Araç listesi
                if (aracSayisi > 0) {
                    // Sütunların gösterilip gösterilmeyeceğini belirlemek için kontroller
                    const showDays = aracListesi.some(arac => arac.entry_duration >= 86400);
                    const showHours = aracListesi.some(arac => arac.entry_duration >= 3600);
                    const showMinutes = aracListesi.some(arac => arac.entry_duration >= 60);

                    // Sütun durumuna göre font boyutu için sınıf ekle
                    if (!showHours && !showMinutes) {
                      durakDiv.classList.add('font-size-xlarge'); // Sadece saniye varsa
                    } else if (!showHours) {
                      durakDiv.classList.add('font-size-large'); // Sadece dakika/saniye varsa
                    }

                    htmlContent += '<table class="vehicle-table"><tbody>';
                    aracListesi.forEach((arac, index) => {
                        const totalSeconds = arac.entry_duration;
                        const days = Math.floor(totalSeconds / (24 * 60 * 60));
                        const hours = Math.floor((totalSeconds % (24 * 60 * 60)) / (60 * 60));
                        const minutes = Math.floor((totalSeconds % (60 * 60)) / 60);
                        const seconds = totalSeconds % 60;

                        htmlContent += `<tr>`;
                        htmlContent += `<td>${index + 1})</td>`;
                        htmlContent += `<td>${arac.code}</td>`;
                        htmlContent += `<td>${arac.plate}</td>`;
                        
                        if (showDays && days > 0) { // Gün 0 ise gösterme
                            htmlContent += `<td class="right-align">${padTimeDisplay(days, 'gn')}</td>`;
                        }
                        if (showHours) {
                            htmlContent += `<td class="right-align">${padTimeDisplay(hours, 'sa')}</td>`; // Saat 0 ise gösterme
                            htmlContent += `<td class="right-align">${padTimeDisplay(minutes, 'dk')}</td>`; // Dakika 0 ise gösterme
                            htmlContent += `<td class="right-align">${padTimeDisplay(seconds, 'sn', true)}</td>`; // Saniye her zaman göster
                        } else if (showMinutes) {
                            htmlContent += `<td class="right-align">${padTimeDisplay(minutes, 'dk')}</td>`; // Dakika 0 ise gösterme
                            htmlContent += `<td class="right-align">${padTimeDisplay(seconds, 'sn', true)}</td>`; // Saniye her zaman göster
                        } else {
                            htmlContent += `<td class="right-align">${padTimeDisplay(seconds, 'sn', true)}</td>`; // Saniye her zaman göster
                        }
                        
                        htmlContent += `</tr>`;
                    });
                    htmlContent += '</tbody></table>';
                } else {
                    htmlContent += 'Boş';
                }
                
                durakDiv.innerHTML = htmlContent;
                duraklarContainer.appendChild(durakDiv);
            }
        });
      }

      // --- DEBUG MODU ---
      // Test verilerini kullanmak için `true`, gerçek zamanlı Firebase verilerini kullanmak için `false` yapın.
      const DEBUG_MODE = false; 

      if (DEBUG_MODE) {
        // --- DEBUG MODU İÇİN KONTROL VE VERİ YAPISI ---

        // 1. Butonları ve kontrol panelini görünür yap
        const debugControls = document.getElementById('debug-controls');
        const STORAGE_KEY = 'debugVehicleState';
        debugControls.style.display = 'flex';

        // Viewport bilgisini görünür yap
        const viewportInfoDiv = document.getElementById('viewport-info');
        viewportInfoDiv.style.backgroundColor = 'rgba(0, 0, 0, 0.6)';
        viewportInfoDiv.style.color = 'white';

        // 2. Tüm olası araçları içeren bir havuz oluştur
        const allVehicles = [
            { code: "21", plate: "35T7575" }, { code: "22", plate: "35T5702" },
            { code: "23", plate: "35T6619" }, { code: "24", plate: "35T7734" },
            { code: "25", plate: "35T5595" }, { code: "26", plate: "35T6913" },
            { code: "27", plate: "35T6581" }, { code: "28", plate: "35T6272" },
            { code: "29", plate: "35T5023" }, { code: "30", plate: "35T7274" },
            { code: "32", plate: "35T6383" }, { code: "33", plate: "35T7623" },
            { code: "34", plate: "35T6975" }, { code: "35", plate: "35T5601" },
            { code: "36", plate: "35T7812" }, { code: "37", plate: "35T5071" }
        ];

        // 3. localStorage'dan kayıtlı durumu yükle veya başlangıç verisini oluştur
        const savedState = localStorage.getItem(STORAGE_KEY);
        const initialDuraklarState = savedState ? JSON.parse(savedState) : {
            merkez: { liste: [], ortalama_kalkis: 6200 },
            metro: { liste: [], ortalama_kalkis: 950 },
            suvari: { liste: [], ortalama_kalkis: 40 }
        };

        const mockData = {
          son_guncelleme: "18.09.2023 | 10:00:00 (Test Verisi)",
          duraklar: initialDuraklarState
        };

        // 4. Butonlara olay dinleyicileri ekle
        document.getElementById('add-merkez').addEventListener('click', () => addVehicle('merkez'));
        document.getElementById('remove-merkez').addEventListener('click', () => removeVehicle('merkez'));
        document.getElementById('add-metro').addEventListener('click', () => addVehicle('metro'));
        document.getElementById('remove-metro').addEventListener('click', () => removeVehicle('metro'));
        document.getElementById('add-suvari').addEventListener('click', () => addVehicle('suvari'));
        document.getElementById('remove-suvari').addEventListener('click', () => removeVehicle('suvari'));

        function saveState() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(mockData.duraklar));
        }

        function getTotalVehicleCount() {
            return mockData.duraklar.merkez.liste.length + 
                   mockData.duraklar.metro.liste.length + 
                   mockData.duraklar.suvari.liste.length;
        }

        function addVehicle(durakKey) {
            if (mockData.duraklar[durakKey].liste.length >= 10) {
                alert("Bu durağa daha fazla araç eklenemez (maksimum 10)!");
                return;
            }

            if (getTotalVehicleCount() >= 16) {
                alert("Toplam araç sayısı 16'yı geçemez!");
                return;
            }
            
            // Henüz duraklarda olmayan bir araç bul
            const assignedPlates = [...mockData.duraklar.merkez.liste, ...mockData.duraklar.metro.liste, ...mockData.duraklar.suvari.liste].map(v => v.plate);
            const availableVehicle = allVehicles.find(v => !assignedPlates.includes(v.plate));

            if (availableVehicle) {
                // Rastgele bir bekleme süresi ekle
                const newVehicle = { ...availableVehicle, entry_duration: Math.floor(Math.random() * 10000) };
                mockData.duraklar[durakKey].liste.push(newVehicle);
                saveState(); // Durumu localStorage'a kaydet
                renderData(mockData); // Arayüzü güncelle
            }
        }

        function removeVehicle(durakKey) {
            if (mockData.duraklar[durakKey].liste.length > 0) {
                saveState(); // Durumu localStorage'a kaydet
                mockData.duraklar[durakKey].liste.pop(); // Son aracı sil
                renderData(mockData); // Arayüzü güncelle
            } else {
                alert(`${durakKey} durağında silinecek araç yok.`);
            }
        }

        // 5. Sayfa ilk yüklendiğinde boş veri ile render et
        renderData(mockData); 

      } else {
        // Veritabanı referansındaki veriyi dinle (DEBUG_MODE = false ise çalışır)
        ref.on('value', (snapshot) => {
          const data = snapshot.val();
          if (data && data.duraklar) {
            renderData(data);
          } else {
            console.error("Veri alınamadı veya 'duraklar' anahtarı bulunamadı.");
            duraklarContainer.innerHTML = '<p style="color:red; text-align:center;">Veri alınamadı. Lütfen Python betiğinin çalıştığından emin olun.</p>';
          }
        }, (error) => {
          console.error("Veri okuma hatası: ", error);
          duraklarContainer.innerHTML = '<p style="color:red; text-align:center;">Veri okuma hatası oluştu. Konsolu kontrol edin.</p>';
        });
      }

      // Viewport bilgisi fonksiyonları
      function updateViewportInfo() {
        const width = window.innerWidth;
        const height = window.innerHeight;
        // En/Boy oranını hesapla ve 2 ondalık basamağa yuvarla
        const aspectRatio = (width / height).toFixed(2);
        viewportInfo.textContent = `Viewport: ${width}x${height} | En/Boy Oranı: ${aspectRatio} w/h`;
      }
      
      // Viewport bilgisi div'ine tıklama olayı ekle
      viewportInfo.onclick = function() {
        const textToCopy = this.textContent;
        const tempTextArea = document.createElement('textarea');
        tempTextArea.value = textToCopy;
        document.body.appendChild(tempTextArea);
        tempTextArea.select();
        document.execCommand('copy');
        document.body.removeChild(tempTextArea);
        
        this.textContent = 'Kopyalandı!';
        // Kopyalama mesajı görünür hale getirildi
        this.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
        this.style.color = 'white';

        setTimeout(() => {
            // Mesajı eski haline döndür
            updateViewportInfo();
            this.style.backgroundColor = 'transparent';
            this.style.color = 'rgba(0, 0, 0, 0)';
        }, 1000);
      };

      // Sayfa yüklendiğinde ve pencere yeniden boyutlandırıldığında tüm ayarları yap
      window.addEventListener('load', () => {
          // İlk yüklemede viewport bilgisini güncelle
          updateViewportInfo();
      });

      // Pencere boyutu değiştiğinde viewport bilgisini güncelle
      window.addEventListener('resize', () => {
        updateViewportInfo();
        // Veriyi yeniden render etmek için, mevcut veriyi bir değişkende saklayıp onu kullanabiliriz
        // veya basitçe sayfayı yeniden yükleyebiliriz. Şimdilik yeniden yükleme daha basit.
        location.reload();
      });
    </script>
  </body>
</html>
