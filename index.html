<!DOCTYPE html>
<html lang="tr">
  <head>
    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-4Y5K6S0S87"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-4Y5K6S0S87");
    </script>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes"
    />

    <title>Duraklara Göre Sıralama</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Kode+Mono:wght@400..700&family=Madimi+One&family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Genel ayarlar */
      body {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        height: 100vh;
        width: 100vw;
        background-color: black;
        color: white;
        font-family: "Kode Mono", monospace;
        overflow: hidden;
      }

      /* Tüm içeriği kapsayan container */
      .content {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center; /* Tüm içeriği dikeyde ortala */
        width: 100%;
        height: 100%;
      }

      #main-container {
        display: flex;
        flex-direction: column;
        width: 100%;
        padding: 0 2vw; /* Sağ ve soldan %2'lik güven aralığı bırak */
        box-sizing: border-box; /* Padding'in genişliğe dahil edilmesini sağla */
      }

      /* Güncelleme yazısı ve yükleme simgesi için container */
      .updatetime-container {
        text-align: center;
        font-size: 1.2rem;
        padding-top: 1vh; /* Üstten küçük bir boşluk */
      }

      /* Yükleme Simgesi */
      .loader {
        border: 4px solid #f3f3f3; /* Açık gri */
        border-top: 4px solid #3498db; /* Mavi */
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 2s linear infinite;
        margin: 0 auto;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Durakları içeren container */
      .container {
        display: flex;
        flex-wrap: nowrap;
        width: 100%;
        justify-content: center;
      }

      /* Durak kutuları */
      .durak {
        padding: 1vh 2vw;
        border: 0.2vw solid #ccc;
        border-radius: 2vw;
        text-align: center;
        background-color: #333 !important;
        box-shadow: 0 1vw 1vw rgba(255, 255, 255, 0);
        color: white;
        overflow: hidden; /* Şeritin köşelerden taşan kısımlarını gizle */
        line-height: 1.2;
        /* Varsayılan çerçeve kalınlığı */
        border: 0.2vw solid #ccc;
        transition: border-color 0.5s ease;
        position: relative; /* Şerit için zorunlu */
      }

      .durak {
        width: var(
          --durak-width,
          80vw
        ); /* JS'den gelen veya varsayılan değer */
        font-size: var(
          --durak-font-size,
          4vw
        ); /* JS'den gelen veya varsayılan değer */
      }

      /* Dinamik renk sınıfları */
      .durak.hizli {
        border-color: #00ff00; /* Yeşil */
        border-width: 0.5vw;
      }

      .durak.orta {
        border-color: #ffff00; /* Sarı */
        border-width: 0.5vw;
      }

      .durak.yavas {
        border-color: #ff0000; /* Kırmızı */
        border-width: 0.5vw;
      }

      /* ------------------------------------------- */
      /* --- DİYAGONAL ŞERİT STİLLERİ BAŞLANGIÇ --- */
      /* --- YENİ GÜNCELLEME: DAHA AŞAĞI KONUMLANDIRMA VE KÜÇÜK YAZI BOYUTU --- */
      /* ------------------------------------------- */

      .durak::after {
        position: absolute;
        font-family: "Madimi One", sans-serif; /* Şeridi daha çarpıcı göstermek için font */
        color: white;

        /* YAZI ORTALAMASI */
        display: flex;
        justify-content: center; /* Yatayda ortala */
        align-items: center; /* Dikeyde ortala */

        /* Diyagonal şerit ayarları */
        width: 160%;
        top: 3vw; /* <--- YENİ GÜNCELLEME: Şeridin başlangıç noktasını daha da aşağı kaydırdık. */
        left: -70%;
        padding: 0.5vw 0;
        font-size: clamp(
          9px,
          1.6vw,
          16px
        ); /* <--- YENİ GÜNCELLEME: Genel font boyutu küçültüldü. */
        font-weight: 700;
        line-height: 1.2;
        transform: rotate(-45deg); /* Diyagonal eğim (SOL ÜSTTEN SAĞ ALTA) */
        z-index: 10;
        box-shadow: 0 0 1vw rgba(0, 0, 0, 0.5);
        text-shadow: 1px 1px 2px black;
        pointer-events: none;
      }

      /* En Hızlı Şeridi */
      .durak.hizli::after {
        content: "EN HIZLI";
        background-color: #00cc00; /* Parlak yeşil şerit */
      }

      /* Orta Hızlı Şeridi */
      .durak.orta::after {
        content: "ORTA HIZLI";
        background-color: #ffcc00; /* Parlak sarı şerit */
      }

      /* En Yavaş Şeridi */
      .durak.yavas::after {
        content: "YAVAŞ";
        background-color: #ff3333; /* Parlak kırmızı şerit */
      }

      /* Küçük ekranlar (Dikey mobil) için şerit ayarı optimizasyonu */
      @media (max-width: 600px) {
        .durak::after {
          top: 20px; /* <--- YENİ GÜNCELLEME: Mobilde daha da aşağı (içeri) indirildi. */
          left: -70%;
          font-size: 13px; /* <--- YENİ GÜNCELLEME: Mobildeki font boyutu küçültüldü. */
        }
      }
      /* ------------------------------------------- */
      /* --- DİYAGONAL ŞERİT STİLLERİ BİTİŞ --- */
      /* ------------------------------------------- */

      /* Bilgi Tablosu Stilleri */
      #info-table {
        width: var(--durak-width, 85vw); /* Genişliği duraklarla aynı yapar */
        max-width: 96%; /* Ekranın kenarlarına yapışmasını önle */
        margin: 0 auto;
        border-collapse: collapse;
        font-size: clamp(10px, 2.5vw, 18px); /* Akışkan font boyutu */
        line-height: 1.4;
      }

      /* Satır Renkleri */
      #info-table tr:nth-child(1) {
        color: #c8a2c8;
      } /* Açık Mor */
      #info-table tr:nth-child(2) {
        color: #ffc085;
      } /* Açık Turuncu */
      #info-table tr:nth-child(3) {
        color: #ff8c8c;
      } /* Açık Kırmızı */
      #info-table tr:nth-child(4) {
        color: #87ceeb;
      } /* Açık Mavi */

      /* Yatay düzende tablo genişliğini ayarla */
      @media (min-aspect-ratio: 1.1) {
        #info-table {
          width: 100%;
          max-width: 800px;
        }
      }

      #info-table .info-key {
        text-align: left;
        padding-right: 1em;
        white-space: nowrap;
        font-weight: bold;
      }

      #info-table .info-value {
        text-align: left;
        font-weight: bold;
      }

      /* Araç listesi için tablo stili */
      .vehicle-table {
        width: 100%;
        border-collapse: collapse; /* Kenarlıkları birleştir */
        margin-top: 0.5rem;
        font-size: inherit; /* Yazı tipi boyutunu parent elementten (durak) al */
      }

      .vehicle-table td {
        white-space: nowrap; /* Metnin satır atlamasını engelle */
        overflow: hidden; /* Taşmayı gizle */
        text-overflow: ellipsis; /* Taşma durumunda üç nokta göster */
        padding: 0 0.2vw;
      }

      .vehicle-table .right-align {
        text-align: right;
      }

      /* Ayırıcı Çizgi Stilleri */
      .separator-line {
        border: none;
        border-top: 1px solid #ccc; /* Ana ayırıcı çizgi rengi */
        width: 100%;
        margin: 0.5rem 0;
      }

      .sub-separator-line {
        border: none;
        border-top: 1px solid #ccc; /* Alt ayırıcı çizgi rengi (ana çizgiyle aynı) */
        width: 100%;
        margin: 0.3rem 0;
      }

      /* Viewport Bilgi Kutusu */
      #viewport-info {
        position: fixed;
        top: 10px;
        left: 10px;
        padding: 8px 12px;
        background-color: transparent; /* Başlangıçta şeffaf */
        color: transparent; /* Başlangıçta şeffaf */
        font-family: "Kode Mono", monospace;
        font-size: 0.8rem;
        border-radius: 5px;
        cursor: pointer;
        z-index: 1000;
        user-select: none;
        transition: color 0.3s ease, background-color 0.3s ease;
      }

      /* Tıklanabilir olduğunda rengi biraz görünür yapma */
      #viewport-info:hover {
        background-color: rgba(0, 0, 0, 0.6);
        color: white;
      }

      /* Debug Butonları için Stiller */
      #debug-controls {
        position: fixed;
        bottom: 10px;
        right: 10px;
        background-color: rgba(0, 0, 0, 0.7);
        padding: 10px;
        border-radius: 8px;
        z-index: 1001;
        display: flex;
        flex-direction: column;
        gap: 8px;
        font-size: 0.9rem;
      }
      #debug-controls div {
        display: flex;
        align-items: center;
        gap: 5px;
      }
      #debug-controls button {
        width: 25px;
        height: 25px;
        font-weight: bold;
        cursor: pointer;
      }

      .metal-effect {
        font-weight: bold;
        color: #c0c0c0; /* Gümüş rengi */
        background: linear-gradient(
          90deg,
          #c0c0c0 48%,
          #ffffff 50%,
          #c0c0c0 52%
        );
        background-size: 300% 100%;
        background-position: 150% 0;
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: metal-shine 3s linear infinite;
        animation: metal-shine 5s linear infinite;
        filter: drop-shadow(0 0 2px rgba(255, 255, 255, 0.3));
      }

      @keyframes metal-shine {
        0% {
          background-position: 150% 0; /* Başlangıç pozisyonu (sağda) */
        }
        100% {
          background-position: -150% 0; /* Bitiş pozisyonu (solda) */
        }
      }

      /* Ses kontrol ikonu */
      .speaker-icon {
        position: absolute;
        top: 1vh;
        right: 2vw;
        font-size: clamp(14px, 3vw, 24px);
        cursor: pointer;
        user-select: none; /* İkonun seçilmesini engelle */
      }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  </head>
  <body>
    <div id="debug-controls" style="display: none">
      <div>
        <span>Merkez:</span>
        <button id="add-merkez">+</button>
        <button id="add-closed-merkez">K+</button>
        <button id="remove-merkez">-</button>
      </div>
      <div>
        <span>Metro:</span>
        <button id="add-metro">+</button>
        <button id="add-closed-metro">K+</button>
        <button id="remove-metro">-</button>
      </div>
      <div>
        <span>Süvari:</span>
        <button id="add-suvari">+</button>
        <button id="add-closed-suvari">K+</button>
        <button id="remove-suvari">-</button>
      </div>
    </div>
    <div id="viewport-info"></div>
    <div class="content">
      <div
        id="debug-warning"
        style="
          color: yellow;
          font-weight: bold;
          display: none;
          margin-bottom: 1rem;
        "
      >
        DİKKAT: DEBUG MODU AKTİF
      </div>
      <div id="main-container">
        <div class="updatetime-container">
          <!-- Yükleniyor simgesi -->
          <div id="loader" class="loader"></div>
          <!-- Yeni Bilgi Tablosu -->
          <table id="info-table" style="display: none">
            <tbody>
              <tr>
                <td class="info-key">Son Güncelleme:</td>
                <td id="info-updatetime" class="info-value"></td>
              </tr>
              <tr>
                <td class="info-key">Araç Durumları:</td>
                <td id="info-gps" class="info-value"></td>
              </tr>
              <tr>
                <td class="info-key">Duyuru:</td>
                <td id="info-closed-vehicle" class="info-value"></td>
              </tr>
              <tr>
                <td class="info-key">Hava Durumu:</td>
                <td id="info-weather" class="info-value"></td>
              </tr>
            </tbody>
          </table>
        </div>
        <div id="duraklar-container" class="container"></div>
      </div>
    </div>
    <script>
      // --- Cihaz Engelleme Kontrolü ---
      // Bu fonksiyon, sayfanın geri kalanı çalışmadan önce çağrılır.
      (function () {
        // Engellenecek cihaz modellerini bu diziye ekleyebilirsiniz.
        const blockedModels = [];
        const userAgent = navigator.userAgent;

        // User agent'ın engellenen modellerden herhangi birini içerip içermediğini kontrol et
        const isBlocked = blockedModels.some((model) =>
          userAgent.includes(model)
        );

        if (isBlocked) {
          const blockedModelFound = blockedModels.find((model) =>
            userAgent.includes(model)
          );
          // Sayfa içeriğini temizle ve uyarı mesajı göster
          document.documentElement.innerHTML = `
            <head><title>Desteklenmiyor</title><meta name="viewport" content="width=device-width, initial-scale=1.0"></head>
            <body style="background-color: black; color: white; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; font-family: 'Kode Mono', monospace; text-align: center; padding: 20px;">
            </body>`;
          throw new Error("Desteklenmeyen cihaz modeli: " + blockedModelFound); // Script'in geri kalanının çalışmasını engelle
        }
      })();

      // Firebase yapılandırma bilgileri
      const firebaseConfig = {
        apiKey: "AIzaSyCTTDvLsIY3ZS8zNP77lxLG0SdoOke2vLk",
        authDomain: "kptakip.firebaseapp.com",
        databaseURL:
          "https://kptakip-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "kptakip",
        storageBucket: "kptakip.firebasestorage.app",
        messagingSenderId: "401633293269",
        appId: "1:401633293269:web:8386edc126aafe1929435c",
      };
      // Firebase uygulamasını başlat
      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();
      const ref = database.ref("taksi_verileri");
      // Elemanları seç
      const mainContainer = document.getElementById("main-container");
      const duraklarContainer = document.getElementById("duraklar-container");
      const loaderElement = document.getElementById("loader");
      const viewportInfo = document.getElementById("viewport-info");
      const infoTable = document.getElementById("info-table");
      const infoUpdateTime = document.getElementById("info-updatetime");
      const infoGps = document.getElementById("info-gps");
      const infoClosedVehicle = document.getElementById("info-closed-vehicle");
      const infoWeather = document.getElementById("info-weather");

      // En son yüklenen veriyi tutmak için değişken
      let latestData = null;
      // Önceki araç sayılarını tutmak için değişken
      let previousVehicleCounts = {};
      // Durakların ses durumunu tutmak için değişken
      let stationMuteStatus = {
        merkez: false, // false = ses açık, true = ses kapalı
        metro: false,
        suvari: false,
      };
      // İlk kullanıcı etkileşimini takip etmek için bayrak
      let firstInteraction = false;

      /**
       * Saniye cinsinden verilen süreyi "Xgn Ysa Zdk Psn" formatına dönüştürür.
       * @param {number} totalSeconds - Toplam saniye süresi.
       * @returns {string} Formatlanmış süre metni.
       */
      function formatDuration(totalSeconds) {
        if (totalSeconds < 0) {
          totalSeconds = 0;
        }

        const days = Math.floor(totalSeconds / (24 * 60 * 60));
        const hours = Math.floor((totalSeconds % (24 * 60 * 60)) / (60 * 60));
        const minutes = Math.floor((totalSeconds % (60 * 60)) / 60);
        const seconds = totalSeconds % 60;

        const parts = [];
        if (days > 0) {
          parts.push(`${days}gn`);
        }
        if (hours > 0) {
          parts.push(`${hours}sa`);
        }
        if (minutes > 0) {
          parts.push(`${minutes}dk`);
        }
        parts.push(`${seconds}sn`);

        return parts.join(" ");
      }

      /**
       * Zaman birimini formatlar. Eğer değer 0 ise ve forceDisplayZero true değilse boş string döndürür.
       * Tek haneli değerler için bir boşluk ekler ve sağa yaslar.
       * @param {number} value - Zaman biriminin değeri (gün, saat, dakika, saniye).
       * @param {string} unit - Zaman biriminin kısaltması (örn: 'gn', 'sa', 'dk', 'sn').
       * @param {boolean} [forceDisplayZero=false] - Değer 0 olsa bile gösterilmesini zorlar.
       * @param {string} [padChar='&nbsp;'] - Tek haneli değerler için kullanılacak dolgu karakteri.
       * @returns {string} Doldurulmuş ve hizalanmış metin veya boş string.
       */
      function padTimeDisplay(
        value,
        unit,
        forceDisplayZero = false,
        padChar = "&nbsp;"
      ) {
        if (value === 0 && !forceDisplayZero) {
          return "";
        }
        // Tek haneli değerler için bir boşluk ekle
        if (value < 10 && value >= 0) {
          return `${padChar}${value}${unit}`;
        }
        return `${value}${unit}`;
      }

      /**
       * Hava durumu kodunu okunabilir bir metne çevirir.
       * @param {number} code - Open-Meteo'dan gelen hava durumu kodu.
       * @returns {string} Hava durumu açıklaması.
       */
      function getWeatherDescription(code) {
        const descriptions = {
          0: "Açık",
          1: "Parçalı Bulutlu",
          2: "Parçalı Bulutlu",
          3: "Bulutlu",
          45: "Sisli",
          48: "Sisli",
          51: "Çiselemeli",
          53: "Çiselemeli",
          55: "Çiselemeli",
          56: "Dondurucu Çiseleme",
          57: "Dondurucu Çiseleme",
          61: "Yağmurlu",
          63: "Yağmurlu",
          65: "Şiddetli Yağmurlu",
          66: "Dondurucu Yağmur",
          67: "Dondurucu Yağmur",
          71: "Karlı",
          73: "Karlı",
          75: "Yoğun Karlı",
          77: "Kar Taneleri",
          80: "Sağanak Yağışlı",
          81: "Sağanak Yağışlı",
          82: "Şiddetli Sağanak",
          95: "Gök Gürültülü",
          96: "Hafif Dolu",
          85: "Kar Sağanağı",
          86: "Yoğun Kar Sağanağı",
          99: "Şiddetli Dolu",
        };
        return descriptions[code] || "Bilinmiyor";
      }

      /**
       * Bornova, İzmir için hava durumu verilerini çeker ve gösterir.
       */
      async function fetchWeather() {
        try {
          const response = await fetch(
            "https://api.open-meteo.com/v1/forecast?latitude=38.46&longitude=27.22&daily=weathercode&timezone=Europe/Istanbul"
          );
          const data = await response.json();

          const today = data.daily;

          // Yağmur, kar, dolu ve fırtına gibi araç yıkamaya uygun olmayan tüm kötü hava kodları
          const badWeatherCodes = [
            51, 53, 55, 61, 63, 65, 66, 67, 71, 73, 75, 77, 80, 81, 82, 85, 86,
            95, 96, 99,
          ];
          const tomorrowCode = today.weathercode[1];
          const weatherRow = infoWeather.parentElement; // <tr> elementini al

          if (badWeatherCodes.includes(tomorrowCode)) {
            infoWeather.textContent = "🌧️☂️Yakında yağış var, araç yıkanmaz."; // Renk CSS'den gelecek
            // Yağış varsa, satır rengini camgöbeği yap ama animasyon ekleme
            weatherRow.style.color = "#00ffff";
          } else {
            infoWeather.textContent = "Yakında yağış yok, araç yıkanır."; // Renk CSS'den gelecek
            // Yağış yoksa, satır rengini varsayılana döndür
            weatherRow.style.color = "";
          }
        } catch (error) {
          console.error("Hava durumu verisi alınamadı:", error);
          infoWeather.textContent = "Bilgi alınamadı.";
        }
      }

      /**
       * Verilen URL'deki ses dosyasını çalar.
       * @param {string} url - Çalınacak ses dosyasının URL'si.
       */
      function playAudio(url) {
        if (!firstInteraction) {
          // Kullanıcı etkileşimi olmadan ses çalınamaz, bu yüzden işlemi atla.
          return;
        }
        const audio = new Audio(url);
        audio.play().catch(error => {
          // Oynatma hatası (genellikle kullanıcı etkileşimi olmadan engellendiğinde)
          // Bu hatayı konsolda göstermek genellikle gereksizdir çünkü beklenen bir durumdur.
          // console.error("Ses çalma hatası:", error);
        });
      }

      function renderData(data) {
        // En son veriyi global olarak sakla
        latestData = data;

        // Yükleme simgesini gizle ve güncelleme metinlerini göster
        loaderElement.style.display = "none";
        infoTable.style.display = "table";

        // Güncelleme zamanını ve GPS bilgi metnini ayarla
        infoUpdateTime.textContent = data.son_guncelleme;
        infoGps.textContent = "Tüm araçlardaki sorunlar düzeltildi."; // Metin zaten doğru, teyit edildi.
        infoClosedVehicle.textContent =
          "Kırmızı renkteki araçlar kapalıdır, sıraya dahil değildir.";

        // Hava durumu verisini sadece ana veri yüklendikten sonra çek ve göster
        fetchWeather();

        // Dinamik font büyüklüğü sınıfları için stilleri dinamik olarak ekle
        // "Araç Durumları" satırına metalik parlama efekti ekle
        infoGps.parentElement.classList.add("metal-effect");

        // Bu, media query'lerdeki .font-size-large gibi sınıfların yerini alır
        const contentDiv = document.querySelector(".content");
        const aspectRatio = window.innerWidth / window.innerHeight;
        // Durak bilgilerini işle
        duraklarContainer.innerHTML = "";
        const duraklar = data.duraklar;
        const durak_names = {
          suvari: "Süvari",
          merkez: "Merkez",
          metro: "Metro",
        };

        // Durakları belirli bir sırada oluştur
        const orderedDuraks = ["merkez", "metro", "suvari"];

        // Ortalama kalkış sürelerini topla ve sırala
        const averageTimes = orderedDuraks
          .map((key) => ({
            key,
            time: duraklar[key].ortalama_kalkis,
          }))
          .sort((a, b) => a.time - b.time);

        // En hızlı, orta ve en yavaş durakları belirle
        const fastest = averageTimes[0].key;
        const middle = averageTimes[1].key;
        const slowest = averageTimes[2].key;

        // --- YENİ ORANTISAL YÜKSEKLİK HESAPLAMA MANTIĞI ---
        // 1. Tüm duraklardaki araç sayılarını al
        const vehicleCounts = {
          merkez: duraklar.merkez.liste ? duraklar.merkez.liste.length : 0,
          metro: duraklar.metro.liste ? duraklar.metro.liste.length : 0,
          suvari: duraklar.suvari.liste ? duraklar.suvari.liste.length : 0,
        };
        const totalVehicles =
          vehicleCounts.merkez + vehicleCounts.metro + vehicleCounts.suvari;

        // --- SESLİ BİLDİRİM İÇİN DEĞİŞİKLİK KONTROLÜ ---
        const newVehicleCounts = {};
        orderedDuraks.forEach((key) => {
          const aracSayisi = data.duraklar[key].liste
            ? data.duraklar[key].liste.filter((arac) => !arac.is_closed).length
            : 0;
          newVehicleCounts[key] = aracSayisi;

          // Eğer bu durağın önceki sayısı varsa ve değişmişse sesli bildirim yap
          if (
            previousVehicleCounts[key] !== undefined &&
            previousVehicleCounts[key] !== aracSayisi &&
            !stationMuteStatus[key] // Eğer ses kapalı değilse
          ) {
            // Çalınacak ses dosyasının adını oluştur (örn: merkez2.opus, suvari0.opus)
            const audioFileName = `${key}${aracSayisi}.opus`;
            // GitHub raw content URL'sini oluştur
            const audioUrl = `https://raw.githubusercontent.com/tektekno/deneme_yeni/master/voices/${audioFileName}`;

            // Render döngüsünü bloklamamak için konuşmayı kısa bir gecikmeyle yap
            // Bu, özellikle WebView ve mobil cihazlarda performansı artırır.
            setTimeout(() => playAudio(audioUrl), 100);
          }
        });

        // Bir sonraki kontrol için mevcut sayıları kaydet
        previousVehicleCounts = newVehicleCounts;

        // Her bir durak için ayrı ayrı hizalama uzunluğunu belirle
        orderedDuraks.forEach((key) => {
          if (duraklar.hasOwnProperty(key)) {
            const durak = duraklar[key];
            const durakDiv = document.createElement("div");
            durakDiv.className = "durak";

            // Hız durumuna göre sınıf ekle
            if (key === fastest) {
              durakDiv.classList.add("hizli");
            } else if (key === middle) {
              durakDiv.classList.add("orta");
            } else if (key === slowest) {
              durakDiv.classList.add("yavas");
            }

            let htmlContent = "";

            const aracListesi = durak.liste || [];
            const activeVehicles = aracListesi.filter(
              (arac) => !arac.is_closed
            );
            const closedVehicles = aracListesi.filter((arac) => arac.is_closed);
            const aracSayisi = activeVehicles.length; // Sadece aktif araçları say

            // Başlık satırı
            const speakerIcon = stationMuteStatus[key] ? "🔇" : "🔊";
            htmlContent += `<span class="speaker-icon" data-durak-key="${key}">${speakerIcon}</span>`;

            htmlContent += `${durak_names[key]} (${aracSayisi})<br>`;

            // Ortalama kalkış satırı
            const formattedAverageDeparture = formatDuration(
              durak.ortalama_kalkis
            );
            htmlContent += `Ortalama Kalkış: ${formattedAverageDeparture}<br>`;

            // --- YENİ STİL MANTIĞI ---
            // Genel container stilleri sadece bir kez ayarlanır
            if (
              !duraklarContainer.style.flexDirection ||
              (!duraklarContainer.style.flexDirection.includes("column") &&
                aspectRatio < 1.1)
            ) {
              // Dikey ve kareye yakın düzenler
              if (aspectRatio < 1.1) {
                duraklarContainer.style.flexDirection = "column";
                duraklarContainer.style.alignItems = "center";
                duraklarContainer.style.paddingTop = "2vh";
                duraklarContainer.style.gap = "2.4vh"; // 18px / 754px
              } else {
                // Yatay düzenler
                duraklarContainer.style.flexDirection = "row";
                duraklarContainer.style.justifyContent = "center";
                duraklarContainer.style.marginTop = "2%";
                duraklarContainer.style.alignItems = "flex-start"; // Elemanların uzamasını engelle, yukarı hizala.
                duraklarContainer.style.gap = "2vw";
              }
            }

            // --- AKIŞKAN FORMÜL İLE STİL HESAPLAMA ---

            // 1. Akışkan Font Boyutu: Ekran daraldıkça (aspectRatio küçüldükçe) font büyür.
            const fluidFontSize = `clamp(1.4vw, ${2 / aspectRatio}vw, 4.5vw)`;

            // 2. Akışkan Genişlik: Ekran daraldıkça genişlik artar.
            const fluidWidth = `clamp(30vw, ${50 / aspectRatio}vw, 85vw)`;

            // 3. Hesaplanan değerleri CSS değişkenleri olarak ata
            durakDiv.style.setProperty("--durak-font-size", fluidFontSize);
            durakDiv.style.setProperty("--durak-width", fluidWidth);

            // Bilgi tablosunun genişliğini de duraklarla aynı yapmak için
            document.documentElement.style.setProperty(
              "--durak-width",
              fluidWidth
            );

            // 4. Dikey/Yatay düzene göre flex-grow ve height ayarla
            if (aspectRatio < 1.1) {
              // Dikey Düzen
              durakDiv.style.height = "auto";
              let flexGrowValue = 1;
              if (totalVehicles > 0) {
                flexGrowValue = 1 + (vehicleCounts[key] / totalVehicles) * 10;
              }
              durakDiv.style.flexGrow = flexGrowValue.toFixed(2);
            } else {
              // Yatay Düzen
              // Yatayda yükseklik araç sayısıyla orantılı olsun.
              const baseHeightVh = 15; // Başlık vb. için temel yükseklik.
              const heightPerVehicleVh = 3; // Her araç satırı için ek yükseklik.
              const totalHeight =
                baseHeightVh + aracSayisi * heightPerVehicleVh;

              durakDiv.style.height = "auto"; // Yüksekliğin içeriğe göre doğal olarak büyümesine izin ver.
              durakDiv.style.minHeight = `${totalHeight}vh`; // Ancak en azından hesaplanan kadar yer kaplamasını sağla.
              durakDiv.style.maxHeight = "80vh"; // Ekranı taşmasını önlemek için maksimum yükseklik.
              durakDiv.style.flexGrow = "0"; // Yatayda esnemesin
            }

            // Ayırıcı çizgi
            htmlContent += `<hr class="separator-line">`;

            // Araç listesi
            if (aracListesi.length > 0) {
              htmlContent += '<table class="vehicle-table"><tbody>';

              // Tüm araçlar için (aktif ve kapalı) hangi zaman birimlerinin gösterileceğini belirle
              const showDays = aracListesi.some(
                (a) => a.entry_duration >= 86400
              );
              const showHours = aracListesi.some(
                (a) => a.entry_duration >= 3600
              );
              const showMinutes = aracListesi.some(
                (a) => a.entry_duration >= 60
              );

              // 1. Kapalı araçları render et
              closedVehicles.forEach((arac) => {
                const rowStyle = 'style="color: #FF4C4C;"'; // Her zaman kırmızı
                const totalSeconds = arac.entry_duration;
                const days = Math.floor(totalSeconds / (24 * 60 * 60));
                const hours = Math.floor(
                  (totalSeconds % (24 * 60 * 60)) / (60 * 60)
                );
                const minutes = Math.floor((totalSeconds % (60 * 60)) / 60);
                const seconds = totalSeconds % 60;

                htmlContent += `<tr ${rowStyle}>`;
                htmlContent += `<td>K)</td>`; // Ön ek "K)"
                htmlContent += `<td>${arac.code}</td>`;
                htmlContent += `<td>${arac.plate}</td>`;

                // Süre gösterimi (aktif araçlarla aynı formatta)
                if (showDays && days > 0) {
                  htmlContent += `<td class="right-align">${padTimeDisplay(
                    days,
                    "gn"
                  )}</td>`;
                }
                if (showHours) {
                  htmlContent += `<td class="right-align">${padTimeDisplay(
                    hours,
                    "sa"
                  )}</td>`;
                  htmlContent += `<td class="right-align">${padTimeDisplay(
                    minutes,
                    "dk"
                  )}</td>`;
                  htmlContent += `<td class="right-align">${padTimeDisplay(
                    seconds,
                    "sn",
                    true
                  )}</td>`;
                } else if (showMinutes) {
                  htmlContent += `<td class="right-align">${padTimeDisplay(
                    minutes,
                    "dk"
                  )}</td>`;
                  htmlContent += `<td class="right-align">${padTimeDisplay(
                    seconds,
                    "sn",
                    true
                  )}</td>`;
                } else {
                  htmlContent += `<td class="right-align">${padTimeDisplay(
                    seconds,
                    "sn",
                    true
                  )}</td>`;
                }

                htmlContent += `</tr>`;
              });

              // Kapalı ve aktif araçlar arasında ayırıcı
              if (closedVehicles.length > 0 && activeVehicles.length > 0) {
                htmlContent += `<tr><td colspan="7"><hr class="sub-separator-line"></td></tr>`;
              }

              // 2. Aktif araçları render et
              activeVehicles.forEach((arac, index) => {
                const totalSeconds = arac.entry_duration;
                const days = Math.floor(totalSeconds / (24 * 60 * 60));
                const hours = Math.floor(
                  (totalSeconds % (24 * 60 * 60)) / (60 * 60)
                );
                const minutes = Math.floor((totalSeconds % (60 * 60)) / 60);
                const seconds = totalSeconds % 60;

                // Gizli mod aktifse kod ve plaka gösterimini değiştir
                const displayCode = currentHiddenMode ? "**" : arac.code;
                const displayPlate =
                  currentHiddenMode && arac.plate.includes("T")
                    ? arac.plate.substring(0, arac.plate.indexOf("T") + 1) +
                      "****"
                    : arac.plate;

                htmlContent += `<tr>`;
                htmlContent += `<td>${index + 1})</td>`; // Numaralı ön ek
                htmlContent += `<td>${displayCode}</td>`;
                htmlContent += `<td>${displayPlate}</td>`;

                if (showDays && days > 0) {
                  htmlContent += `<td class="right-align">${padTimeDisplay(
                    days,
                    "gn"
                  )}</td>`;
                }
                if (showHours) {
                  htmlContent += `<td class="right-align">${padTimeDisplay(
                    hours,
                    "sa"
                  )}</td>`;
                  htmlContent += `<td class="right-align">${padTimeDisplay(
                    minutes,
                    "dk"
                  )}</td>`;
                  htmlContent += `<td class="right-align">${padTimeDisplay(
                    seconds,
                    "sn",
                    true
                  )}</td>`;
                } else if (showMinutes) {
                  htmlContent += `<td class="right-align">${padTimeDisplay(
                    minutes,
                    "dk"
                  )}</td>`;
                  htmlContent += `<td class="right-align">${padTimeDisplay(
                    seconds,
                    "sn",
                    true
                  )}</td>`;
                } else {
                  htmlContent += `<td class="right-align">${padTimeDisplay(
                    seconds,
                    "sn",
                    true
                  )}</td>`;
                }

                htmlContent += `</tr>`;
              });

              htmlContent += "</tbody></table>";
            } else {
              htmlContent += "Boş"; // Hiç araç yoksa
            }

            // YENİ: Sadece kapalı araç varsa, altına çizgi ve "Boş" yazısı ekle
            if (closedVehicles.length > 0 && activeVehicles.length === 0) {
              htmlContent += `<hr class="sub-separator-line">`;
              htmlContent += "Boş";
            }

            durakDiv.innerHTML = htmlContent;
            duraklarContainer.appendChild(durakDiv);
          }
        });
      }

      // --- DEBUG MODU ---
      // Test verilerini kullanmak için `true`, gerçek zamanlı Firebase verilerini kullanmak için `false` yapın.
      const DEBUG_MODE = false;

      // --- GİZLİ MOD AYARLARI ---

      // Zamanlayıcıyı aktif etmek için `true`, manuel kontrol için `false` yapın.
      const HIDDEN_MODE_TIMER = false;

      // Zamanlayıcı kapalıyken (HIDDEN_MODE_TIMER = false) gizli modu manuel açıp kapatmak için bu ayarı kullanın.
      const HIDDEN_MODE_MANUAL = false;

      // Zamanlayıcı ayarları (Sadece HIDDEN_MODE_TIMER = true ise geçerlidir)
      const HIDDEN_MODE_START_HOUR = 16;
      const HIDDEN_MODE_START_MINUTE = 0;
      const HIDDEN_MODE_END_HOUR = 5;
      const HIDDEN_MODE_END_MINUTE = 30;

      // --- GİZLİ MOD KONTROL MANTIĞI ---
      function isHiddenModeActive() {
        if (!HIDDEN_MODE_TIMER) {
          return HIDDEN_MODE_MANUAL;
        }

        const now = new Date();
        // UTC saatini alıp üzerine 3 saat ekleyerek Türkiye saatini buluyoruz.
        // Bu metod, tarayıcı saat dilimi ayarından bağımsız olarak UTC+3 saatini hesaplar.
        const turkeyHour = (now.getUTCHours() + 3) % 24;
        const turkeyMinute = now.getUTCMinutes();

        // Saat başlangıç saatinden sonra mı? (Başlangıç dakikası dahildir: >=)
        const isAfterStart =
          turkeyHour > HIDDEN_MODE_START_HOUR ||
          (turkeyHour === HIDDEN_MODE_START_HOUR &&
            turkeyMinute >= HIDDEN_MODE_START_MINUTE);

        // Saat bitiş saatinden önce mi? (Bitiş dakikası dahil değildir: <)
        // DÜZELTME: Gizli modun bitiş saatinde (örn. 05:30) kapanması için minute kontrolünü '<' yaptık.
        const isBeforeEnd =
          turkeyHour < HIDDEN_MODE_END_HOUR ||
          (turkeyHour === HIDDEN_MODE_END_HOUR &&
            turkeyMinute < HIDDEN_MODE_END_MINUTE);

        // Gece yarısını geçen bir aralık mı kontrolü (örn: 16:00 - 05:30)
        if (HIDDEN_MODE_START_HOUR > HIDDEN_MODE_END_HOUR) {
          // Ya başlangıçtan sonra (aynı gün) YA DA bitişten önce (ertesi gün)
          return isAfterStart || isBeforeEnd;
        }
        // Aynı gün içindeki aralık kontrolü (örn: 09:00 - 17:00)
        else {
          // Hem başlangıçtan sonra HEM DE bitişten önce olmalı
          return isAfterStart && isBeforeEnd;
        }
      }

      // Başlangıçta gizli mod durumunu hesapla ve sakla
      let currentHiddenMode = isHiddenModeActive();

      /**
       * Gizli mod durumunu 5 saniyede bir kontrol eder ve arayüzü günceller.
       */
      function checkHiddenModeAndRefresh() {
        const newHiddenMode = isHiddenModeActive();

        // Eğer gizli mod durumu değiştiyse VEYA DEBUG modunda isek (mock data'yı güncellemek için)
        if (newHiddenMode !== currentHiddenMode || DEBUG_MODE) {
          currentHiddenMode = newHiddenMode;
          // Yeni durumla birlikte arayüzü yeniden çiz
          if (latestData) {
            renderData(latestData);
          } else if (DEBUG_MODE) {
            // DEBUG modunda mockData'yı tekrar render et
            // MockData'nın güncel HiddenMode ile çalışmasını sağla
            renderData(mockData);
          }
        }
      }

      // Her 5 saniyede bir gizli mod durumunu kontrol et
      setInterval(checkHiddenModeAndRefresh, 5000);

      if (DEBUG_MODE) {
        // --- DEBUG MODU İÇİN KONTROL VE VERİ YAPISI ---

        // 1. Butonları ve kontrol panelini görünür yap
        const debugControls = document.getElementById("debug-controls");
        const STORAGE_KEY = "debugVehicleState";
        debugControls.style.display = "flex";
        document.getElementById("debug-warning").style.display = "block";

        // Viewport bilgisini görünür yap
        const viewportInfoDiv = document.getElementById("viewport-info");
        viewportInfoDiv.style.backgroundColor = "rgba(0, 0, 0, 0.6)";
        viewportInfoDiv.style.color = "white";

        // 2. Tüm olası araçları içeren bir havuz oluştur
        const allVehicles = [
          { code: "21", plate: "35T7575" },
          { code: "22", plate: "35T5702" },
          { code: "23", plate: "35T6619" },
          { code: "24", plate: "35T7734" },
          { code: "25", plate: "35T5595" },
          { code: "26", plate: "35T6913" },
          { code: "27", plate: "35T6581" },
          { code: "28", plate: "35T6272" },
          { code: "29", plate: "35T5023" },
          { code: "30", plate: "35T7274" },
          { code: "32", plate: "35T6383" },
          { code: "33", plate: "35T7623" },
          { code: "34", plate: "35T6975" },
          { code: "35", plate: "35T5601" },
          { code: "36", plate: "35T7812" },
          { code: "37", plate: "35T5071" },
        ];

        // 3. localStorage'dan kayıtlı durumu yükle veya başlangıç verisini oluştur
        const savedState = localStorage.getItem(STORAGE_KEY);
        const initialDuraklarState = savedState
          ? JSON.parse(savedState)
          : {
              merkez: { liste: [], ortalama_kalkis: 6200 },
              metro: { liste: [], ortalama_kalkis: 950 },
              suvari: {
                liste: [{ code: "27", plate: "35T6581", entry_duration: 40 }],
                ortalama_kalkis: 40,
              },
            };

        const mockData = {
          son_guncelleme: "18.09.2023 | 10:00:00 (Test Verisi)",
          duraklar: initialDuraklarState,
        };

        // 4. Butonlara olay dinleyicileri ekle
        document
          .getElementById("add-merkez")
          .addEventListener("click", () => addVehicle("merkez"));
        document
          .getElementById("add-closed-merkez")
          .addEventListener("click", () => addVehicle("merkez", true));
        document
          .getElementById("remove-merkez")
          .addEventListener("click", () => removeVehicle("merkez"));

        document
          .getElementById("add-metro")
          .addEventListener("click", () => addVehicle("metro"));
        document
          .getElementById("add-closed-metro")
          .addEventListener("click", () => addVehicle("metro", true));
        document
          .getElementById("remove-metro")
          .addEventListener("click", () => removeVehicle("metro"));

        document
          .getElementById("add-suvari")
          .addEventListener("click", () => addVehicle("suvari"));
        document
          .getElementById("add-closed-suvari")
          .addEventListener("click", () => addVehicle("suvari", true));
        document
          .getElementById("remove-suvari")
          .addEventListener("click", () => removeVehicle("suvari"));

        function saveState() {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(mockData.duraklar));
        }

        function getTotalVehicleCount() {
          return (
            mockData.duraklar.merkez.liste.length +
            mockData.duraklar.metro.liste.length +
            mockData.duraklar.suvari.liste.length
          );
        }

        function addVehicle(durakKey, isClosed = false) {
          if (mockData.duraklar[durakKey].liste.length >= 10) {
            // Not: alert() yerine daha iyi bir yöntem kullanılmalıdır, ancak debug için kabul edilebilir.
            console.error("Bu durağa daha fazla araç eklenemez (maksimum 10)!");
            return;
          }

          if (getTotalVehicleCount() >= 16) {
            console.error("Toplam araç sayısı 16'yı geçemez!");
            return;
          }

          // Henüz duraklarda olmayan bir araç bul
          const assignedPlates = [
            ...mockData.duraklar.merkez.liste,
            ...mockData.duraklar.metro.liste,
            ...mockData.duraklar.suvari.liste,
          ].map((v) => v.plate);
          const availableVehicle = allVehicles.find(
            (v) => !assignedPlates.includes(v.plate)
          );

          if (availableVehicle) {
            const newVehicle = {
              ...availableVehicle,
              entry_duration: Math.floor(Math.random() * 10000),
              is_closed: isClosed, // Kapalı olup olmadığını ayarla
            };
            mockData.duraklar[durakKey].liste.push(newVehicle);
            saveState(); // Durumu localStorage'a kaydet
            renderData(mockData); // Arayüzü güncelle
          }
        }

        function removeVehicle(durakKey) {
          if (mockData.duraklar[durakKey].liste.length > 0) {
            mockData.duraklar[durakKey].liste.pop(); // Son aracı sil
            saveState(); // Durumu localStorage'a kaydet
            renderData(mockData); // Arayüzü güncelle
          } else {
            console.error(`${durakKey} durağında silinecek araç yok.`);
          }
        }

        // 5. Sayfa ilk yüklendiğinde mock veriyi render et
        renderData(mockData);
      } else {
        // Veritabanı referansındaki veriyi dinle (DEBUG_MODE = false ise çalışır)
        ref.on(
          "value",
          (snapshot) => {
            const data = snapshot.val();
            if (data && data.duraklar) {
              renderData(data);
            } else {
              console.error(
                "Veri alınamadı veya 'duraklar' anahtarı bulunamadı."
              );
              duraklarContainer.innerHTML =
                '<p style="color:red; text-align:center;">Veri alınamadı. Lütfen Python betiğinin çalıştığından emin olun.</p>';
            }
          },
          (error) => {
            console.error("Veri okuma hatası: ", error);
            duraklarContainer.innerHTML =
              '<p style="color:red; text-align:center;">Veri okuma hatası oluştu. Konsolu kontrol edin.</p>';
          }
        );
      }

      // Viewport bilgisi fonksiyonları
      function updateViewportInfo() {
        const width = window.innerWidth;
        const height = window.innerHeight;
        // En/Boy oranını hesapla ve 2 ondalık basamağa yuvarla
        const aspectRatio = (width / height).toFixed(2);
        viewportInfo.textContent = `Viewport: ${width}x${height} | En/Boy Oranı: ${aspectRatio} w/h | Hidden Mode: ${
          currentHiddenMode ? "ON" : "OFF"
        }`;
      }

      // Viewport bilgisi div'ine tıklama olayı ekle
      viewportInfo.onclick = function () {
        const textToCopy = this.textContent;
        const tempTextArea = document.createElement("textarea");
        tempTextArea.value = textToCopy;
        document.body.appendChild(tempTextArea);
        tempTextArea.select();
        document.execCommand("copy");
        document.body.removeChild(tempTextArea);

        this.textContent = "Kopyalandı!";
        // Kopyalama mesajı görünür hale getirildi
        this.style.backgroundColor = "rgba(255, 255, 255, 0.2)";
        this.style.color = "white";

        setTimeout(() => {
          // Mesajı eski haline döndür
          updateViewportInfo();
          this.style.backgroundColor = "transparent";
          this.style.color = "rgba(0, 0, 0, 0)";
        }, 1000);
      };

      // Sayfa yüklendiğinde ve pencere yeniden boyutlandırıldığında tüm ayarları yap
      window.addEventListener("load", () => {
        // İlk yüklemede viewport bilgisini güncelle
        updateViewportInfo();

        // Mobil cihazlarda/WebView'da ses motorunu otomatik olarak "uyandırmayı" dene.
        // Bu, kullanıcı etkileşimi olmadan seslerin çalınabilmesi için bir denemedir.
        if (!firstInteraction) {
          firstInteraction = true;
          new Audio().play().catch(() => {}); // Boş bir ses çalarak ses bağlamını başlat
        }

        // Ses kontrol ikonları için olay dinleyicisi
        document.body.addEventListener("click", function (e) {
          if (e.target && e.target.classList.contains("speaker-icon")) {
            const durakKey = e.target.getAttribute("data-durak-key");
            if (durakKey && stationMuteStatus.hasOwnProperty(durakKey)) {
              // Ses durumunu tersine çevir
              stationMuteStatus[durakKey] = !stationMuteStatus[durakKey];
              // İkonu güncelle
              e.target.textContent = stationMuteStatus[durakKey] ? "🔇" : "🔊";
            }
          }
        });
      });

      // Pencere boyutu değiştiğinde viewport bilgisini güncelle
      window.addEventListener("resize", () => {
        updateViewportInfo();
        // WebView uyumluluğu için sayfayı yeniden yüklemek yerine veriyi yeniden render et.
        // Bu, hem daha hızlıdır hem de WebView'da sonsuz döngüye girme riskini ortadan kaldırır.
        if (latestData) {
          renderData(latestData);
        }
      });
    </script>
  </body>
</html>
