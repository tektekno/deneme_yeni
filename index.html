<!DOCTYPE html>
<html lang="tr">
  <head>
    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-4Y5K6S0S87"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-4Y5K6S0S87");
    </script>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes"
    />

    <title>Duraklara GÃ¶re SÄ±ralama</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Kode+Mono:wght@400..700&family=Madimi+One&family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Genel ayarlar */
      body {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        height: 100vh;
        width: 100vw;
        background-color: black;
        color: white;
        font-family: "Kode Mono", monospace;
        overflow: hidden;
      }

      /* TÃ¼m iÃ§eriÄŸi kapsayan container */
      .content {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center; /* TÃ¼m iÃ§eriÄŸi dikeyde ortala */
        width: 100%;
        height: 100%;
      }

      #main-container {
        display: flex;
        flex-direction: column;
        width: 100%;
        padding: 0 2vw; /* SaÄŸ ve soldan %2'lik gÃ¼ven aralÄ±ÄŸÄ± bÄ±rak */
        box-sizing: border-box; /* Padding'in geniÅŸliÄŸe dahil edilmesini saÄŸla */
      }

      /* GÃ¼ncelleme yazÄ±sÄ± ve yÃ¼kleme simgesi iÃ§in container */
      .updatetime-container {
        text-align: center;
        font-size: 1.2rem;
        padding-top: 1vh; /* Ãœstten kÃ¼Ã§Ã¼k bir boÅŸluk */
      }

      /* YÃ¼kleme Simgesi */
      .loader {
        border: 4px solid #f3f3f3; /* AÃ§Ä±k gri */
        border-top: 4px solid #3498db; /* Mavi */
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 2s linear infinite;
        margin: 0 auto;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* DuraklarÄ± iÃ§eren container */
      .container {
        display: flex;
        flex-wrap: nowrap;
        width: 100%;
        justify-content: center;
      }

      /* Durak kutularÄ± */
      .durak {
        padding: 1vh 2vw;
        border: 0.2vw solid #ccc;
        border-radius: 2vw;
        text-align: center;
        background-color: #333 !important;
        box-shadow: 0 1vw 1vw rgba(255, 255, 255, 0);
        color: white;
        overflow: hidden; /* Åeritin kÃ¶ÅŸelerden taÅŸan kÄ±sÄ±mlarÄ±nÄ± gizle */
        line-height: 1.2;
        /* VarsayÄ±lan Ã§erÃ§eve kalÄ±nlÄ±ÄŸÄ± */
        border: 0.2vw solid #ccc;
        transition: border-color 0.5s ease;
        position: relative; /* Åerit iÃ§in zorunlu */
      }

      .durak {
        width: var(
          --durak-width,
          80vw
        ); /* JS'den gelen veya varsayÄ±lan deÄŸer */
        font-size: var(
          --durak-font-size,
          4vw
        ); /* JS'den gelen veya varsayÄ±lan deÄŸer */
      }

      /* Dinamik renk sÄ±nÄ±flarÄ± */
      .durak.hizli {
        border-color: #00ff00; /* YeÅŸil */
        border-width: 0.5vw;
      }

      .durak.orta {
        border-color: #ffff00; /* SarÄ± */
        border-width: 0.5vw;
      }

      .durak.yavas {
        border-color: #ff0000; /* KÄ±rmÄ±zÄ± */
        border-width: 0.5vw;
      }

      /* ------------------------------------------- */
      /* --- DÄ°YAGONAL ÅERÄ°T STÄ°LLERÄ° BAÅLANGIÃ‡ --- */
      /* --- YENÄ° GÃœNCELLEME: DAHA AÅAÄI KONUMLANDIRMA VE KÃœÃ‡ÃœK YAZI BOYUTU --- */
      /* ------------------------------------------- */

      .durak::after {
        position: absolute;
        font-family: "Madimi One", sans-serif; /* Åeridi daha Ã§arpÄ±cÄ± gÃ¶stermek iÃ§in font */
        color: white;

        /* YAZI ORTALAMASI */
        display: flex;
        justify-content: center; /* Yatayda ortala */
        align-items: center; /* Dikeyde ortala */

        /* Diyagonal ÅŸerit ayarlarÄ± */
        width: 160%;
        top: 3vw; /* <--- YENÄ° GÃœNCELLEME: Åeridin baÅŸlangÄ±Ã§ noktasÄ±nÄ± daha da aÅŸaÄŸÄ± kaydÄ±rdÄ±k. */
        left: -70%;
        padding: 0.5vw 0;
        font-size: clamp(
          9px,
          1.6vw,
          16px
        ); /* <--- YENÄ° GÃœNCELLEME: Genel font boyutu kÃ¼Ã§Ã¼ltÃ¼ldÃ¼. */
        font-weight: 700;
        line-height: 1.2;
        transform: rotate(-45deg); /* Diyagonal eÄŸim (SOL ÃœSTTEN SAÄ ALTA) */
        z-index: 10;
        box-shadow: 0 0 1vw rgba(0, 0, 0, 0.5);
        text-shadow: 1px 1px 2px black;
        pointer-events: none;
      }

      /* En HÄ±zlÄ± Åeridi */
      .durak.hizli::after {
        content: "EN HIZLI";
        background-color: #00cc00; /* Parlak yeÅŸil ÅŸerit */
      }

      /* Orta HÄ±zlÄ± Åeridi */
      .durak.orta::after {
        content: "ORTA HIZLI";
        background-color: #ffcc00; /* Parlak sarÄ± ÅŸerit */
      }

      /* En YavaÅŸ Åeridi */
      .durak.yavas::after {
        content: "YAVAÅ";
        background-color: #ff3333; /* Parlak kÄ±rmÄ±zÄ± ÅŸerit */
      }

      /* KÃ¼Ã§Ã¼k ekranlar (Dikey mobil) iÃ§in ÅŸerit ayarÄ± optimizasyonu */
      @media (max-width: 600px) {
        .durak::after {
          top: 20px; /* <--- YENÄ° GÃœNCELLEME: Mobilde daha da aÅŸaÄŸÄ± (iÃ§eri) indirildi. */
          left: -70%;
          font-size: 13px; /* <--- YENÄ° GÃœNCELLEME: Mobildeki font boyutu kÃ¼Ã§Ã¼ltÃ¼ldÃ¼. */
        }
      }
      /* ------------------------------------------- */
      /* --- DÄ°YAGONAL ÅERÄ°T STÄ°LLERÄ° BÄ°TÄ°Å --- */
      /* ------------------------------------------- */

      /* Bilgi Tablosu Stilleri */
      #info-table {
        width: var(--durak-width, 85vw); /* GeniÅŸliÄŸi duraklarla aynÄ± yapar */
        max-width: 96%; /* EkranÄ±n kenarlarÄ±na yapÄ±ÅŸmasÄ±nÄ± Ã¶nle */
        margin: 0 auto;
        border-collapse: collapse;
        font-size: clamp(10px, 2.5vw, 18px); /* AkÄ±ÅŸkan font boyutu */
        line-height: 1.4;
      }

      /* SatÄ±r Renkleri */
      #info-table tr:nth-child(1) {
        color: #c8a2c8;
      } /* AÃ§Ä±k Mor */
      #info-table tr:nth-child(2) {
        color: #ffc085;
      } /* AÃ§Ä±k Turuncu */
      #info-table tr:nth-child(3) {
        color: #ff8c8c;
      } /* AÃ§Ä±k KÄ±rmÄ±zÄ± */
      #info-table tr:nth-child(4) {
        color: #87ceeb;
      } /* AÃ§Ä±k Mavi */

      /* Yatay dÃ¼zende tablo geniÅŸliÄŸini ayarla */
      @media (min-aspect-ratio: 1.1) {
        #info-table {
          width: 100%;
          max-width: 800px;
        }
      }

      #info-table .info-key {
        text-align: left;
        padding-right: 1em;
        white-space: nowrap;
        font-weight: bold;
      }

      #info-table .info-value {
        text-align: left;
        font-weight: bold;
      }

      /* AraÃ§ listesi iÃ§in tablo stili */
      .vehicle-table {
        width: 100%;
        border-collapse: collapse; /* KenarlÄ±klarÄ± birleÅŸtir */
        margin-top: 0.5rem;
        font-size: inherit; /* YazÄ± tipi boyutunu parent elementten (durak) al */
      }

      .vehicle-table td {
        white-space: nowrap; /* Metnin satÄ±r atlamasÄ±nÄ± engelle */
        overflow: hidden; /* TaÅŸmayÄ± gizle */
        text-overflow: ellipsis; /* TaÅŸma durumunda Ã¼Ã§ nokta gÃ¶ster */
        padding: 0 0.2vw;
      }

      .vehicle-table .right-align {
        text-align: right;
      }

      /* AyÄ±rÄ±cÄ± Ã‡izgi Stilleri */
      .separator-line {
        border: none;
        border-top: 1px solid #ccc; /* Ana ayÄ±rÄ±cÄ± Ã§izgi rengi */
        width: 100%;
        margin: 0.5rem 0;
      }

      .sub-separator-line {
        border: none;
        border-top: 1px solid #ccc; /* Alt ayÄ±rÄ±cÄ± Ã§izgi rengi (ana Ã§izgiyle aynÄ±) */
        width: 100%;
        margin: 0.3rem 0;
      }

      /* Viewport Bilgi Kutusu */
      #viewport-info {
        position: fixed;
        top: 10px;
        left: 10px;
        padding: 8px 12px;
        background-color: transparent; /* BaÅŸlangÄ±Ã§ta ÅŸeffaf */
        color: transparent; /* BaÅŸlangÄ±Ã§ta ÅŸeffaf */
        font-family: "Kode Mono", monospace;
        font-size: 0.8rem;
        border-radius: 5px;
        cursor: pointer;
        z-index: 1000;
        user-select: none;
        transition: color 0.3s ease, background-color 0.3s ease;
      }

      /* TÄ±klanabilir olduÄŸunda rengi biraz gÃ¶rÃ¼nÃ¼r yapma */
      #viewport-info:hover {
        background-color: rgba(0, 0, 0, 0.6);
        color: white;
      }

      /* Debug ButonlarÄ± iÃ§in Stiller */
      #debug-controls {
        position: fixed;
        bottom: 10px;
        right: 10px;
        background-color: rgba(0, 0, 0, 0.7);
        padding: 10px;
        border-radius: 8px;
        z-index: 1001;
        display: flex;
        flex-direction: column;
        gap: 8px;
        font-size: 0.9rem;
      }
      #debug-controls div {
        display: flex;
        align-items: center;
        gap: 5px;
      }
      #debug-controls button {
        width: 25px;
        height: 25px;
        font-weight: bold;
        cursor: pointer;
      }

      .metal-effect {
        font-weight: bold;
        color: #c0c0c0; /* GÃ¼mÃ¼ÅŸ rengi */
        background: linear-gradient(
          90deg,
          #c0c0c0 48%,
          #ffffff 50%,
          #c0c0c0 52%
        );
        background-size: 300% 100%;
        background-position: 150% 0;
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: metal-shine 3s linear infinite;
        animation: metal-shine 5s linear infinite;
        filter: drop-shadow(0 0 2px rgba(255, 255, 255, 0.3));
      }

      @keyframes metal-shine {
        0% {
          background-position: 150% 0; /* BaÅŸlangÄ±Ã§ pozisyonu (saÄŸda) */
        }
        100% {
          background-position: -150% 0; /* BitiÅŸ pozisyonu (solda) */
        }
      }

      /* Ses kontrol ikonu */
      .speaker-icon {
        position: absolute;
        top: 1vh;
        right: 2vw;
        font-size: clamp(14px, 3vw, 24px);
        cursor: pointer;
        user-select: none; /* Ä°konun seÃ§ilmesini engelle */
      }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  </head>
  <body>
    <div id="debug-controls" style="display: none">
      <div>
        <span>Merkez:</span>
        <button id="add-merkez">+</button>
        <button id="add-closed-merkez">K+</button>
        <button id="remove-merkez">-</button>
      </div>
      <div>
        <span>Metro:</span>
        <button id="add-metro">+</button>
        <button id="add-closed-metro">K+</button>
        <button id="remove-metro">-</button>
      </div>
      <div>
        <span>SÃ¼vari:</span>
        <button id="add-suvari">+</button>
        <button id="add-closed-suvari">K+</button>
        <button id="remove-suvari">-</button>
      </div>
    </div>
    <div id="viewport-info"></div>
    <div class="content">
      <div
        id="debug-warning"
        style="
          color: yellow;
          font-weight: bold;
          display: none;
          margin-bottom: 1rem;
        "
      >
        DÄ°KKAT: DEBUG MODU AKTÄ°F
      </div>
      <div id="main-container">
        <div class="updatetime-container">
          <!-- YÃ¼kleniyor simgesi -->
          <div id="loader" class="loader"></div>
          <!-- Yeni Bilgi Tablosu -->
          <table id="info-table" style="display: none">
            <tbody>
              <tr>
                <td class="info-key">Son GÃ¼ncelleme:</td>
                <td id="info-updatetime" class="info-value"></td>
              </tr>
              <tr>
                <td class="info-key">AraÃ§ DurumlarÄ±:</td>
                <td id="info-gps" class="info-value"></td>
              </tr>
              <tr>
                <td class="info-key">Duyuru:</td>
                <td id="info-closed-vehicle" class="info-value"></td>
              </tr>
              <tr>
                <td class="info-key">Hava Durumu:</td>
                <td id="info-weather" class="info-value"></td>
              </tr>
            </tbody>
          </table>
        </div>
        <div id="duraklar-container" class="container"></div>
      </div>
    </div>
    <script>
      // --- Cihaz Engelleme KontrolÃ¼ ---
      // Bu fonksiyon, sayfanÄ±n geri kalanÄ± Ã§alÄ±ÅŸmadan Ã¶nce Ã§aÄŸrÄ±lÄ±r.
      (function () {
        // Engellenecek cihaz modellerini bu diziye ekleyebilirsiniz.
        const blockedModels = [];
        const userAgent = navigator.userAgent;

        // User agent'Ä±n engellenen modellerden herhangi birini iÃ§erip iÃ§ermediÄŸini kontrol et
        const isBlocked = blockedModels.some((model) =>
          userAgent.includes(model)
        );

        if (isBlocked) {
          const blockedModelFound = blockedModels.find((model) =>
            userAgent.includes(model)
          );
          // Sayfa iÃ§eriÄŸini temizle ve uyarÄ± mesajÄ± gÃ¶ster
          document.documentElement.innerHTML = `
            <head><title>Desteklenmiyor</title><meta name="viewport" content="width=device-width, initial-scale=1.0"></head>
            <body style="background-color: black; color: white; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; font-family: 'Kode Mono', monospace; text-align: center; padding: 20px;">
            </body>`;
          throw new Error("Desteklenmeyen cihaz modeli: " + blockedModelFound); // Script'in geri kalanÄ±nÄ±n Ã§alÄ±ÅŸmasÄ±nÄ± engelle
        }
      })();

      // Firebase yapÄ±landÄ±rma bilgileri
      const firebaseConfig = {
        apiKey: "AIzaSyCTTDvLsIY3ZS8zNP77lxLG0SdoOke2vLk",
        authDomain: "kptakip.firebaseapp.com",
        databaseURL:
          "https://kptakip-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "kptakip",
        storageBucket: "kptakip.firebasestorage.app",
        messagingSenderId: "401633293269",
        appId: "1:401633293269:web:8386edc126aafe1929435c",
      };
      // Firebase uygulamasÄ±nÄ± baÅŸlat
      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();
      const ref = database.ref("taksi_verileri");
      // ElemanlarÄ± seÃ§
      const mainContainer = document.getElementById("main-container");
      const duraklarContainer = document.getElementById("duraklar-container");
      const loaderElement = document.getElementById("loader");
      const viewportInfo = document.getElementById("viewport-info");
      const infoTable = document.getElementById("info-table");
      const infoUpdateTime = document.getElementById("info-updatetime");
      const infoGps = document.getElementById("info-gps");
      const infoClosedVehicle = document.getElementById("info-closed-vehicle");
      const infoWeather = document.getElementById("info-weather");

      // En son yÃ¼klenen veriyi tutmak iÃ§in deÄŸiÅŸken
      let latestData = null;
      // Ã–nceki araÃ§ sayÄ±larÄ±nÄ± tutmak iÃ§in deÄŸiÅŸken
      let previousVehicleCounts = {};
      // DuraklarÄ±n ses durumunu tutmak iÃ§in deÄŸiÅŸken
      let stationMuteStatus = {
        merkez: false, // false = ses aÃ§Ä±k, true = ses kapalÄ±
        metro: false,
        suvari: false,
      };
      // Ä°lk kullanÄ±cÄ± etkileÅŸimini takip etmek iÃ§in bayrak
      let firstInteraction = false;

      /**
       * Saniye cinsinden verilen sÃ¼reyi "Xgn Ysa Zdk Psn" formatÄ±na dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r.
       * @param {number} totalSeconds - Toplam saniye sÃ¼resi.
       * @returns {string} FormatlanmÄ±ÅŸ sÃ¼re metni.
       */
      function formatDuration(totalSeconds) {
        if (totalSeconds < 0) {
          totalSeconds = 0;
        }

        const days = Math.floor(totalSeconds / (24 * 60 * 60));
        const hours = Math.floor((totalSeconds % (24 * 60 * 60)) / (60 * 60));
        const minutes = Math.floor((totalSeconds % (60 * 60)) / 60);
        const seconds = totalSeconds % 60;

        const parts = [];
        if (days > 0) {
          parts.push(`${days}gn`);
        }
        if (hours > 0) {
          parts.push(`${hours}sa`);
        }
        if (minutes > 0) {
          parts.push(`${minutes}dk`);
        }
        parts.push(`${seconds}sn`);

        return parts.join(" ");
      }

      /**
       * Zaman birimini formatlar. EÄŸer deÄŸer 0 ise ve forceDisplayZero true deÄŸilse boÅŸ string dÃ¶ndÃ¼rÃ¼r.
       * Tek haneli deÄŸerler iÃ§in bir boÅŸluk ekler ve saÄŸa yaslar.
       * @param {number} value - Zaman biriminin deÄŸeri (gÃ¼n, saat, dakika, saniye).
       * @param {string} unit - Zaman biriminin kÄ±saltmasÄ± (Ã¶rn: 'gn', 'sa', 'dk', 'sn').
       * @param {boolean} [forceDisplayZero=false] - DeÄŸer 0 olsa bile gÃ¶sterilmesini zorlar.
       * @param {string} [padChar='&nbsp;'] - Tek haneli deÄŸerler iÃ§in kullanÄ±lacak dolgu karakteri.
       * @returns {string} DoldurulmuÅŸ ve hizalanmÄ±ÅŸ metin veya boÅŸ string.
       */
      function padTimeDisplay(
        value,
        unit,
        forceDisplayZero = false,
        padChar = "&nbsp;"
      ) {
        if (value === 0 && !forceDisplayZero) {
          return "";
        }
        // Tek haneli deÄŸerler iÃ§in bir boÅŸluk ekle
        if (value < 10 && value >= 0) {
          return `${padChar}${value}${unit}`;
        }
        return `${value}${unit}`;
      }

      /**
       * Hava durumu kodunu okunabilir bir metne Ã§evirir.
       * @param {number} code - Open-Meteo'dan gelen hava durumu kodu.
       * @returns {string} Hava durumu aÃ§Ä±klamasÄ±.
       */
      function getWeatherDescription(code) {
        const descriptions = {
          0: "AÃ§Ä±k",
          1: "ParÃ§alÄ± Bulutlu",
          2: "ParÃ§alÄ± Bulutlu",
          3: "Bulutlu",
          45: "Sisli",
          48: "Sisli",
          51: "Ã‡iselemeli",
          53: "Ã‡iselemeli",
          55: "Ã‡iselemeli",
          56: "Dondurucu Ã‡iseleme",
          57: "Dondurucu Ã‡iseleme",
          61: "YaÄŸmurlu",
          63: "YaÄŸmurlu",
          65: "Åiddetli YaÄŸmurlu",
          66: "Dondurucu YaÄŸmur",
          67: "Dondurucu YaÄŸmur",
          71: "KarlÄ±",
          73: "KarlÄ±",
          75: "YoÄŸun KarlÄ±",
          77: "Kar Taneleri",
          80: "SaÄŸanak YaÄŸÄ±ÅŸlÄ±",
          81: "SaÄŸanak YaÄŸÄ±ÅŸlÄ±",
          82: "Åiddetli SaÄŸanak",
          95: "GÃ¶k GÃ¼rÃ¼ltÃ¼lÃ¼",
          96: "Hafif Dolu",
          85: "Kar SaÄŸanaÄŸÄ±",
          86: "YoÄŸun Kar SaÄŸanaÄŸÄ±",
          99: "Åiddetli Dolu",
        };
        return descriptions[code] || "Bilinmiyor";
      }

      /**
       * Bornova, Ä°zmir iÃ§in hava durumu verilerini Ã§eker ve gÃ¶sterir.
       */
      async function fetchWeather() {
        try {
          const response = await fetch(
            "https://api.open-meteo.com/v1/forecast?latitude=38.46&longitude=27.22&daily=weathercode&timezone=Europe/Istanbul"
          );
          const data = await response.json();

          const today = data.daily;

          // YaÄŸmur, kar, dolu ve fÄ±rtÄ±na gibi araÃ§ yÄ±kamaya uygun olmayan tÃ¼m kÃ¶tÃ¼ hava kodlarÄ±
          const badWeatherCodes = [
            51, 53, 55, 61, 63, 65, 66, 67, 71, 73, 75, 77, 80, 81, 82, 85, 86,
            95, 96, 99,
          ];
          const tomorrowCode = today.weathercode[1];
          const weatherRow = infoWeather.parentElement; // <tr> elementini al

          if (badWeatherCodes.includes(tomorrowCode)) {
            infoWeather.textContent = "ğŸŒ§ï¸â˜‚ï¸YakÄ±nda yaÄŸÄ±ÅŸ var, araÃ§ yÄ±kanmaz."; // Renk CSS'den gelecek
            // YaÄŸÄ±ÅŸ varsa, satÄ±r rengini camgÃ¶beÄŸi yap ama animasyon ekleme
            weatherRow.style.color = "#00ffff";
          } else {
            infoWeather.textContent = "YakÄ±nda yaÄŸÄ±ÅŸ yok, araÃ§ yÄ±kanÄ±r."; // Renk CSS'den gelecek
            // YaÄŸÄ±ÅŸ yoksa, satÄ±r rengini varsayÄ±lana dÃ¶ndÃ¼r
            weatherRow.style.color = "";
          }
        } catch (error) {
          console.error("Hava durumu verisi alÄ±namadÄ±:", error);
          infoWeather.textContent = "Bilgi alÄ±namadÄ±.";
        }
      }

      /**
       * Verilen URL'deki ses dosyasÄ±nÄ± Ã§alar.
       * @param {string} url - Ã‡alÄ±nacak ses dosyasÄ±nÄ±n URL'si.
       */
      function playAudio(url) {
        if (!firstInteraction) {
          // KullanÄ±cÄ± etkileÅŸimi olmadan ses Ã§alÄ±namaz, bu yÃ¼zden iÅŸlemi atla.
          return;
        }
        const audio = new Audio(url);
        audio.play().catch(error => {
          // Oynatma hatasÄ± (genellikle kullanÄ±cÄ± etkileÅŸimi olmadan engellendiÄŸinde)
          // Bu hatayÄ± konsolda gÃ¶stermek genellikle gereksizdir Ã§Ã¼nkÃ¼ beklenen bir durumdur.
          // console.error("Ses Ã§alma hatasÄ±:", error);
        });
      }

      function renderData(data) {
        // En son veriyi global olarak sakla
        latestData = data;

        // YÃ¼kleme simgesini gizle ve gÃ¼ncelleme metinlerini gÃ¶ster
        loaderElement.style.display = "none";
        infoTable.style.display = "table";

        // GÃ¼ncelleme zamanÄ±nÄ± ve GPS bilgi metnini ayarla
        infoUpdateTime.textContent = data.son_guncelleme;
        infoGps.textContent = "TÃ¼m araÃ§lardaki sorunlar dÃ¼zeltildi."; // Metin zaten doÄŸru, teyit edildi.
        infoClosedVehicle.textContent =
          "KÄ±rmÄ±zÄ± renkteki araÃ§lar kapalÄ±dÄ±r, sÄ±raya dahil deÄŸildir.";

        // Hava durumu verisini sadece ana veri yÃ¼klendikten sonra Ã§ek ve gÃ¶ster
        fetchWeather();

        // Dinamik font bÃ¼yÃ¼klÃ¼ÄŸÃ¼ sÄ±nÄ±flarÄ± iÃ§in stilleri dinamik olarak ekle
        // "AraÃ§ DurumlarÄ±" satÄ±rÄ±na metalik parlama efekti ekle
        infoGps.parentElement.classList.add("metal-effect");

        // Bu, media query'lerdeki .font-size-large gibi sÄ±nÄ±flarÄ±n yerini alÄ±r
        const contentDiv = document.querySelector(".content");
        const aspectRatio = window.innerWidth / window.innerHeight;
        // Durak bilgilerini iÅŸle
        duraklarContainer.innerHTML = "";
        const duraklar = data.duraklar;
        const durak_names = {
          suvari: "SÃ¼vari",
          merkez: "Merkez",
          metro: "Metro",
        };

        // DuraklarÄ± belirli bir sÄ±rada oluÅŸtur
        const orderedDuraks = ["merkez", "metro", "suvari"];

        // Ortalama kalkÄ±ÅŸ sÃ¼relerini topla ve sÄ±rala
        const averageTimes = orderedDuraks
          .map((key) => ({
            key,
            time: duraklar[key].ortalama_kalkis,
          }))
          .sort((a, b) => a.time - b.time);

        // En hÄ±zlÄ±, orta ve en yavaÅŸ duraklarÄ± belirle
        const fastest = averageTimes[0].key;
        const middle = averageTimes[1].key;
        const slowest = averageTimes[2].key;

        // --- YENÄ° ORANTISAL YÃœKSEKLÄ°K HESAPLAMA MANTIÄI ---
        // 1. TÃ¼m duraklardaki araÃ§ sayÄ±larÄ±nÄ± al
        const vehicleCounts = {
          merkez: duraklar.merkez.liste ? duraklar.merkez.liste.length : 0,
          metro: duraklar.metro.liste ? duraklar.metro.liste.length : 0,
          suvari: duraklar.suvari.liste ? duraklar.suvari.liste.length : 0,
        };
        const totalVehicles =
          vehicleCounts.merkez + vehicleCounts.metro + vehicleCounts.suvari;

        // --- SESLÄ° BÄ°LDÄ°RÄ°M Ä°Ã‡Ä°N DEÄÄ°ÅÄ°KLÄ°K KONTROLÃœ ---
        const newVehicleCounts = {};
        orderedDuraks.forEach((key) => {
          const aracSayisi = data.duraklar[key].liste
            ? data.duraklar[key].liste.filter((arac) => !arac.is_closed).length
            : 0;
          newVehicleCounts[key] = aracSayisi;

          // EÄŸer bu duraÄŸÄ±n Ã¶nceki sayÄ±sÄ± varsa ve deÄŸiÅŸmiÅŸse sesli bildirim yap
          if (
            previousVehicleCounts[key] !== undefined &&
            previousVehicleCounts[key] !== aracSayisi &&
            !stationMuteStatus[key] // EÄŸer ses kapalÄ± deÄŸilse
          ) {
            // Ã‡alÄ±nacak ses dosyasÄ±nÄ±n adÄ±nÄ± oluÅŸtur (Ã¶rn: merkez2.opus, suvari0.opus)
            const audioFileName = `${key}${aracSayisi}.opus`;
            // GitHub raw content URL'sini oluÅŸtur
            const audioUrl = `https://raw.githubusercontent.com/tektekno/deneme_yeni/master/voices/${audioFileName}`;

            // Render dÃ¶ngÃ¼sÃ¼nÃ¼ bloklamamak iÃ§in konuÅŸmayÄ± kÄ±sa bir gecikmeyle yap
            // Bu, Ã¶zellikle WebView ve mobil cihazlarda performansÄ± artÄ±rÄ±r.
            setTimeout(() => playAudio(audioUrl), 100);
          }
        });

        // Bir sonraki kontrol iÃ§in mevcut sayÄ±larÄ± kaydet
        previousVehicleCounts = newVehicleCounts;

        // Her bir durak iÃ§in ayrÄ± ayrÄ± hizalama uzunluÄŸunu belirle
        orderedDuraks.forEach((key) => {
          if (duraklar.hasOwnProperty(key)) {
            const durak = duraklar[key];
            const durakDiv = document.createElement("div");
            durakDiv.className = "durak";

            // HÄ±z durumuna gÃ¶re sÄ±nÄ±f ekle
            if (key === fastest) {
              durakDiv.classList.add("hizli");
            } else if (key === middle) {
              durakDiv.classList.add("orta");
            } else if (key === slowest) {
              durakDiv.classList.add("yavas");
            }

            let htmlContent = "";

            const aracListesi = durak.liste || [];
            const activeVehicles = aracListesi.filter(
              (arac) => !arac.is_closed
            );
            const closedVehicles = aracListesi.filter((arac) => arac.is_closed);
            const aracSayisi = activeVehicles.length; // Sadece aktif araÃ§larÄ± say

            // BaÅŸlÄ±k satÄ±rÄ±
            const speakerIcon = stationMuteStatus[key] ? "ğŸ”‡" : "ğŸ”Š";
            htmlContent += `<span class="speaker-icon" data-durak-key="${key}">${speakerIcon}</span>`;

            htmlContent += `${durak_names[key]} (${aracSayisi})<br>`;

            // Ortalama kalkÄ±ÅŸ satÄ±rÄ±
            const formattedAverageDeparture = formatDuration(
              durak.ortalama_kalkis
            );
            htmlContent += `Ortalama KalkÄ±ÅŸ: ${formattedAverageDeparture}<br>`;

            // --- YENÄ° STÄ°L MANTIÄI ---
            // Genel container stilleri sadece bir kez ayarlanÄ±r
            if (
              !duraklarContainer.style.flexDirection ||
              (!duraklarContainer.style.flexDirection.includes("column") &&
                aspectRatio < 1.1)
            ) {
              // Dikey ve kareye yakÄ±n dÃ¼zenler
              if (aspectRatio < 1.1) {
                duraklarContainer.style.flexDirection = "column";
                duraklarContainer.style.alignItems = "center";
                duraklarContainer.style.paddingTop = "2vh";
                duraklarContainer.style.gap = "2.4vh"; // 18px / 754px
              } else {
                // Yatay dÃ¼zenler
                duraklarContainer.style.flexDirection = "row";
                duraklarContainer.style.justifyContent = "center";
                duraklarContainer.style.marginTop = "2%";
                duraklarContainer.style.alignItems = "flex-start"; // ElemanlarÄ±n uzamasÄ±nÄ± engelle, yukarÄ± hizala.
                duraklarContainer.style.gap = "2vw";
              }
            }

            // --- AKIÅKAN FORMÃœL Ä°LE STÄ°L HESAPLAMA ---

            // 1. AkÄ±ÅŸkan Font Boyutu: Ekran daraldÄ±kÃ§a (aspectRatio kÃ¼Ã§Ã¼ldÃ¼kÃ§e) font bÃ¼yÃ¼r.
            const fluidFontSize = `clamp(1.4vw, ${2 / aspectRatio}vw, 4.5vw)`;

            // 2. AkÄ±ÅŸkan GeniÅŸlik: Ekran daraldÄ±kÃ§a geniÅŸlik artar.
            const fluidWidth = `clamp(30vw, ${50 / aspectRatio}vw, 85vw)`;

            // 3. Hesaplanan deÄŸerleri CSS deÄŸiÅŸkenleri olarak ata
            durakDiv.style.setProperty("--durak-font-size", fluidFontSize);
            durakDiv.style.setProperty("--durak-width", fluidWidth);

            // Bilgi tablosunun geniÅŸliÄŸini de duraklarla aynÄ± yapmak iÃ§in
            document.documentElement.style.setProperty(
              "--durak-width",
              fluidWidth
            );

            // 4. Dikey/Yatay dÃ¼zene gÃ¶re flex-grow ve height ayarla
            if (aspectRatio < 1.1) {
              // Dikey DÃ¼zen
              durakDiv.style.height = "auto";
              let flexGrowValue = 1;
              if (totalVehicles > 0) {
                flexGrowValue = 1 + (vehicleCounts[key] / totalVehicles) * 10;
              }
              durakDiv.style.flexGrow = flexGrowValue.toFixed(2);
            } else {
              // Yatay DÃ¼zen
              // Yatayda yÃ¼kseklik araÃ§ sayÄ±sÄ±yla orantÄ±lÄ± olsun.
              const baseHeightVh = 15; // BaÅŸlÄ±k vb. iÃ§in temel yÃ¼kseklik.
              const heightPerVehicleVh = 3; // Her araÃ§ satÄ±rÄ± iÃ§in ek yÃ¼kseklik.
              const totalHeight =
                baseHeightVh + aracSayisi * heightPerVehicleVh;

              durakDiv.style.height = "auto"; // YÃ¼ksekliÄŸin iÃ§eriÄŸe gÃ¶re doÄŸal olarak bÃ¼yÃ¼mesine izin ver.
              durakDiv.style.minHeight = `${totalHeight}vh`; // Ancak en azÄ±ndan hesaplanan kadar yer kaplamasÄ±nÄ± saÄŸla.
              durakDiv.style.maxHeight = "80vh"; // EkranÄ± taÅŸmasÄ±nÄ± Ã¶nlemek iÃ§in maksimum yÃ¼kseklik.
              durakDiv.style.flexGrow = "0"; // Yatayda esnemesin
            }

            // AyÄ±rÄ±cÄ± Ã§izgi
            htmlContent += `<hr class="separator-line">`;

            // AraÃ§ listesi
            if (aracListesi.length > 0) {
              htmlContent += '<table class="vehicle-table"><tbody>';

              // TÃ¼m araÃ§lar iÃ§in (aktif ve kapalÄ±) hangi zaman birimlerinin gÃ¶sterileceÄŸini belirle
              const showDays = aracListesi.some(
                (a) => a.entry_duration >= 86400
              );
              const showHours = aracListesi.some(
                (a) => a.entry_duration >= 3600
              );
              const showMinutes = aracListesi.some(
                (a) => a.entry_duration >= 60
              );

              // 1. KapalÄ± araÃ§larÄ± render et
              closedVehicles.forEach((arac) => {
                const rowStyle = 'style="color: #FF4C4C;"'; // Her zaman kÄ±rmÄ±zÄ±
                const totalSeconds = arac.entry_duration;
                const days = Math.floor(totalSeconds / (24 * 60 * 60));
                const hours = Math.floor(
                  (totalSeconds % (24 * 60 * 60)) / (60 * 60)
                );
                const minutes = Math.floor((totalSeconds % (60 * 60)) / 60);
                const seconds = totalSeconds % 60;

                htmlContent += `<tr ${rowStyle}>`;
                htmlContent += `<td>K)</td>`; // Ã–n ek "K)"
                htmlContent += `<td>${arac.code}</td>`;
                htmlContent += `<td>${arac.plate}</td>`;

                // SÃ¼re gÃ¶sterimi (aktif araÃ§larla aynÄ± formatta)
                if (showDays && days > 0) {
                  htmlContent += `<td class="right-align">${padTimeDisplay(
                    days,
                    "gn"
                  )}</td>`;
                }
                if (showHours) {
                  htmlContent += `<td class="right-align">${padTimeDisplay(
                    hours,
                    "sa"
                  )}</td>`;
                  htmlContent += `<td class="right-align">${padTimeDisplay(
                    minutes,
                    "dk"
                  )}</td>`;
                  htmlContent += `<td class="right-align">${padTimeDisplay(
                    seconds,
                    "sn",
                    true
                  )}</td>`;
                } else if (showMinutes) {
                  htmlContent += `<td class="right-align">${padTimeDisplay(
                    minutes,
                    "dk"
                  )}</td>`;
                  htmlContent += `<td class="right-align">${padTimeDisplay(
                    seconds,
                    "sn",
                    true
                  )}</td>`;
                } else {
                  htmlContent += `<td class="right-align">${padTimeDisplay(
                    seconds,
                    "sn",
                    true
                  )}</td>`;
                }

                htmlContent += `</tr>`;
              });

              // KapalÄ± ve aktif araÃ§lar arasÄ±nda ayÄ±rÄ±cÄ±
              if (closedVehicles.length > 0 && activeVehicles.length > 0) {
                htmlContent += `<tr><td colspan="7"><hr class="sub-separator-line"></td></tr>`;
              }

              // 2. Aktif araÃ§larÄ± render et
              activeVehicles.forEach((arac, index) => {
                const totalSeconds = arac.entry_duration;
                const days = Math.floor(totalSeconds / (24 * 60 * 60));
                const hours = Math.floor(
                  (totalSeconds % (24 * 60 * 60)) / (60 * 60)
                );
                const minutes = Math.floor((totalSeconds % (60 * 60)) / 60);
                const seconds = totalSeconds % 60;

                // Gizli mod aktifse kod ve plaka gÃ¶sterimini deÄŸiÅŸtir
                const displayCode = currentHiddenMode ? "**" : arac.code;
                const displayPlate =
                  currentHiddenMode && arac.plate.includes("T")
                    ? arac.plate.substring(0, arac.plate.indexOf("T") + 1) +
                      "****"
                    : arac.plate;

                htmlContent += `<tr>`;
                htmlContent += `<td>${index + 1})</td>`; // NumaralÄ± Ã¶n ek
                htmlContent += `<td>${displayCode}</td>`;
                htmlContent += `<td>${displayPlate}</td>`;

                if (showDays && days > 0) {
                  htmlContent += `<td class="right-align">${padTimeDisplay(
                    days,
                    "gn"
                  )}</td>`;
                }
                if (showHours) {
                  htmlContent += `<td class="right-align">${padTimeDisplay(
                    hours,
                    "sa"
                  )}</td>`;
                  htmlContent += `<td class="right-align">${padTimeDisplay(
                    minutes,
                    "dk"
                  )}</td>`;
                  htmlContent += `<td class="right-align">${padTimeDisplay(
                    seconds,
                    "sn",
                    true
                  )}</td>`;
                } else if (showMinutes) {
                  htmlContent += `<td class="right-align">${padTimeDisplay(
                    minutes,
                    "dk"
                  )}</td>`;
                  htmlContent += `<td class="right-align">${padTimeDisplay(
                    seconds,
                    "sn",
                    true
                  )}</td>`;
                } else {
                  htmlContent += `<td class="right-align">${padTimeDisplay(
                    seconds,
                    "sn",
                    true
                  )}</td>`;
                }

                htmlContent += `</tr>`;
              });

              htmlContent += "</tbody></table>";
            } else {
              htmlContent += "BoÅŸ"; // HiÃ§ araÃ§ yoksa
            }

            // YENÄ°: Sadece kapalÄ± araÃ§ varsa, altÄ±na Ã§izgi ve "BoÅŸ" yazÄ±sÄ± ekle
            if (closedVehicles.length > 0 && activeVehicles.length === 0) {
              htmlContent += `<hr class="sub-separator-line">`;
              htmlContent += "BoÅŸ";
            }

            durakDiv.innerHTML = htmlContent;
            duraklarContainer.appendChild(durakDiv);
          }
        });
      }

      // --- DEBUG MODU ---
      // Test verilerini kullanmak iÃ§in `true`, gerÃ§ek zamanlÄ± Firebase verilerini kullanmak iÃ§in `false` yapÄ±n.
      const DEBUG_MODE = false;

      // --- GÄ°ZLÄ° MOD AYARLARI ---

      // ZamanlayÄ±cÄ±yÄ± aktif etmek iÃ§in `true`, manuel kontrol iÃ§in `false` yapÄ±n.
      const HIDDEN_MODE_TIMER = false;

      // ZamanlayÄ±cÄ± kapalÄ±yken (HIDDEN_MODE_TIMER = false) gizli modu manuel aÃ§Ä±p kapatmak iÃ§in bu ayarÄ± kullanÄ±n.
      const HIDDEN_MODE_MANUAL = false;

      // ZamanlayÄ±cÄ± ayarlarÄ± (Sadece HIDDEN_MODE_TIMER = true ise geÃ§erlidir)
      const HIDDEN_MODE_START_HOUR = 16;
      const HIDDEN_MODE_START_MINUTE = 0;
      const HIDDEN_MODE_END_HOUR = 5;
      const HIDDEN_MODE_END_MINUTE = 30;

      // --- GÄ°ZLÄ° MOD KONTROL MANTIÄI ---
      function isHiddenModeActive() {
        if (!HIDDEN_MODE_TIMER) {
          return HIDDEN_MODE_MANUAL;
        }

        const now = new Date();
        // UTC saatini alÄ±p Ã¼zerine 3 saat ekleyerek TÃ¼rkiye saatini buluyoruz.
        // Bu metod, tarayÄ±cÄ± saat dilimi ayarÄ±ndan baÄŸÄ±msÄ±z olarak UTC+3 saatini hesaplar.
        const turkeyHour = (now.getUTCHours() + 3) % 24;
        const turkeyMinute = now.getUTCMinutes();

        // Saat baÅŸlangÄ±Ã§ saatinden sonra mÄ±? (BaÅŸlangÄ±Ã§ dakikasÄ± dahildir: >=)
        const isAfterStart =
          turkeyHour > HIDDEN_MODE_START_HOUR ||
          (turkeyHour === HIDDEN_MODE_START_HOUR &&
            turkeyMinute >= HIDDEN_MODE_START_MINUTE);

        // Saat bitiÅŸ saatinden Ã¶nce mi? (BitiÅŸ dakikasÄ± dahil deÄŸildir: <)
        // DÃœZELTME: Gizli modun bitiÅŸ saatinde (Ã¶rn. 05:30) kapanmasÄ± iÃ§in minute kontrolÃ¼nÃ¼ '<' yaptÄ±k.
        const isBeforeEnd =
          turkeyHour < HIDDEN_MODE_END_HOUR ||
          (turkeyHour === HIDDEN_MODE_END_HOUR &&
            turkeyMinute < HIDDEN_MODE_END_MINUTE);

        // Gece yarÄ±sÄ±nÄ± geÃ§en bir aralÄ±k mÄ± kontrolÃ¼ (Ã¶rn: 16:00 - 05:30)
        if (HIDDEN_MODE_START_HOUR > HIDDEN_MODE_END_HOUR) {
          // Ya baÅŸlangÄ±Ã§tan sonra (aynÄ± gÃ¼n) YA DA bitiÅŸten Ã¶nce (ertesi gÃ¼n)
          return isAfterStart || isBeforeEnd;
        }
        // AynÄ± gÃ¼n iÃ§indeki aralÄ±k kontrolÃ¼ (Ã¶rn: 09:00 - 17:00)
        else {
          // Hem baÅŸlangÄ±Ã§tan sonra HEM DE bitiÅŸten Ã¶nce olmalÄ±
          return isAfterStart && isBeforeEnd;
        }
      }

      // BaÅŸlangÄ±Ã§ta gizli mod durumunu hesapla ve sakla
      let currentHiddenMode = isHiddenModeActive();

      /**
       * Gizli mod durumunu 5 saniyede bir kontrol eder ve arayÃ¼zÃ¼ gÃ¼nceller.
       */
      function checkHiddenModeAndRefresh() {
        const newHiddenMode = isHiddenModeActive();

        // EÄŸer gizli mod durumu deÄŸiÅŸtiyse VEYA DEBUG modunda isek (mock data'yÄ± gÃ¼ncellemek iÃ§in)
        if (newHiddenMode !== currentHiddenMode || DEBUG_MODE) {
          currentHiddenMode = newHiddenMode;
          // Yeni durumla birlikte arayÃ¼zÃ¼ yeniden Ã§iz
          if (latestData) {
            renderData(latestData);
          } else if (DEBUG_MODE) {
            // DEBUG modunda mockData'yÄ± tekrar render et
            // MockData'nÄ±n gÃ¼ncel HiddenMode ile Ã§alÄ±ÅŸmasÄ±nÄ± saÄŸla
            renderData(mockData);
          }
        }
      }

      // Her 5 saniyede bir gizli mod durumunu kontrol et
      setInterval(checkHiddenModeAndRefresh, 5000);

      if (DEBUG_MODE) {
        // --- DEBUG MODU Ä°Ã‡Ä°N KONTROL VE VERÄ° YAPISI ---

        // 1. ButonlarÄ± ve kontrol panelini gÃ¶rÃ¼nÃ¼r yap
        const debugControls = document.getElementById("debug-controls");
        const STORAGE_KEY = "debugVehicleState";
        debugControls.style.display = "flex";
        document.getElementById("debug-warning").style.display = "block";

        // Viewport bilgisini gÃ¶rÃ¼nÃ¼r yap
        const viewportInfoDiv = document.getElementById("viewport-info");
        viewportInfoDiv.style.backgroundColor = "rgba(0, 0, 0, 0.6)";
        viewportInfoDiv.style.color = "white";

        // 2. TÃ¼m olasÄ± araÃ§larÄ± iÃ§eren bir havuz oluÅŸtur
        const allVehicles = [
          { code: "21", plate: "35T7575" },
          { code: "22", plate: "35T5702" },
          { code: "23", plate: "35T6619" },
          { code: "24", plate: "35T7734" },
          { code: "25", plate: "35T5595" },
          { code: "26", plate: "35T6913" },
          { code: "27", plate: "35T6581" },
          { code: "28", plate: "35T6272" },
          { code: "29", plate: "35T5023" },
          { code: "30", plate: "35T7274" },
          { code: "32", plate: "35T6383" },
          { code: "33", plate: "35T7623" },
          { code: "34", plate: "35T6975" },
          { code: "35", plate: "35T5601" },
          { code: "36", plate: "35T7812" },
          { code: "37", plate: "35T5071" },
        ];

        // 3. localStorage'dan kayÄ±tlÄ± durumu yÃ¼kle veya baÅŸlangÄ±Ã§ verisini oluÅŸtur
        const savedState = localStorage.getItem(STORAGE_KEY);
        const initialDuraklarState = savedState
          ? JSON.parse(savedState)
          : {
              merkez: { liste: [], ortalama_kalkis: 6200 },
              metro: { liste: [], ortalama_kalkis: 950 },
              suvari: {
                liste: [{ code: "27", plate: "35T6581", entry_duration: 40 }],
                ortalama_kalkis: 40,
              },
            };

        const mockData = {
          son_guncelleme: "18.09.2023 | 10:00:00 (Test Verisi)",
          duraklar: initialDuraklarState,
        };

        // 4. Butonlara olay dinleyicileri ekle
        document
          .getElementById("add-merkez")
          .addEventListener("click", () => addVehicle("merkez"));
        document
          .getElementById("add-closed-merkez")
          .addEventListener("click", () => addVehicle("merkez", true));
        document
          .getElementById("remove-merkez")
          .addEventListener("click", () => removeVehicle("merkez"));

        document
          .getElementById("add-metro")
          .addEventListener("click", () => addVehicle("metro"));
        document
          .getElementById("add-closed-metro")
          .addEventListener("click", () => addVehicle("metro", true));
        document
          .getElementById("remove-metro")
          .addEventListener("click", () => removeVehicle("metro"));

        document
          .getElementById("add-suvari")
          .addEventListener("click", () => addVehicle("suvari"));
        document
          .getElementById("add-closed-suvari")
          .addEventListener("click", () => addVehicle("suvari", true));
        document
          .getElementById("remove-suvari")
          .addEventListener("click", () => removeVehicle("suvari"));

        function saveState() {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(mockData.duraklar));
        }

        function getTotalVehicleCount() {
          return (
            mockData.duraklar.merkez.liste.length +
            mockData.duraklar.metro.liste.length +
            mockData.duraklar.suvari.liste.length
          );
        }

        function addVehicle(durakKey, isClosed = false) {
          if (mockData.duraklar[durakKey].liste.length >= 10) {
            // Not: alert() yerine daha iyi bir yÃ¶ntem kullanÄ±lmalÄ±dÄ±r, ancak debug iÃ§in kabul edilebilir.
            console.error("Bu duraÄŸa daha fazla araÃ§ eklenemez (maksimum 10)!");
            return;
          }

          if (getTotalVehicleCount() >= 16) {
            console.error("Toplam araÃ§ sayÄ±sÄ± 16'yÄ± geÃ§emez!");
            return;
          }

          // HenÃ¼z duraklarda olmayan bir araÃ§ bul
          const assignedPlates = [
            ...mockData.duraklar.merkez.liste,
            ...mockData.duraklar.metro.liste,
            ...mockData.duraklar.suvari.liste,
          ].map((v) => v.plate);
          const availableVehicle = allVehicles.find(
            (v) => !assignedPlates.includes(v.plate)
          );

          if (availableVehicle) {
            const newVehicle = {
              ...availableVehicle,
              entry_duration: Math.floor(Math.random() * 10000),
              is_closed: isClosed, // KapalÄ± olup olmadÄ±ÄŸÄ±nÄ± ayarla
            };
            mockData.duraklar[durakKey].liste.push(newVehicle);
            saveState(); // Durumu localStorage'a kaydet
            renderData(mockData); // ArayÃ¼zÃ¼ gÃ¼ncelle
          }
        }

        function removeVehicle(durakKey) {
          if (mockData.duraklar[durakKey].liste.length > 0) {
            mockData.duraklar[durakKey].liste.pop(); // Son aracÄ± sil
            saveState(); // Durumu localStorage'a kaydet
            renderData(mockData); // ArayÃ¼zÃ¼ gÃ¼ncelle
          } else {
            console.error(`${durakKey} duraÄŸÄ±nda silinecek araÃ§ yok.`);
          }
        }

        // 5. Sayfa ilk yÃ¼klendiÄŸinde mock veriyi render et
        renderData(mockData);
      } else {
        // VeritabanÄ± referansÄ±ndaki veriyi dinle (DEBUG_MODE = false ise Ã§alÄ±ÅŸÄ±r)
        ref.on(
          "value",
          (snapshot) => {
            const data = snapshot.val();
            if (data && data.duraklar) {
              renderData(data);
            } else {
              console.error(
                "Veri alÄ±namadÄ± veya 'duraklar' anahtarÄ± bulunamadÄ±."
              );
              duraklarContainer.innerHTML =
                '<p style="color:red; text-align:center;">Veri alÄ±namadÄ±. LÃ¼tfen Python betiÄŸinin Ã§alÄ±ÅŸtÄ±ÄŸÄ±ndan emin olun.</p>';
            }
          },
          (error) => {
            console.error("Veri okuma hatasÄ±: ", error);
            duraklarContainer.innerHTML =
              '<p style="color:red; text-align:center;">Veri okuma hatasÄ± oluÅŸtu. Konsolu kontrol edin.</p>';
          }
        );
      }

      // Viewport bilgisi fonksiyonlarÄ±
      function updateViewportInfo() {
        const width = window.innerWidth;
        const height = window.innerHeight;
        // En/Boy oranÄ±nÄ± hesapla ve 2 ondalÄ±k basamaÄŸa yuvarla
        const aspectRatio = (width / height).toFixed(2);
        viewportInfo.textContent = `Viewport: ${width}x${height} | En/Boy OranÄ±: ${aspectRatio} w/h | Hidden Mode: ${
          currentHiddenMode ? "ON" : "OFF"
        }`;
      }

      // Viewport bilgisi div'ine tÄ±klama olayÄ± ekle
      viewportInfo.onclick = function () {
        const textToCopy = this.textContent;
        const tempTextArea = document.createElement("textarea");
        tempTextArea.value = textToCopy;
        document.body.appendChild(tempTextArea);
        tempTextArea.select();
        document.execCommand("copy");
        document.body.removeChild(tempTextArea);

        this.textContent = "KopyalandÄ±!";
        // Kopyalama mesajÄ± gÃ¶rÃ¼nÃ¼r hale getirildi
        this.style.backgroundColor = "rgba(255, 255, 255, 0.2)";
        this.style.color = "white";

        setTimeout(() => {
          // MesajÄ± eski haline dÃ¶ndÃ¼r
          updateViewportInfo();
          this.style.backgroundColor = "transparent";
          this.style.color = "rgba(0, 0, 0, 0)";
        }, 1000);
      };

      // Sayfa yÃ¼klendiÄŸinde ve pencere yeniden boyutlandÄ±rÄ±ldÄ±ÄŸÄ±nda tÃ¼m ayarlarÄ± yap
      window.addEventListener("load", () => {
        // Ä°lk yÃ¼klemede viewport bilgisini gÃ¼ncelle
        updateViewportInfo();

        // Mobil cihazlarda/WebView'da ses motorunu otomatik olarak "uyandÄ±rmayÄ±" dene.
        // Bu, kullanÄ±cÄ± etkileÅŸimi olmadan seslerin Ã§alÄ±nabilmesi iÃ§in bir denemedir.
        if (!firstInteraction) {
          firstInteraction = true;
          new Audio().play().catch(() => {}); // BoÅŸ bir ses Ã§alarak ses baÄŸlamÄ±nÄ± baÅŸlat
        }

        // Ses kontrol ikonlarÄ± iÃ§in olay dinleyicisi
        document.body.addEventListener("click", function (e) {
          if (e.target && e.target.classList.contains("speaker-icon")) {
            const durakKey = e.target.getAttribute("data-durak-key");
            if (durakKey && stationMuteStatus.hasOwnProperty(durakKey)) {
              // Ses durumunu tersine Ã§evir
              stationMuteStatus[durakKey] = !stationMuteStatus[durakKey];
              // Ä°konu gÃ¼ncelle
              e.target.textContent = stationMuteStatus[durakKey] ? "ğŸ”‡" : "ğŸ”Š";
            }
          }
        });
      });

      // Pencere boyutu deÄŸiÅŸtiÄŸinde viewport bilgisini gÃ¼ncelle
      window.addEventListener("resize", () => {
        updateViewportInfo();
        // WebView uyumluluÄŸu iÃ§in sayfayÄ± yeniden yÃ¼klemek yerine veriyi yeniden render et.
        // Bu, hem daha hÄ±zlÄ±dÄ±r hem de WebView'da sonsuz dÃ¶ngÃ¼ye girme riskini ortadan kaldÄ±rÄ±r.
        if (latestData) {
          renderData(latestData);
        }
      });
    </script>
  </body>
</html>
