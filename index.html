<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Duraklara GÃ¶re SÄ±ralama</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kode+Mono:wght@400..700&family=Madimi+One&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
      /* Genel ayarlar */
      body {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        height: 100vh;
        width: 100vw;
        background-color: black;
        color: white;
        font-family: 'Kode Mono', monospace;
        overflow: hidden;
      }

      /* TÃ¼m iÃ§eriÄŸi kapsayan container */
      .content {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center; /* TÃ¼m iÃ§eriÄŸi dikeyde ortala */
        width: 100%;
        height: 100%;
      }

      #main-container {
        display: flex;
        flex-direction: column;
        width: 100%;
        padding: 0 2vw; /* SaÄŸ ve soldan %2'lik gÃ¼ven aralÄ±ÄŸÄ± bÄ±rak */
        box-sizing: border-box; /* Padding'in geniÅŸliÄŸe dahil edilmesini saÄŸla */
      }

      /* GÃ¼ncelleme yazÄ±sÄ± ve yÃ¼kleme simgesi iÃ§in container */
      .updatetime-container {
        text-align: center;
        font-size: 1.2rem;
        padding-top: 1vh; /* Ãœstten kÃ¼Ã§Ã¼k bir boÅŸluk */
      }

      /* Hava durumu metinlerinin taÅŸmasÄ±nÄ± Ã¶nleyen akÄ±ÅŸkan font boyutu */
      #weather-info, #weather-warning {
        font-size: clamp(9px, 2.5vw, 20px);
        line-height: 1;
      }

      /* YÃ¼kleme Simgesi */
      .loader {
        border: 4px solid #f3f3f3; /* AÃ§Ä±k gri */
        border-top: 4px solid #3498db; /* Mavi */
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 2s linear infinite;
        margin: 0 auto;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* DuraklarÄ± iÃ§eren container */
      .container {
        display: flex;
        flex-wrap: nowrap;
        width: 100%;
        justify-content: center;
      }

      /* Durak kutularÄ± */
      .durak {
        padding: 1vh 2vw; /* Ãœst/Alt: 1vh (sabit), SaÄŸ/Sol: 2vw. Ä°steÄŸe gÃ¶re gÃ¼ncellendi. */
        border: 0.2vw solid #ccc;
        border-radius: 2vw;
        text-align: center;
        background-color: #333 !important;
        box-shadow: 0 1vw 1vw rgba(255, 255, 255, 0);
        color: white;
        overflow: hidden; /* Åeritin kÃ¶ÅŸelerden taÅŸan kÄ±sÄ±mlarÄ±nÄ± gizle */
        line-height: 1.2;
        /* VarsayÄ±lan Ã§erÃ§eve kalÄ±nlÄ±ÄŸÄ± */
        border: 0.2vw solid #ccc;
        transition: border-color 0.5s ease;
        position: relative; /* Åerit iÃ§in zorunlu */
      }

      .durak {
        width: var(--durak-width, 80vw); /* JS'den gelen veya varsayÄ±lan deÄŸer */
        font-size: var(--durak-font-size, 4vw); /* JS'den gelen veya varsayÄ±lan deÄŸer */
      }

      /* Dinamik renk sÄ±nÄ±flarÄ± */
      .durak.hizli {
        border-color: #00ff00; /* YeÅŸil */
        border-width: 0.5vw;
      }

      .durak.orta {
        border-color: #ffff00; /* SarÄ± */
        border-width: 0.5vw;
      }

      .durak.yavas {
        border-color: #ff0000; /* KÄ±rmÄ±zÄ± */
        border-width: 0.5vw;
      }

      /* ------------------------------------------- */
      /* --- DÄ°YAGONAL ÅERÄ°T STÄ°LLERÄ° BAÅLANGIÃ‡ --- */
      /* --- YENÄ°: SOL ÃœST KÃ–ÅEDEN HAFÄ°F AÅAÄI KAYMIÅ ÅERÄ°T --- */
      /* ------------------------------------------- */
      
      .durak::after {
          position: absolute;
          font-family: 'Madimi One', sans-serif; /* Åeridi daha Ã§arpÄ±cÄ± gÃ¶stermek iÃ§in font */
          color: white;
          text-align: center;
          
          /* Diyagonal ÅŸerit ayarlarÄ± */
          width: 150%; 
          /* BurasÄ± gÃ¼ncellendi: Åeridi 2vw kadar aÅŸaÄŸÄ± kaydÄ±r */
          top: 2vw;      
          /* BurasÄ± gÃ¼ncellendi: Sol kenardan dÄ±ÅŸarÄ± taÅŸma miktarÄ±nÄ± ayarladÄ±k */
          left: -65%;  
          padding: 0.5vw 0;
          /* Åerit font boyutu: Min 10px, Tercih edilen 1.8vw, Max 18px */
          font-size: clamp(10px, 1.8vw, 18px);
          font-weight: 700;
          line-height: 1.2;
          transform: rotate(-45deg); /* Diyagonal eÄŸim (SOL ÃœSTTEN SAÄ ALTA) */
          z-index: 10;
          box-shadow: 0 0 1vw rgba(0, 0, 0, 0.5);
          text-shadow: 1px 1px 2px black;
          pointer-events: none; 
      }

      /* En HÄ±zlÄ± Åeridi */
      .durak.hizli::after {
          content: 'EN HIZLI';
          background-color: #00cc00; /* Parlak yeÅŸil ÅŸerit */
      }

      /* Orta HÄ±zlÄ± Åeridi */
      .durak.orta::after {
          content: 'ORTA HIZLI';
          background-color: #ffcc00; /* Parlak sarÄ± ÅŸerit */
      }

      /* En YavaÅŸ Åeridi */
      .durak.yavas::after {
          content: 'YAVAÅ';
          background-color: #ff3333; /* Parlak kÄ±rmÄ±zÄ± ÅŸerit */
      }

      /* KÃ¼Ã§Ã¼k ekranlar (Dikey mobil) iÃ§in ÅŸerit ayarÄ± optimizasyonu */
      @media (max-width: 600px) {
          .durak::after {
              /* BurasÄ± gÃ¼ncellendi: Mobil cihazlarda 15 piksel aÅŸaÄŸÄ± kaydÄ±r */
              top: 15px; 
              /* BurasÄ± gÃ¼ncellendi: Mobile Ã¶zgÃ¼ dÄ±ÅŸarÄ± taÅŸÄ±rma miktarÄ± */
              left: -55%; 
              font-size: 14px;
          }
      }
      /* ------------------------------------------- */
      /* --- DÄ°YAGONAL ÅERÄ°T STÄ°LLERÄ° BÄ°TÄ°Å --- */
      /* ------------------------------------------- */

      /* AraÃ§ listesi iÃ§in tablo stili */
      .vehicle-table {
        width: 100%;
        border-collapse: collapse; /* KenarlÄ±klarÄ± birleÅŸtir */
        margin-top: 0.5rem;
        font-size: inherit; /* YazÄ± tipi boyutunu parent elementten (durak) al */
      }

      .vehicle-table td {
        white-space: nowrap; /* Metnin satÄ±r atlamasÄ±nÄ± engelle */
        overflow: hidden; /* TaÅŸmayÄ± gizle */
        text-overflow: ellipsis; /* TaÅŸma durumunda Ã¼Ã§ nokta gÃ¶ster */
        padding: 0 0.2vw;
      }

      .vehicle-table .right-align {
        text-align: right;
      }

      /* Viewport Bilgi Kutusu */
      #viewport-info {
        position: fixed;
        top: 10px;
        left: 10px;
        padding: 8px 12px;
        background-color: transparent; /* BaÅŸlangÄ±Ã§ta ÅŸeffaf */
        color: transparent; /* BaÅŸlangÄ±Ã§ta ÅŸeffaf */
        font-family: 'Kode Mono', monospace;
        font-size: 0.8rem;
        border-radius: 5px;
        cursor: pointer;
        z-index: 1000;
        user-select: none;
        transition: color 0.3s ease, background-color 0.3s ease;
      }
      
      /* TÄ±klanabilir olduÄŸunda rengi biraz gÃ¶rÃ¼nÃ¼r yapma */
      #viewport-info:hover {
        background-color: rgba(0, 0, 0, 0.6);
        color: white;
      }

      /* Debug ButonlarÄ± iÃ§in Stiller */
      #debug-controls {
        position: fixed;
        bottom: 10px;
        right: 10px;
        background-color: rgba(0, 0, 0, 0.7);
        padding: 10px;
        border-radius: 8px;
        z-index: 1001;
        display: flex;
        flex-direction: column;
        gap: 8px;
        font-size: 0.9rem;
      }
      #debug-controls div {
        display: flex;
        align-items: center;
        gap: 5px;
      }
      #debug-controls button {
        width: 25px;
        height: 25px;
        font-weight: bold;
        cursor: pointer;
      }

    </style>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  </head>
  <body>
    <div id="debug-controls" style="display: none;">
      <div>
        <span>Merkez:</span>
        <button id="add-merkez">+</button>
        <button id="remove-merkez">-</button>
      </div>
      <div>
        <span>Metro:</span>
        <button id="add-metro">+</button>
        <button id="remove-metro">-</button>
      </div>
      <div>
        <span>SÃ¼vari:</span>
        <button id="add-suvari">+</button>
        <button id="remove-suvari">-</button>
      </div>
    </div>
    <div id="viewport-info"></div>
    <div class="content">
      <div id="main-container">
        <div class="updatetime-container">
          <!-- YÃ¼kleniyor simgesi -->
          <div id="loader" class="loader"></div>
          <!-- Son gÃ¼ncelleme zamanÄ± metni -->
          <div id="updatetime" style="display: none;"></div>
          <!-- GPS bilgi metni -->
          <div id="gps-info" style="display: none; margin-top: 0.5rem; color: #90EE90;"></div>
          <!-- Hava durumu bilgi metni -->
          <div id="weather-info" style="margin-top: 0.5rem; display: none;"></div>
          <!-- Hava durumu uyarÄ±sÄ± -->
          <div id="weather-warning" style="margin-top: 0.5rem; color: #FFD700; font-weight: bold; display: none;"></div>
        </div>
        <div id="duraklar-container" class="container">
          </div>
      </div>
    </div>
    <script>
      // --- Cihaz Engelleme KontrolÃ¼ ---
      // Bu fonksiyon, sayfanÄ±n geri kalanÄ± Ã§alÄ±ÅŸmadan Ã¶nce Ã§aÄŸrÄ±lÄ±r.
      (function() {
        // Engellenecek cihaz modellerini bu diziye ekleyebilirsiniz.
        const blockedModels = [];
        const userAgent = navigator.userAgent;

        // User agent'Ä±n engellenen modellerden herhangi birini iÃ§erip iÃ§ermediÄŸini kontrol et
        const isBlocked = blockedModels.some(model => userAgent.includes(model));

        if (isBlocked) {
          const blockedModelFound = blockedModels.find(model => userAgent.includes(model));
          // Sayfa iÃ§eriÄŸini temizle ve uyarÄ± mesajÄ± gÃ¶ster
          document.documentElement.innerHTML = `
            <head><title>Desteklenmiyor</title><meta name="viewport" content="width=device-width, initial-scale=1.0"></head>
            <body style="background-color: black; color: white; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; font-family: 'Kode Mono', monospace; text-align: center; padding: 20px;">
            </body>`;
          throw new Error("Desteklenmeyen cihaz modeli: " + blockedModelFound); // Script'in geri kalanÄ±nÄ±n Ã§alÄ±ÅŸmasÄ±nÄ± engelle
        }
      })();

      // Firebase yapÄ±landÄ±rma bilgileri
      const firebaseConfig = {
        apiKey: "AIzaSyCTTDvLsIY3ZS8zNP77lxLG0SdoOke2vLk",
        authDomain: "kptakip.firebaseapp.com",
        databaseURL: "https://kptakip-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "kptakip",
        storageBucket: "kptakip.firebasestorage.app",
        messagingSenderId: "401633293269",
        appId: "1:401633293269:web:8386edc126aafe1929435c"
      };
      // Firebase uygulamasÄ±nÄ± baÅŸlat
      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();
      const ref = database.ref('taksi_verileri');
      // ElemanlarÄ± seÃ§
      const mainContainer = document.getElementById('main-container');
      const duraklarContainer = document.getElementById('duraklar-container');
      const updateTimeElement = document.getElementById('updatetime');
      const loaderElement = document.getElementById('loader');
      const gpsInfoElement = document.getElementById('gps-info'); // GPS bilgi elementini seÃ§
      const viewportInfo = document.getElementById('viewport-info');
      const weatherInfoElement = document.getElementById('weather-info');
      const weatherWarningElement = document.getElementById('weather-warning');

      /**
       * Saniye cinsinden verilen sÃ¼reyi "Xgn Ysa Zdk Psn" formatÄ±na dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r.
       * @param {number} totalSeconds - Toplam saniye sÃ¼resi.
       * @returns {string} FormatlanmÄ±ÅŸ sÃ¼re metni.
       */
      function formatDuration(totalSeconds) {
        if (totalSeconds < 0) {
          totalSeconds = 0;
        }

        const days = Math.floor(totalSeconds / (24 * 60 * 60));
        const hours = Math.floor((totalSeconds % (24 * 60 * 60)) / (60 * 60));
        const minutes = Math.floor((totalSeconds % (60 * 60)) / 60);
        const seconds = totalSeconds % 60;

        const parts = [];
        if (days > 0) {
          parts.push(`${days}gn`);
        }
        if (hours > 0) {
          parts.push(`${hours}sa`);
        }
        if (minutes > 0) {
          parts.push(`${minutes}dk`);
        }
        parts.push(`${seconds}sn`);
        

        return parts.join(' ');
      }

      /**
       * Zaman birimini formatlar. EÄŸer deÄŸer 0 ise ve forceDisplayZero true deÄŸilse boÅŸ string dÃ¶ndÃ¼rÃ¼r.
       * Tek haneli deÄŸerler iÃ§in bir boÅŸluk ekler ve saÄŸa yaslar.
       * @param {number} value - Zaman biriminin deÄŸeri (gÃ¼n, saat, dakika, saniye).
       * @param {string} unit - Zaman biriminin kÄ±saltmasÄ± (Ã¶rn: 'gn', 'sa', 'dk', 'sn').
       * @param {boolean} [forceDisplayZero=false] - DeÄŸer 0 olsa bile gÃ¶sterilmesini zorlar.
       * @param {string} [padChar='&nbsp;'] - Tek haneli deÄŸerler iÃ§in kullanÄ±lacak dolgu karakteri.
       * @returns {string} DoldurulmuÅŸ ve hizalanmÄ±ÅŸ metin veya boÅŸ string.
       */
      function padTimeDisplay(value, unit, forceDisplayZero = false, padChar = '&nbsp;') {
        if (value === 0 && !forceDisplayZero) {
          return '';
        }
        // Tek haneli deÄŸerler iÃ§in bir boÅŸluk ekle
        if (value < 10 && value >= 0) {
          return `${padChar}${value}${unit}`;
        }
        return `${value}${unit}`;
      }

      /**
       * Hava durumu kodunu okunabilir bir metne Ã§evirir.
       * @param {number} code - Open-Meteo'dan gelen hava durumu kodu.
       * @returns {string} Hava durumu aÃ§Ä±klamasÄ±.
       */
      function getWeatherDescription(code) {
          const descriptions = {
              0: 'AÃ§Ä±k',
              1: 'ParÃ§alÄ± Bulutlu',
              2: 'ParÃ§alÄ± Bulutlu',
              3: 'Bulutlu',
              45: 'Sisli',
              48: 'Sisli',
              51: 'Ã‡iselemeli',
              53: 'Ã‡iselemeli',
              55: 'Ã‡iselemeli',
              56: 'Dondurucu Ã‡iseleme',
              57: 'Dondurucu Ã‡iseleme',
              61: 'YaÄŸmurlu',
              63: 'YaÄŸmurlu',
              65: 'Åiddetli YaÄŸmurlu',
              66: 'Dondurucu YaÄŸmur',
              67: 'Dondurucu YaÄŸmur',
              71: 'KarlÄ±',
              73: 'KarlÄ±',
              75: 'YoÄŸun KarlÄ±',
              77: 'Kar Taneleri',
              80: 'SaÄŸanak YaÄŸÄ±ÅŸlÄ±',
              81: 'SaÄŸanak YaÄŸÄ±ÅŸlÄ±',
              82: 'Åiddetli SaÄŸanak',
              95: 'GÃ¶k GÃ¼rÃ¼ltÃ¼lÃ¼',
              96: 'Dolulu',
              99: 'Dolulu'
          };
          return descriptions[code] || 'Bilinmiyor';
      }

      /**
       * Bornova, Ä°zmir iÃ§in hava durumu verilerini Ã§eker ve gÃ¶sterir.
       */
      async function fetchWeather() {
        try {
          const response = await fetch('https://api.open-meteo.com/v1/forecast?latitude=38.46&longitude=27.22&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Europe/Istanbul');
          const data = await response.json();
          
          const today = data.daily;
          const todayDesc = getWeatherDescription(today.weathercode[0]);
          const todayMin = Math.round(today.temperature_2m_min[0]);
          const todayMax = Math.round(today.temperature_2m_max[0]);
          const tomorrowDesc = getWeatherDescription(today.weathercode[1]);
          const tomorrowMin = Math.round(today.temperature_2m_min[1]);
          const tomorrowMax = Math.round(today.temperature_2m_max[1]);

          weatherInfoElement.textContent = `Bornova; BugÃ¼n: ${todayDesc} ${todayMin}-${todayMax}Â°C , YarÄ±n: ${tomorrowDesc} ${tomorrowMin}-${tomorrowMax}Â°C`;
          weatherInfoElement.style.display = 'block';

          // YarÄ±n yaÄŸmurluysa uyarÄ± gÃ¶sterme mantÄ±ÄŸÄ±
          const rainyWeatherCodes = [51, 53, 55, 61, 63, 65, 66, 67, 80, 81, 82]; // 95 (GÃ¶k GÃ¼rÃ¼ltÃ¼lÃ¼), 96/99 (Dolu) Ã§Ä±karÄ±ldÄ±
          const tomorrowCode = today.weathercode[1];

          if (rainyWeatherCodes.includes(tomorrowCode)) {
            weatherWarningElement.innerHTML = "âš ï¸ ğŸŒ§ï¸ AraÃ§larÄ±n bugÃ¼n yÄ±kanmamasÄ± Ã¶nerilir.";
            weatherWarningElement.style.display = 'block';
          } else {
            weatherWarningElement.style.display = 'none';
          }
        } catch (error) {
          console.error('Hava durumu verisi alÄ±namadÄ±:', error);
          weatherInfoElement.textContent = 'Hava durumu bilgisi alÄ±namadÄ±.';
          weatherInfoElement.style.display = 'block';
        }
      }

      function renderData(data) {
        // YÃ¼kleme simgesini gizle ve gÃ¼ncelleme metinlerini gÃ¶ster
        loaderElement.style.display = 'none';
        updateTimeElement.style.display = 'block';
        gpsInfoElement.style.display = 'block';

        // GÃ¼ncelleme zamanÄ±nÄ± ve GPS bilgi metnini ayarla
        updateTimeElement.textContent = `Son GÃ¼ncelleme: ${data.son_guncelleme}`;
        gpsInfoElement.textContent = "GPS sorunundan, 29 (5023) - 30 (7274) - 32 (6383) kodlu araÃ§lar burada gÃ¶rÃ¼nmez.";

        // Hava durumu verisini sadece ana veri yÃ¼klendikten sonra Ã§ek ve gÃ¶ster
        fetchWeather();

        // Dinamik font bÃ¼yÃ¼klÃ¼ÄŸÃ¼ sÄ±nÄ±flarÄ± iÃ§in stilleri dinamik olarak ekle
        // Bu, media query'lerdeki .font-size-large gibi sÄ±nÄ±flarÄ±n yerini alÄ±r
        const contentDiv = document.querySelector('.content');
        const aspectRatio = window.innerWidth / window.innerHeight;

        
        // Durak bilgilerini iÅŸle
        duraklarContainer.innerHTML = '';
        const duraklar = data.duraklar;
        const durak_names = {
          suvari: "SÃ¼vari",
          merkez: "Merkez",
          metro: "Metro"
        };
        
        // DuraklarÄ± belirli bir sÄ±rada oluÅŸtur
        const orderedDuraks = ['merkez', 'metro', 'suvari'];
        
        // Ortalama kalkÄ±ÅŸ sÃ¼relerini topla ve sÄ±rala
        const averageTimes = orderedDuraks.map(key => ({
            key,
            time: duraklar[key].ortalama_kalkis
        })).sort((a, b) => a.time - b.time);

        // En hÄ±zlÄ±, orta ve en yavaÅŸ duraklarÄ± belirle
        const fastest = averageTimes[0].key;
        const middle = averageTimes[1].key;
        const slowest = averageTimes[2].key;

        // --- YENÄ° ORANTISAL YÃœKSEKLÄ°K HESAPLAMA MANTIÄI ---
        // 1. TÃ¼m duraklardaki araÃ§ sayÄ±larÄ±nÄ± al
        const vehicleCounts = {
            merkez: duraklar.merkez.liste ? duraklar.merkez.liste.length : 0,
            metro: duraklar.metro.liste ? duraklar.metro.liste.length : 0,
            suvari: duraklar.suvari.liste ? duraklar.suvari.liste.length : 0,
        };
        const totalVehicles = vehicleCounts.merkez + vehicleCounts.metro + vehicleCounts.suvari;

        // 2. Dikey dÃ¼zen iÃ§in genel ayarlarÄ± yap
        gpsInfoElement.style.minHeight = '6.4vh'; // 58/908

        // Her bir durak iÃ§in ayrÄ± ayrÄ± hizalama uzunluÄŸunu belirle
        orderedDuraks.forEach(key => {
            if (duraklar.hasOwnProperty(key)) {
                const durak = duraklar[key];
                const durakDiv = document.createElement('div');
                durakDiv.className = 'durak';
                
                // HÄ±z durumuna gÃ¶re sÄ±nÄ±f ekle
                if (key === fastest) {
                    durakDiv.classList.add('hizli');
                } else if (key === middle) {
                    durakDiv.classList.add('orta');
                } else if (key === slowest) {
                    durakDiv.classList.add('yavas');
                }
                
                let htmlContent = '';
                
                // BaÅŸlÄ±k satÄ±rÄ±
                htmlContent += `${durak_names[key]} (${durak.liste ? durak.liste.length : 0})<br>`;
                
                // Ortalama kalkÄ±ÅŸ satÄ±rÄ±
                const formattedAverageDeparture = formatDuration(durak.ortalama_kalkis);
                htmlContent += `Ortalama KalkÄ±ÅŸ: ${formattedAverageDeparture}<br>`;

                // AyÄ±rÄ±cÄ± Ã§izgi
                htmlContent += `â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”<br>`;
                
                const aracListesi = durak.liste || [];
                const aracSayisi = aracListesi.length;

                // --- YENÄ° STÄ°L MANTIÄI ---
                // Genel container stilleri sadece bir kez ayarlanÄ±r
                if (!duraklarContainer.style.flexDirection || !duraklarContainer.style.flexDirection.includes('column') && aspectRatio < 1.1) {
                  // Dikey ve kareye yakÄ±n dÃ¼zenler
                  if (aspectRatio < 1.1) { 
                    duraklarContainer.style.flexDirection = 'column';
                    duraklarContainer.style.alignItems = 'center';
                    duraklarContainer.style.paddingTop = '2vh';
                    duraklarContainer.style.gap = '2.4vh'; // 18px / 754px
                  } else { // Yatay dÃ¼zenler
                    duraklarContainer.style.flexDirection = 'row';
                    duraklarContainer.style.justifyContent = 'center';
                    duraklarContainer.style.marginTop = '2%';
                    duraklarContainer.style.alignItems = 'flex-start'; // ElemanlarÄ±n uzamasÄ±nÄ± engelle, yukarÄ± hizala.
                    duraklarContainer.style.gap = '2vw';
                  }
                }

                // --- AKIÅKAN FORMÃœL Ä°LE STÄ°L HESAPLAMA ---
                
                // 1. AkÄ±ÅŸkan Font Boyutu: Ekran daraldÄ±kÃ§a (aspectRatio kÃ¼Ã§Ã¼ldÃ¼kÃ§e) font bÃ¼yÃ¼r.
                const fluidFontSize = `clamp(1.4vw, ${2 / aspectRatio}vw, 4.5vw)`;
                
                // 2. AkÄ±ÅŸkan GeniÅŸlik: Ekran daraldÄ±kÃ§a geniÅŸlik artar.
                const fluidWidth = `clamp(30vw, ${50 / aspectRatio}vw, 85vw)`;

                // 3. Hesaplanan deÄŸerleri CSS deÄŸiÅŸkenleri olarak ata
                durakDiv.style.setProperty('--durak-font-size', fluidFontSize);
                durakDiv.style.setProperty('--durak-width', fluidWidth);

                // 4. Dikey/Yatay dÃ¼zene gÃ¶re flex-grow ve height ayarla
                if (aspectRatio < 1.1) { // Dikey DÃ¼zen
                  durakDiv.style.height = 'auto';
                  let flexGrowValue = 1;
                  if (totalVehicles > 0) {
                    flexGrowValue = 1 + (vehicleCounts[key] / totalVehicles) * 10;
                  }
                  durakDiv.style.flexGrow = flexGrowValue.toFixed(2);
                } else { // Yatay DÃ¼zen
                  // Yatayda yÃ¼kseklik araÃ§ sayÄ±sÄ±yla orantÄ±lÄ± olsun.
                  const baseHeightVh = 15; // BaÅŸlÄ±k vb. iÃ§in temel yÃ¼kseklik.
                  const heightPerVehicleVh = 3; // Her araÃ§ satÄ±rÄ± iÃ§in ek yÃ¼kseklik.
                  const totalHeight = baseHeightVh + (aracSayisi * heightPerVehicleVh);

                  durakDiv.style.height = 'auto'; // YÃ¼ksekliÄŸin iÃ§eriÄŸe gÃ¶re doÄŸal olarak bÃ¼yÃ¼mesine izin ver.
                  durakDiv.style.minHeight = `${totalHeight}vh`; // Ancak en azÄ±ndan hesaplanan kadar yer kaplamasÄ±nÄ± saÄŸla.
                  durakDiv.style.maxHeight = '80vh'; // EkranÄ± taÅŸmasÄ±nÄ± Ã¶nlemek iÃ§in maksimum yÃ¼kseklik.
                  durakDiv.style.flexGrow = '0'; // Yatayda esnemesin
                }

                // updatetime ve gpsinfo font boyutlarÄ±nÄ± duraklarla eÅŸitle
                updateTimeElement.style.fontSize = fluidFontSize;
                gpsInfoElement.style.fontSize = fluidFontSize;

                // AraÃ§ listesi
                if (aracSayisi > 0) {
                    htmlContent += '<table class="vehicle-table"><tbody>';
                    aracListesi.forEach((arac, index) => {
                        const totalSeconds = arac.entry_duration;
                        const days = Math.floor(totalSeconds / (24 * 60 * 60));
                        const hours = Math.floor((totalSeconds % (24 * 60 * 60)) / (60 * 60));
                        const minutes = Math.floor((totalSeconds % (60 * 60)) / 60);
                        const seconds = totalSeconds % 60;

                        const showDays = aracListesi.some(a => a.entry_duration >= 86400);
                        const showHours = aracListesi.some(a => a.entry_duration >= 3600);
                        const showMinutes = aracListesi.some(a => a.entry_duration >= 60);

                        htmlContent += `<tr>`;
                        htmlContent += `<td>${index + 1})</td>`;
                        htmlContent += `<td>${arac.code}</td>`;
                        htmlContent += `<td>${arac.plate}</td>`;
                        
                        if (showDays && days > 0) { // GÃ¼n 0 ise gÃ¶sterme
                            htmlContent += `<td class="right-align">${padTimeDisplay(days, 'gn')}</td>`;
                        }
                        if (showHours) {
                            htmlContent += `<td class="right-align">${padTimeDisplay(hours, 'sa')}</td>`; // Saat 0 ise gÃ¶sterme
                            htmlContent += `<td class="right-align">${padTimeDisplay(minutes, 'dk')}</td>`; // Dakika 0 ise gÃ¶sterme
                            htmlContent += `<td class="right-align">${padTimeDisplay(seconds, 'sn', true)}</td>`; // Saniye her zaman gÃ¶ster
                        } else if (showMinutes) {
                            htmlContent += `<td class="right-align">${padTimeDisplay(minutes, 'dk')}</td>`; // Dakika 0 ise gÃ¶sterme
                            htmlContent += `<td class="right-align">${padTimeDisplay(seconds, 'sn', true)}</td>`; // Saniye her zaman gÃ¶ster
                        } else {
                            htmlContent += `<td class="right-align">${padTimeDisplay(seconds, 'sn', true)}</td>`; // Saniye her zaman gÃ¶ster
                        }
                        
                        htmlContent += `</tr>`;
                    });
                    htmlContent += '</tbody></table>';
                } else {
                    htmlContent += 'BoÅŸ';
                }
                
                durakDiv.innerHTML = htmlContent;
                duraklarContainer.appendChild(durakDiv);
            }
        });
      }

      // --- DEBUG MODU ---
      // Test verilerini kullanmak iÃ§in `true`, gerÃ§ek zamanlÄ± Firebase verilerini kullanmak iÃ§in `false` yapÄ±n.
      const DEBUG_MODE = false; 

      if (DEBUG_MODE) {
        // --- DEBUG MODU Ä°Ã‡Ä°N KONTROL VE VERÄ° YAPISI ---

        // 1. ButonlarÄ± ve kontrol panelini gÃ¶rÃ¼nÃ¼r yap
        const debugControls = document.getElementById('debug-controls');
        const STORAGE_KEY = 'debugVehicleState';
        debugControls.style.display = 'flex';

        // Viewport bilgisini gÃ¶rÃ¼nÃ¼r yap
        const viewportInfoDiv = document.getElementById('viewport-info');
        viewportInfoDiv.style.backgroundColor = 'rgba(0, 0, 0, 0.6)';
        viewportInfoDiv.style.color = 'white';

        // 2. TÃ¼m olasÄ± araÃ§larÄ± iÃ§eren bir havuz oluÅŸtur
        const allVehicles = [
            { code: "21", plate: "35T7575" }, { code: "22", plate: "35T5702" },
            { code: "23", plate: "35T6619" }, { code: "24", plate: "35T7734" },
            { code: "25", plate: "35T5595" }, { code: "26", plate: "35T6913" },
            { code: "27", plate: "35T6581" }, { code: "28", plate: "35T6272" },
            { code: "29", plate: "35T5023" }, { code: "30", plate: "35T7274" },
            { code: "32", plate: "35T6383" }, { code: "33", plate: "35T7623" },
            { code: "34", plate: "35T6975" }, { code: "35", plate: "35T5601" },
            { code: "36", plate: "35T7812" }, { code: "37", plate: "35T5071" }
        ];

        // 3. localStorage'dan kayÄ±tlÄ± durumu yÃ¼kle veya baÅŸlangÄ±Ã§ verisini oluÅŸtur
        const savedState = localStorage.getItem(STORAGE_KEY);
        const initialDuraklarState = savedState ? JSON.parse(savedState) : {
            merkez: { liste: [], ortalama_kalkis: 6200 },
            metro: { liste: [], ortalama_kalkis: 950 },
            suvari: { liste: [{ code: "27", plate: "35T6581", entry_duration: 40 }], ortalama_kalkis: 40 }
        };

        const mockData = {
          son_guncelleme: "18.09.2023 | 10:00:00 (Test Verisi)",
          duraklar: initialDuraklarState
        };

        // 4. Butonlara olay dinleyicileri ekle
        document.getElementById('add-merkez').addEventListener('click', () => addVehicle('merkez'));
        document.getElementById('remove-merkez').addEventListener('click', () => removeVehicle('merkez'));
        document.getElementById('add-metro').addEventListener('click', () => addVehicle('metro'));
        document.getElementById('remove-metro').addEventListener('click', () => removeVehicle('metro'));
        document.getElementById('add-suvari').addEventListener('click', () => addVehicle('suvari'));
        document.getElementById('remove-suvari').addEventListener('click', () => removeVehicle('suvari'));

        function saveState() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(mockData.duraklar));
        }

        function getTotalVehicleCount() {
            return mockData.duraklar.merkez.liste.length + 
                    mockData.duraklar.metro.liste.length + 
                    mockData.duraklar.suvari.liste.length;
        }

        function addVehicle(durakKey) {
            if (mockData.duraklar[durakKey].liste.length >= 10) {
                // Not: alert() yerine daha iyi bir yÃ¶ntem kullanÄ±lmalÄ±dÄ±r, ancak debug iÃ§in kabul edilebilir.
                console.error("Bu duraÄŸa daha fazla araÃ§ eklenemez (maksimum 10)!");
                return;
            }

            if (getTotalVehicleCount() >= 16) {
                console.error("Toplam araÃ§ sayÄ±sÄ± 16'yÄ± geÃ§emez!");
                return;
            }
            
            // HenÃ¼z duraklarda olmayan bir araÃ§ bul
            const assignedPlates = [...mockData.duraklar.merkez.liste, ...mockData.duraklar.metro.liste, ...mockData.duraklar.suvari.liste].map(v => v.plate);
            const availableVehicle = allVehicles.find(v => !assignedPlates.includes(v.plate));

            if (availableVehicle) {
                // Rastgele bir bekleme sÃ¼resi ekle
                const newVehicle = { ...availableVehicle, entry_duration: Math.floor(Math.random() * 10000) };
                mockData.duraklar[durakKey].liste.push(newVehicle);
                saveState(); // Durumu localStorage'a kaydet
                renderData(mockData); // ArayÃ¼zÃ¼ gÃ¼ncelle
            }
        }

        function removeVehicle(durakKey) {
            if (mockData.duraklar[durakKey].liste.length > 0) {
                mockData.duraklar[durakKey].liste.pop(); // Son aracÄ± sil
                saveState(); // Durumu localStorage'a kaydet
                renderData(mockData); // ArayÃ¼zÃ¼ gÃ¼ncelle
            } else {
                console.error(`${durakKey} duraÄŸÄ±nda silinecek araÃ§ yok.`);
            }
        }

        // 5. Sayfa ilk yÃ¼klendiÄŸinde boÅŸ veri ile render et
        renderData(mockData); 

      } else {
        // VeritabanÄ± referansÄ±ndaki veriyi dinle (DEBUG_MODE = false ise Ã§alÄ±ÅŸÄ±r)
        ref.on('value', (snapshot) => {
          const data = snapshot.val();
          if (data && data.duraklar) {
            renderData(data);
          } else {
            console.error("Veri alÄ±namadÄ± veya 'duraklar' anahtarÄ± bulunamadÄ±.");
            duraklarContainer.innerHTML = '<p style="color:red; text-align:center;">Veri alÄ±namadÄ±. LÃ¼tfen Python betiÄŸinin Ã§alÄ±ÅŸtÄ±ÄŸÄ±ndan emin olun.</p>';
          }
        }, (error) => {
          console.error("Veri okuma hatasÄ±: ", error);
          duraklarContainer.innerHTML = '<p style="color:red; text-align:center;">Veri okuma hatasÄ± oluÅŸtu. Konsolu kontrol edin.</p>';
        });
      }

      // Viewport bilgisi fonksiyonlarÄ±
      function updateViewportInfo() {
        const width = window.innerWidth;
        const height = window.innerHeight;
        // En/Boy oranÄ±nÄ± hesapla ve 2 ondalÄ±k basamaÄŸa yuvarla
        const aspectRatio = (width / height).toFixed(2);
        viewportInfo.textContent = `Viewport: ${width}x${height} | En/Boy OranÄ±: ${aspectRatio} w/h`;
      }
      
      // Viewport bilgisi div'ine tÄ±klama olayÄ± ekle
      viewportInfo.onclick = function() {
        const textToCopy = this.textContent;
        const tempTextArea = document.createElement('textarea');
        tempTextArea.value = textToCopy;
        document.body.appendChild(tempTextArea);
        tempTextArea.select();
        document.execCommand('copy');
        document.body.removeChild(tempTextArea);
        
        this.textContent = 'KopyalandÄ±!';
        // Kopyalama mesajÄ± gÃ¶rÃ¼nÃ¼r hale getirildi
        this.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
        this.style.color = 'white';

        setTimeout(() => {
            // MesajÄ± eski haline dÃ¶ndÃ¼r
            updateViewportInfo();
            this.style.backgroundColor = 'transparent';
            this.style.color = 'rgba(0, 0, 0, 0)';
        }, 1000);
      };

      // Sayfa yÃ¼klendiÄŸinde ve pencere yeniden boyutlandÄ±rÄ±ldÄ±ÄŸÄ±nda tÃ¼m ayarlarÄ± yap
      window.addEventListener('load', () => {
          // Ä°lk yÃ¼klemede viewport bilgisini gÃ¼ncelle
          updateViewportInfo();
      });

      // Pencere boyutu deÄŸiÅŸtiÄŸinde viewport bilgisini gÃ¼ncelle
      window.addEventListener('resize', () => {
        updateViewportInfo();
        // Veriyi yeniden render etmek iÃ§in, mevcut veriyi bir deÄŸiÅŸkende saklayÄ±p onu kullanabiliriz
        // veya basitÃ§e sayfayÄ± yeniden yÃ¼kleyebiliriz. Åimdilik yeniden yÃ¼kleme daha basit.
        location.reload();
      });
    </script>
  </body>
</html>
