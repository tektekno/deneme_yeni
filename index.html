<!DOCTYPE html>
<html lang="tr">
  <head>
    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-4Y5K6S0S87"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-4Y5K6S0S87");
    </script>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes"
    />

    <title>Duraklara GÃ¶re SÄ±ralama</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Kode+Mono:wght@400..700&family=Madimi+One&family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Genel ayarlar */
      body {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        height: 100vh;
        width: 100vw;
        background-color: black;
        color: white;
        font-family: "Kode Mono", monospace;
        overflow: hidden;
      }

      /* --- YENÄ°: Terminal Penceresi Stilleri --- */
      #terminal-window {
        border-top: 2px solid #8b5151;
        border-left: 5px solid #8b5151;
        border-right: 5px solid #8b5151;
        border-bottom: 5px solid #8b5151;
        border-radius: 8px;
        background-color: #0d0d0d;
        box-shadow: 0 0 20px rgba(0, 255, 65, 0.2);
        width: 99.2vw; /* Tam geniÅŸlik */
        height: 99.9vh; /* Tam yÃ¼kseklik */
        display: flex;
        flex-direction: column;
        position: relative; /* YENÄ°: Ä°Ã§indeki absolute konumlandÄ±rÄ±lmÄ±ÅŸ elementler iÃ§in referans noktasÄ± olur. */
        overflow: hidden;
      }

      #title-bar {
        background-color: #8b5151;
        padding: 5px 10px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid #555;
        user-select: none;
      }

      #title-bar .title {
        color: #ddd;
        font-weight: bold;
      }

      #title-bar .buttons span {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-left: 8px;
      }

      /* YENÄ°: Tam Ekran Butonu */
      #fullscreen-btn {
        color: #00ff41; /* YENÄ°: Rengi belirgin yeÅŸil yapÄ±ldÄ± */
        cursor: pointer;
        font-size: 24px; /* YENÄ°: Boyutu bÃ¼yÃ¼tÃ¼ldÃ¼ */
        padding: 0 10px; /* YENÄ°: TÄ±klama alanÄ± geniÅŸletildi */
        user-select: none;
        text-shadow: 0 0 3px #00ff41; /* YENÄ°: Hafif parlama eklendi */
        transition: color 0.2s, text-shadow 0.2s; /* YENÄ°: GeÃ§iÅŸ efekti eklendi */
      }

      #fullscreen-btn:hover {
        color: #8aff8a; /* YENÄ°: Ãœzerine gelince daha parlak yeÅŸil */
        text-shadow: 0 0 8px #00ff41; /* YENÄ°: Parlama artÄ±rÄ±ldÄ± */
      }
      /* --- BitiÅŸ: Terminal Penceresi Stilleri --- */

      /* TÃ¼m iÃ§eriÄŸi kapsayan container */
      .content {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center; /* TÃ¼m iÃ§eriÄŸi dikeyde ortala */
        width: 100%;
        height: 100%;
      }

      #main-container {
        display: flex;
        flex-direction: column;
        width: 100%;
        flex-grow: 1; /* Terminal penceresinde kalan boÅŸluÄŸu doldurmasÄ± iÃ§in */
        overflow-y: auto; /* GerektiÄŸinde kaydÄ±rma Ã§ubuÄŸu */
        padding: 0 2vw 5vh 2vw; /* YENÄ°: Alttan %5'lik boÅŸluk eklendi */
        box-sizing: border-box; /* Padding'in geniÅŸliÄŸe dahil edilmesini saÄŸla */
      }

      /* GÃ¼ncelleme yazÄ±sÄ± ve yÃ¼kleme simgesi iÃ§in container */
      .updatetime-container {
        text-align: center;
        font-size: 1.2rem;
        padding-top: 1vh; /* Ãœstten kÃ¼Ã§Ã¼k bir boÅŸluk */
      }

      /* YÃ¼kleme Simgesi */
      .loader {
        border: 4px solid #f3f3f3; /* AÃ§Ä±k gri */
        border-top: 4px solid #3498db; /* Mavi */
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 2s linear infinite;
        margin: 0 auto;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* DuraklarÄ± iÃ§eren container */
      .container {
        display: flex;
        flex-wrap: nowrap;
        width: 100%;
        justify-content: center;
        margin-top: 2vh; /* Bilgi tablosu ile araya boÅŸluk ekler */
        margin-bottom: 2vh; /* YENÄ°: Komut satÄ±rÄ± ile araya boÅŸluk ekler */
      }

      /* Durak kutularÄ± */
      .durak {
        padding: 1vh 2vw;
        text-align: center;
        background-color: #1a1a1a; /* KutularÄ± arka plandan ayÄ±rmak iÃ§in */
        color: white;
        overflow: hidden; /* Åeritin kÃ¶ÅŸelerden taÅŸan kÄ±sÄ±mlarÄ±nÄ± gizle */
        line-height: 1.2;
        border: 2px dashed #888; /* Kesikli Ã§izgi Ã§erÃ§eve */
        transition: border-color 0.5s ease;
        position: relative; /* Åerit iÃ§in zorunlu */
      }

      .durak {
        width: var(
          --durak-width,
          80vw
        ); /* JS'den gelen veya varsayÄ±lan deÄŸer */
        font-size: var(
          --durak-font-size,
          4vw
        ); /* JS'den gelen veya varsayÄ±lan deÄŸer */
      }

      /* Dinamik renk sÄ±nÄ±flarÄ± */
      .durak.hizli {
        border-color: #00ff41;
        box-shadow: 0 0 5px #00ff41;
        text-shadow: 0 0 2px #00ff41;
      }

      .durak.orta {
        border-color: #ffc800;
        box-shadow: 0 0 5px #ffc800;
        text-shadow: 0 0 2px #ffc800;
      }

      .durak.yavas {
        border-color: #ff0000;
        box-shadow: 0 0 5px #ff0000;
        text-shadow: 0 0 2px #ff0000;
      }

      /* ------------------------------------------- */
      /* --- DÄ°YAGONAL ÅERÄ°T STÄ°LLERÄ° BAÅLANGIÃ‡ --- */
      /* --- YENÄ° GÃœNCELLEME: DAHA AÅAÄI KONUMLANDIRMA VE KÃœÃ‡ÃœK YAZI BOYUTU --- */
      /* ------------------------------------------- */

      .durak::after {
        position: absolute;
        font-family: "Madimi One", sans-serif; /* Åeridi daha Ã§arpÄ±cÄ± gÃ¶stermek iÃ§in font */
        color: white;

        /* YAZI ORTALAMASI */
        display: flex;
        justify-content: center; /* Yatayda ortala */
        align-items: center; /* Dikeyde ortala */

        /* Diyagonal ÅŸerit ayarlarÄ± */
        width: 160%;
        top: 1.5vw; /* YENÄ°: Åeridin dikey konumunu yukarÄ± Ã§ekti. */
        left: -75%; /* YENÄ°: Åeridin yatay konumunu sola Ã§ekti. */
        padding: 0.5vw 0;
        font-size: clamp(
          9px,
          1.6vw,
          16px
        ); /* <--- YENÄ° GÃœNCELLEME: Genel font boyutu kÃ¼Ã§Ã¼ltÃ¼ldÃ¼. */
        font-weight: 700;
        line-height: 1.2;
        transform: rotate(-45deg); /* Diyagonal eÄŸim (SOL ÃœSTTEN SAÄ ALTA) */
        z-index: 10;
        box-shadow: 0 0 1vw rgba(0, 0, 0, 0.5);
        text-shadow: 1px 1px 2px black;
        pointer-events: none;
      }

      /* En HÄ±zlÄ± Åeridi */
      .durak.hizli::after {
        content: "HIZLI";
        background-color: #00cc00; /* Parlak yeÅŸil ÅŸerit */
      }

      /* Orta HÄ±zlÄ± Åeridi */
      .durak.orta::after {
        content: "ORTA";
        background-color: #ffcc00; /* Parlak sarÄ± ÅŸerit */
      }

      /* En YavaÅŸ Åeridi */
      .durak.yavas::after {
        content: "YAVAÅ";
        background-color: #ff3333; /* Parlak kÄ±rmÄ±zÄ± ÅŸerit */
      }

      /* KÃ¼Ã§Ã¼k ekranlar (Dikey mobil) iÃ§in ÅŸerit ayarÄ± optimizasyonu */
      @media (max-width: 600px) {
        .durak::after {
          top: 20px; /* <--- YENÄ° GÃœNCELLEME: Mobilde daha da aÅŸaÄŸÄ± (iÃ§eri) indirildi. */
          left: -70%;
          font-size: 13px; /* <--- YENÄ° GÃœNCELLEME: Mobildeki font boyutu kÃ¼Ã§Ã¼ltÃ¼ldÃ¼. */
        }
      }
      /* ------------------------------------------- */
      /* --- DÄ°YAGONAL ÅERÄ°T STÄ°LLERÄ° BÄ°TÄ°Å --- */
      /* ------------------------------------------- */

      /* Bilgi Tablosu Stilleri */
      #info-table {
        width: var(--durak-width, 85vw); /* GeniÅŸliÄŸi duraklarla aynÄ± yapar */
        max-width: 96%; /* EkranÄ±n kenarlarÄ±na yapÄ±ÅŸmasÄ±nÄ± Ã¶nle */
        margin: 0 auto;
        border-collapse: collapse;
        font-size: clamp(
          10px,
          1.8vw,
          16px
        ); /* YENÄ°: AkÄ±ÅŸkan font boyutu (yatay iÃ§in kÃ¼Ã§Ã¼ltÃ¼ldÃ¼) */
        line-height: 1.4;
        border: 2px dashed #888; /* Kesikli Ã§izgi Ã§erÃ§eve */
        box-shadow: 0 0 5px #888;
      }

      /* SatÄ±r Renkleri */
      #info-table tr:nth-child(1) {
        color: #c8a2c8;
        text-shadow: 0 0 3px #c8a2c8;
      } /* AÃ§Ä±k Mor */
      #info-table tr:nth-child(2) {
        color: #ffc085;
        text-shadow: 0 0 3px #ffc085;
      } /* AÃ§Ä±k Turuncu */
      #info-table tr:nth-child(3) {
        color: #ff8c8c;
        text-shadow: 0 0 3px #ff8c8c;
      } /* AÃ§Ä±k KÄ±rmÄ±zÄ± */
      #info-table tr:nth-child(4) {
        color: #87ceeb;
        text-shadow: 0 0 3px #87ceeb;
      } /* AÃ§Ä±k Mavi */
      @media (min-aspect-ratio: 1.1) {
        #info-table {
          width: 100%;
          max-width: 800px;
        }
      }

      #info-table .info-key {
        text-align: left;
        padding-right: 1em;
        white-space: nowrap;
        font-weight: bold;
      }

      #info-table .info-value {
        text-align: left;
        font-weight: bold;
      }

      /* AraÃ§ listesi iÃ§in tablo stili */
      .vehicle-table {
        width: 100%;
        border-collapse: collapse; /* KenarlÄ±klarÄ± birleÅŸtir */
        margin-top: 0.5rem;
        font-size: inherit; /* YazÄ± tipi boyutunu parent elementten (durak) al */
      }

      .vehicle-table td {
        white-space: nowrap; /* Metnin satÄ±r atlamasÄ±nÄ± engelle */
        overflow: hidden; /* TaÅŸmayÄ± gizle */
        text-overflow: ellipsis; /* TaÅŸma durumunda Ã¼Ã§ nokta gÃ¶ster */
        padding: 0 0.2vw;
      }

      .vehicle-table .right-align {
        text-align: right;
      }

      /* AyÄ±rÄ±cÄ± Ã‡izgi Stilleri */
      .separator-line {
        border: none;
        border-top: 1px dashed #555; /* Dijital ayÄ±rÄ±cÄ± Ã§izgi */
        width: 100%;
        margin: 0.5rem 0;
      }

      .sub-separator-line {
        border: none;
        border-top: 1px dashed #444; /* Daha soluk alt ayÄ±rÄ±cÄ± */
        width: 100%;
        margin: 0.3rem 0;
      }

      /* Debug ButonlarÄ± iÃ§in Stiller */
      #debug-controls {
        position: fixed;
        bottom: 10px;
        right: 10px;
        background-color: rgba(0, 0, 0, 0.7);
        padding: 10px;
        border-radius: 8px;
        z-index: 1001;
        display: flex;
        flex-direction: column;
        gap: 8px;
        font-size: 0.9rem;
      }
      #debug-controls div {
        display: flex;
        align-items: center;
        gap: 5px;
      }
      #debug-controls button {
        width: 25px;
        height: 25px;
        font-weight: bold;
        cursor: pointer;
      }

      .metal-effect {
        font-weight: bold;
        color: #9e9e9e; /* YENÄ°: Daha koyu ve net gri */
        text-shadow: none !important; /* YENÄ°: DiÄŸer satÄ±r stillerinden gelen gÃ¶lgeyi sÄ±fÄ±rlar */
        background: linear-gradient(
          90deg,
          #9e9e9e 48%,
          #ffffff 50%,
          #9e9e9e 52%
        );
        background-size: 300% 100%;
        background-position: 150% 0;
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: metal-shine 3s linear infinite;
        animation: metal-shine 5s linear infinite;
        filter: drop-shadow(0 0 2px rgba(255, 255, 255, 0.3));
      }

      @keyframes metal-shine {
        0% {
          background-position: 150% 0; /* BaÅŸlangÄ±Ã§ pozisyonu (saÄŸda) */
        }
        100% {
          background-position: -150% 0; /* BitiÅŸ pozisyonu (solda) */
        }
      }

      /* Ses kontrol ikonu */
      .speaker-icon {
        position: absolute;
        top: 1vh;
        right: 2vw;
        font-size: clamp(14px, 3vw, 24px);
        cursor: pointer;
        user-select: none; /* Ä°konun seÃ§ilmesini engelle */
      }

      /* Intro EkranÄ± */
      #intro-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #000;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        cursor: default; /* Ä°mleci normal yap */
        transition: opacity 0.5s ease-out;
      }
      .intro-content {
        text-align: center;
        color: white;
      }
      .intro-content h1 {
        font-size: clamp(24px, 8vw, 48px);
        margin-bottom: 10px;
      }
      .intro-button {
        /* Matrix stili */
        margin-top: 30px;
        padding: 12px 28px;
        font-size: clamp(16px, 4vw, 22px);
        font-family: "Kode Mono", monospace;
        color: #00ff41;
        background-color: transparent;
        border: 2px solid #00ff41; /* KÃ¶ÅŸeli buton */
        cursor: pointer;
        text-shadow: 0 0 5px #00ff41, 0 0 10px #00ff41;
        box-shadow: 0 0 5px #00ff41, inset 0 0 5px #00ff41;
        transition: text-shadow 0.3s, box-shadow 0.3s;
      }
      .intro-button:hover {
        /* Ãœzerine gelince parlamayÄ± artÄ±r */
        text-shadow: 0 0 10px #00ff41, 0 0 20px #00ff41;
        box-shadow: 0 0 10px #00ff41, inset 0 0 10px #00ff41;
      }

      #matrix-canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 1; /* DÃ¼ÅŸÃ¼k opaklÄ±k */
        z-index: 0; /* Ä°Ã§eriÄŸin arkasÄ±nda kalmasÄ± iÃ§in */
      }

      /* YanÄ±p SÃ¶nen Ä°mleÃ§ Stili */
      #global-cursor {
        position: absolute;
        width: 8px;
        height: 1.2em; /* SatÄ±r yÃ¼ksekliÄŸine benzer */
        background-color: #00ff41;
        animation: blink 1.2s step-end infinite;
        z-index: 1000;
        display: none; /* BaÅŸlangÄ±Ã§ta gizli */
        pointer-events: none; /* Ä°mlecin tÄ±klama olaylarÄ±nÄ± engellememesi iÃ§in */
        transform: translateY(-10%);
        /* AkÄ±cÄ± JS kontrolÃ¼ iÃ§in CSS transition kaldÄ±rÄ±ldÄ± */
      }

      /* YENÄ°: PWD iÃ§indeki metin imleci */
      .blinking-cursor {
        color: #00ff41;
        animation: blink 1.2s step-end infinite;
      }

      @keyframes blink {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0;
        }
      }

      /* --- YENÄ°: Yatay Mod DÃ¼zeni --- */
      @media (orientation: landscape) {
        #main-container {
          overflow-y: hidden; /* Yatayda kaydÄ±rma Ã§ubuÄŸunu gizle */
        }
        #duraklar-container {
          flex-direction: row;
          align-items: stretch; /* Ã‡ocuklarÄ±n (duraklarÄ±n) yÃ¼ksekliÄŸini eÅŸitler */
          flex-grow: 0.9; /* YENÄ°: Altta komut satÄ±rÄ±na yer aÃ§mak iÃ§in biraz kÃ¼Ã§Ã¼ltÃ¼ldÃ¼ */
          gap: 1vw;
        }
        .durak {
          flex: 1; /* EÅŸit geniÅŸlikte yer kapla */
        }
      }

      /* --- YENÄ°: Kayan Trafik BandÄ± Stilleri --- */
      #traffic-banner-container {
        width: 100%;
        overflow: hidden;
        background-color: #111;
        margin: 2vh 0;
        white-space: nowrap;
        box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.5);
        border-top: 1px solid #444;
        border-bottom: 1px solid #444;
      }

      #traffic-banner-content {
        display: inline-block;
        padding-left: 100%; /* Animasyonun ekran dÄ±ÅŸÄ±ndan baÅŸlamasÄ±nÄ± saÄŸlar */
        animation: scroll-traffic 45s linear infinite;
      }

      .traffic-item {
        display: inline-block;
        padding: 4px 12px;
        font-size: clamp(12px, 1.6vw, 16px);
      }

      .traffic-item:nth-child(odd) {
        background-color: hsl(0, 0%, 46%);
      }
      .traffic-item:nth-child(even) {
        background-color: #fff;
        color: #000; /* Beyaz arka planda siyah yazÄ± */
      }

      @keyframes scroll-traffic {
        from {
          transform: translateX(0%);
        }
        to {
          transform: translateX(-100%);
        }
      }
    </style>
    <!-- Firebase SDK'larÄ± -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  </head>
  <body>
    <div id="intro-overlay">
      <canvas id="matrix-canvas"></canvas>
      <div class="intro-content" style="position: relative; z-index: 1">
        <h1>KÃ¼Ã§Ã¼kpark Taksi</h1>
        <h2>Durak Takip UygulamasÄ±</h2>
        <button class="intro-button">GiriÅŸ Yapmak Ä°Ã§in TÄ±kla</button>
      </div>
    </div>
    <div id="debug-controls" style="display: none">
      <div>
        <span>Merkez:</span>
        <button id="add-merkez">+</button>
        <button id="add-closed-merkez">K+</button>
        <button id="remove-merkez">-</button>
      </div>
      <div>
        <span>Metro:</span>
        <button id="add-metro">+</button>
        <button id="add-closed-metro">K+</button>
        <button id="remove-metro">-</button>
      </div>
      <div>
        <span>SÃ¼vari:</span>
        <button id="add-suvari">+</button>
        <button id="add-closed-suvari">K+</button>
        <button id="remove-suvari">-</button>
      </div>
    </div>
    <!-- YENÄ°: Terminal Penceresi Ã‡erÃ§evesi -->
    <div class="content" style="display: none">
      <div id="terminal-window">
        <div id="title-bar">
          <div class="buttons">
            <span style="background: #ff5f57"></span>
            <span style="background: #ffbd2e"></span>
            <span style="background: #27c93f"></span>
          </div>
          <div class="title">kucukpark@taksi: ~</div>
          <!-- YENÄ°: Tam Ekran Butonu -->
          <div id="fullscreen-btn">â›¶</div>
        </div>
        <div
          id="debug-warning"
          style="
            color: yellow;
            font-weight: bold;
            display: none;
            margin-bottom: 1rem;
            text-align: center;
          "
        >
          DÄ°KKAT: DEBUG MODU AKTÄ°F
        </div>
        <div id="main-container">
          <div class="updatetime-container">
            <!-- YÃ¼kleniyor simgesi -->
            <div id="loader" class="loader"></div>
            <!-- Yeni Bilgi Tablosu -->
            <table id="info-table" style="display: none">
              <tbody>
                <tr>
                  <td class="info-key">Son GÃ¼ncelleme:</td>
                  <td id="info-updatetime" class="info-value"></td>
                </tr>
                <tr>
                  <td class="info-key">AraÃ§ DurumlarÄ±:</td>
                  <td id="info-gps" class="info-value"></td>
                </tr>
                <tr>
                  <td class="info-key">Duyuru:</td>
                  <td id="info-closed-vehicle" class="info-value"></td>
                </tr>
                <tr>
                  <td class="info-key">Hava Durumu:</td>
                  <td id="info-weather" class="info-value"></td>
                </tr>
              </tbody>
            </table>
          </div>
          <!-- YENÄ°: Kayan trafik bandÄ± iÃ§in kapsayÄ±cÄ± -->
          <div id="traffic-banner-container" style="display: none;"><div id="traffic-banner-content"></div></div>
          <div id="duraklar-container" class="container"></div>
        </div>
      </div>
    </div>
    <div id="global-cursor"></div>
    <script>
      // --- Cihaz Engelleme KontrolÃ¼ ---
      // Bu fonksiyon, sayfanÄ±n geri kalanÄ± Ã§alÄ±ÅŸmadan Ã¶nce Ã§aÄŸrÄ±lÄ±r.
      (function () {
        // Engellenecek cihaz modellerini bu diziye ekleyebilirsiniz.
        const blockedModels = [];
        const userAgent = navigator.userAgent;

        // User agent'Ä±n engellenen modellerden herhangi birini iÃ§erip iÃ§ermediÄŸini kontrol et
        const isBlocked = blockedModels.some((model) =>
          userAgent.includes(model)
        );

        if (isBlocked) {
          const blockedModelFound = blockedModels.find((model) =>
            userAgent.includes(model)
          );
          // Sayfa iÃ§eriÄŸini temizle ve uyarÄ± mesajÄ± gÃ¶ster
          document.documentElement.innerHTML = `
            <head><title>Desteklenmiyor</title><meta name="viewport" content="width=device-width, initial-scale=1.0"></head>
            <body style="background-color: black; color: white; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; font-family: 'Kode Mono', monospace; text-align: center; padding: 20px;">
            </body>`;
          throw new Error("Desteklenmeyen cihaz modeli: " + blockedModelFound); // Script'in geri kalanÄ±nÄ±n Ã§alÄ±ÅŸmasÄ±nÄ± engelle
        }
      })();

      // Firebase yapÄ±landÄ±rma bilgileri
      const firebaseConfig = {
        apiKey: "AIzaSyCTTDvLsIY3ZS8zNP77lxLG0SdoOke2vLk",
        authDomain: "kptakip.firebaseapp.com",
        databaseURL:
          "https://kptakip-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "kptakip",
        storageBucket: "kptakip.firebasestorage.app",
        messagingSenderId: "401633293269",
        appId: "1:401633293269:web:8386edc126aafe1929435c",
      };
      // Firebase uygulamasÄ±nÄ± baÅŸlat
      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();
      const ref = database.ref("taksi_verileri");
      // ElemanlarÄ± seÃ§
      let mainContainer = document.getElementById("main-container");
      let duraklarContainer = document.getElementById("duraklar-container");
      let loaderElement = document.getElementById("loader");
      let infoTable = document.getElementById("info-table");
      let infoUpdateTime = document.getElementById("info-updatetime");
      let infoGps = document.getElementById("info-gps");
      let infoClosedVehicle = document.getElementById("info-closed-vehicle");
      let infoWeather = document.getElementById("info-weather");
      const globalCursor = document.getElementById("global-cursor");
      const terminalContent = document.querySelector(".content");

      // YENÄ°: DuraklarÄ± belirli bir sÄ±rada tutmak iÃ§in sabit
      const orderedDuraks = ["merkez", "metro", "suvari"];

      // YENÄ°: GiriÅŸ animasyonunu kontrol etmek iÃ§in sabit
      const ENABLE_BOOT_SEQUENCE = true;

      const HALT_AFTER_BOOT = false;

      // En son yÃ¼klenen veriyi tutmak iÃ§in deÄŸiÅŸken
      let latestData = null;
      // Ã–nceki araÃ§ sayÄ±larÄ±nÄ± tutmak iÃ§in deÄŸiÅŸken
      let previousVehicleCounts = {};
      // DuraklarÄ±n ses durumunu tutmak iÃ§in deÄŸiÅŸken
      let stationMuteStatus = {
        merkez: false, // false = ses aÃ§Ä±k, true = ses kapalÄ±
        metro: false,
        suvari: false,
      };
      // Ä°lk kullanÄ±cÄ± etkileÅŸimini takip etmek iÃ§in bayrak
      let firstInteraction = false;
      // Sesleri sÄ±rayla Ã§almak iÃ§in bir kuyruk ve durum deÄŸiÅŸkeni
      let audioQueue = [];
      let isPlayingAudio = false;
      // Web Audio API iÃ§in deÄŸiÅŸkenler
      let audioContext;
      // Son iÅŸlem yapÄ±lan aracÄ± ve duraÄŸÄ± takip etmek iÃ§in
      let lastModifiedVehicle = { durakKey: null, plate: null, action: null };
      // Ã–nceki tam veriyi tutmak iÃ§in
      let previousData = null;
      let audioBuffers = {};
      // YENÄ°: BoÅŸ durak anonslarÄ± iÃ§in zamanlayÄ±cÄ±larÄ± ve durumlarÄ± tutacak nesne
      let emptyStationTimers = {
        merkez: { timerId: null, lastAnnounced: 0 },
        metro: { timerId: null, lastAnnounced: 0 },
        suvari: { timerId: null, lastAnnounced: 0 },
      };
      let isPreloading = false;

      /**
       * YENÄ°: BoÅŸ duraklar iÃ§in sesli anonslarÄ± yÃ¶netir.
       */
      function manageEmptyStationAnnouncements() {
        if (!latestData || !firstInteraction) return;

        const now = Date.now();
        const EMPTY_STATION_INITIAL_DELAY = 3 * 60 * 1000; // 3 dakika
        const EMPTY_STATION_REPEAT_DELAY = 2 * 60 * 1000; // 2 dakika

        orderedDuraks.forEach((key) => {
          const aracSayisi = latestData.duraklar[key].liste
            ? latestData.duraklar[key].liste.filter((arac) => !arac.is_closed)
                .length
            : 0;

          if (aracSayisi === 0) {
            // Durak boÅŸ
            if (
              emptyStationTimers[key].timerId === null && // ZamanlayÄ±cÄ± zaten Ã§alÄ±ÅŸmÄ±yorsa
              emptyStationTimers[key].lastAnnounced === 0 // Ve daha Ã¶nce hiÃ§ anons yapÄ±lmadÄ±ysa
            ) {
              // ZamanlayÄ±cÄ±yÄ± baÅŸlat (eÄŸer daha Ã¶nce hiÃ§ anons yapÄ±lmadÄ±ysa)
              const timerId = setTimeout(() => {
                // 3 dakika geÃ§ti, ilk anonsu yap
                const audioUrl = `https://raw.githubusercontent.com/tektekno/deneme_yeni/master/voices/${key}0.opus`;
                if (!stationMuteStatus[key]) {
                  audioQueue.push(audioUrl);
                  playAudioFromQueue();
                }
                emptyStationTimers[key].lastAnnounced = Date.now();
              }, EMPTY_STATION_INITIAL_DELAY);
              emptyStationTimers[key].timerId = timerId;
            } else if (
              emptyStationTimers[key].lastAnnounced > 0 &&
              now - emptyStationTimers[key].lastAnnounced >=
                EMPTY_STATION_REPEAT_DELAY
            ) {
              // Tekrarlama sÃ¼resi doldu, tekrar anons yap
              const audioUrl = `https://raw.githubusercontent.com/tektekno/deneme_yeni/master/voices/${key}0.opus`;
              if (!stationMuteStatus[key]) {
                audioQueue.push(audioUrl);
                playAudioFromQueue();
              }
              emptyStationTimers[key].lastAnnounced = now;
            }
          } else {
            // Durak boÅŸ deÄŸil, zamanlayÄ±cÄ±yÄ± ve durumu temizle
            clearTimeout(emptyStationTimers[key].timerId);
            emptyStationTimers[key].timerId = null;
            emptyStationTimers[key].lastAnnounced = 0;
            // YENÄ°: Durak artÄ±k boÅŸ deÄŸilse, bu duraÄŸa ait "boÅŸ" anonsunu ses kuyruÄŸundan kaldÄ±r.
            // Bu, duraÄŸa araÃ§ girdikten sonra gecikmeli "boÅŸ" anonsunun Ã§alÄ±nmasÄ±nÄ± engeller.
            const emptyAudioUrl = `https://raw.githubusercontent.com/tektekno/deneme_yeni/master/voices/${key}0.opus`;
            audioQueue = audioQueue.filter((url) => url !== emptyAudioUrl);
          }
        });
      }

      /**
       * Saniye cinsinden verilen sÃ¼reyi "Xgn Ysa Zdk Psn" formatÄ±na dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r.
       * @param {number} totalSeconds - Toplam saniye sÃ¼resi.
       * @returns {string} FormatlanmÄ±ÅŸ sÃ¼re metni.
       */
      function formatDuration(totalSeconds) {
        if (totalSeconds < 0) {
          totalSeconds = 0;
        }

        const days = Math.floor(totalSeconds / (24 * 60 * 60));
        const hours = Math.floor((totalSeconds % (24 * 60 * 60)) / (60 * 60));
        const minutes = Math.floor((totalSeconds % (60 * 60)) / 60);
        const seconds = totalSeconds % 60;

        const parts = [];
        if (days > 0) {
          parts.push(`${days}gn`);
        }
        if (hours > 0) {
          parts.push(`${hours}sa`);
        }
        if (minutes > 0) {
          parts.push(`${minutes}dk`);
        }
        parts.push(`${seconds}sn`);

        return parts.join(" ");
      }

      /**
       * Zaman birimini formatlar. EÄŸer deÄŸer 0 ise ve forceDisplayZero true deÄŸilse boÅŸ string dÃ¶ndÃ¼rÃ¼r.
       * Tek haneli deÄŸerler iÃ§in bir boÅŸluk ekler ve saÄŸa yaslar.
       * @param {number} value - Zaman biriminin deÄŸeri (gÃ¼n, saat, dakika, saniye).
       * @param {string} unit - Zaman biriminin kÄ±saltmasÄ± (Ã¶rn: 'gn', 'sa', 'dk', 'sn').
       * @param {boolean} [forceDisplayZero=false] - DeÄŸer 0 olsa bile gÃ¶sterilmesini zorlar.
       * @param {string} [padChar='&nbsp;'] - Tek haneli deÄŸerler iÃ§in kullanÄ±lacak dolgu karakteri.
       * @returns {string} DoldurulmuÅŸ ve hizalanmÄ±ÅŸ metin veya boÅŸ string.
       */
      function padTimeDisplay(
        value,
        unit,
        forceDisplayZero = false,
        padChar = "&nbsp;"
      ) {
        if (value === 0 && !forceDisplayZero) {
          return "";
        }
        // Tek haneli deÄŸerler iÃ§in bir boÅŸluk ekle
        if (value < 10 && value >= 0) {
          return `${padChar}${value}${unit}`;
        }
        return `${value}${unit}`;
      }

      /**
       * YENÄ°: Trafik durumu verisini DÄ°KEY olarak iÅŸler ve renkli HTML Ã§Ä±ktÄ±sÄ± Ã¼retir.
       * @param {object} trafficData - Firebase'den gelen trafik_durumu nesnesi.
       * @returns {string} HTML olarak formatlanmÄ±ÅŸ dikey trafik durumu listesi.
       */
      function getTrafficStatusVertical(trafficData) {
        if (!trafficData) return "Veri yok";

        const statusMap = {
          AcikYol: { text: "AÃ§Ä±k", color: "#00ff41" },
          HafifYogunYol: { text: "Hafif", color: "#ffc800" },
          YogunYol: { text: "YoÄŸun", color: "#ff0000" },
        };

        const nameMap = {
          ankara_cd_gidis: "Ankara Cd. GidiÅŸ:",
          ankara_cd_donus: "Ankara Cd. DÃ¶nÃ¼ÅŸ:",
          ankara_cd_yanyol_gidis: "Ankara Cd. Yanyol GidiÅŸ:",
          ankara_cd_yanyol_donus: "Yan Yol DÃ¶nÃ¼ÅŸ:",
          agacli_yol: "AÄŸaÃ§lÄ± Yol:",
          adliye_kavsagi_gidis: "Adliye KavÅŸaÄŸÄ± GidiÅŸ:",
          alsancak_liman_yolu: "Alsancak Liman Yolu:",
          alsancak_gar_onu_gidis: "Alsancak Gar Ã–nÃ¼ GidiÅŸ:",
          alsancak_gar_onu_donus: "Alsancak Gar Ã–nÃ¼ DÃ¶nÃ¼ÅŸ:",
          alsancak_kordon: "Alsancak Kordon:",
          forum_agacli_yol_gidis: "Forum AÄŸaÃ§lÄ± Yol GidiÅŸ:",
          forum_agacli_yol_gelis: "Forum AÄŸaÃ§lÄ± Yol GeliÅŸ:",
          cesme_otobani_gidis: "Ã‡eÅŸme OtobanÄ± GidiÅŸ:",
          cigli_otobani_gidis: "Ã‡iÄŸli OtobanÄ± GidiÅŸ:",
        };

        // YENÄ°: Trafik bandÄ± iÃ§in HTML oluÅŸtur
        let html = "";
        const allKeys = Object.keys(trafficData);

        // Ä°ki kez yazdÄ±rarak kesintisiz bir dÃ¶ngÃ¼ oluÅŸtur
        [...allKeys, ...allKeys].forEach((key) => {
          if (!trafficData.hasOwnProperty(key)) return;
          const status = trafficData[key];
          const displayName = nameMap[key] || key;
          const { text, color } = statusMap[status] || {
            text: status,
            color: "white",
          };
          // Beyaz arka planda yazÄ± rengini ayarla
          const textColorStyle = `color: ${color}; text-shadow: 0 0 2px ${color};`;
          html += `<div class="traffic-item">${displayName} <span style="${textColorStyle}">${text}</span></div>`;
        });
        return html;
      }

      /**
       * Hava durumu kodunu okunabilir bir metne Ã§evirir.
       * @param {number} code - Open-Meteo'dan gelen hava durumu kodu.
       * @returns {string} Hava durumu aÃ§Ä±klamasÄ±.
       */
      function getWeatherDescription(code) {
        const descriptions = {
          0: "AÃ§Ä±k",
          1: "ParÃ§alÄ± Bulutlu",
          2: "ParÃ§alÄ± Bulutlu",
          3: "Bulutlu",
          45: "Sisli",
          48: "Sisli",
          51: "Ã‡iselemeli",
          53: "Ã‡iselemeli",
          55: "Ã‡iselemeli",
          56: "Dondurucu Ã‡iseleme",
          57: "Dondurucu Ã‡iseleme",
          61: "YaÄŸmurlu",
          63: "YaÄŸmurlu",
          65: "Åiddetli YaÄŸmurlu",
          66: "Dondurucu YaÄŸmur",
          67: "Dondurucu YaÄŸmur",
          71: "KarlÄ±",
          73: "KarlÄ±",
          75: "YoÄŸun KarlÄ±",
          77: "Kar Taneleri",
          80: "SaÄŸanak YaÄŸÄ±ÅŸlÄ±",
          81: "SaÄŸanak YaÄŸÄ±ÅŸlÄ±",
          82: "Åiddetli SaÄŸanak",
          95: "GÃ¶k GÃ¼rÃ¼ltÃ¼lÃ¼",
          96: "Hafif Dolu",
          85: "Kar SaÄŸanaÄŸÄ±",
          86: "YoÄŸun Kar SaÄŸanaÄŸÄ±",
          99: "Åiddetli Dolu",
        };
        return descriptions[code] || "Bilinmiyor";
      }

      /**
       * Bornova, Ä°zmir iÃ§in hava durumu verilerini Ã§eker ve gÃ¶sterir.
       */
      async function fetchWeather() {
        try {
          const response = await fetch(
            "https://api.open-meteo.com/v1/forecast?latitude=38.46&longitude=27.22&daily=weathercode&timezone=Europe/Istanbul"
          );
          const data = await response.json();

          const today = data.daily;

          // YaÄŸmur, kar, dolu ve fÄ±rtÄ±na gibi araÃ§ yÄ±kamaya uygun olmayan tÃ¼m kÃ¶tÃ¼ hava kodlarÄ±
          const badWeatherCodes = [
            51, 53, 55, 61, 63, 65, 66, 67, 71, 73, 75, 77, 80, 81, 82, 85, 86,
            95, 96, 99,
          ];
          const tomorrowCode = today.weathercode[1];
          const weatherRow = infoWeather.parentElement; // <tr> elementini al

          if (badWeatherCodes.includes(tomorrowCode)) {
            infoWeather.textContent = "ğŸŒ§ï¸â˜‚ï¸YakÄ±nda yaÄŸÄ±ÅŸ var, araÃ§ yÄ±kanmaz."; // Renk CSS'den gelecek
            // YaÄŸÄ±ÅŸ varsa, satÄ±r rengini camgÃ¶beÄŸi yap ama animasyon ekleme
            weatherRow.style.color = "#00ffff";
          } else {
            infoWeather.textContent = "YakÄ±nda yaÄŸÄ±ÅŸ yok, araÃ§ yÄ±kanÄ±r."; // Renk CSS'den gelecek
            // YaÄŸÄ±ÅŸ yoksa, satÄ±r rengini varsayÄ±lana dÃ¶ndÃ¼r
            weatherRow.style.color = "";
          }
        } catch (error) {
          console.error("Hava durumu verisi alÄ±namadÄ±:", error);
          infoWeather.textContent = "Bilgi alÄ±namadÄ±.";
        }
      }

      /**
       * TÃ¼m ses dosyalarÄ±nÄ± Ã¶nceden yÃ¼kler ve audioBuffers nesnesine kaydeder.
       */
      async function preloadAudioFiles() {
        if (isPreloading || Object.keys(audioBuffers).length > 33) return; // Zaten yÃ¼kleniyorsa veya yÃ¼klendiyse Ã§Ä±k
        isPreloading = true;
        console.log("Ses dosyalarÄ± Ã¶n yÃ¼kleniyor...");

        const duraklar = ["merkez", "metro", "suvari"];
        const promises = [];

        for (const durak of duraklar) {
          for (let i = 0; i <= 10; i++) {
            const fileName = `${durak}${i}.opus`;
            const url = `https://raw.githubusercontent.com/tektekno/deneme_yeni/master/voices/${fileName}`;

            const promise = fetch(url)
              .then((response) => response.arrayBuffer())
              .then((arrayBuffer) => audioContext.decodeAudioData(arrayBuffer))
              .then((decodedData) => {
                audioBuffers[url] = decodedData;
              })
              .catch((err) => {
                // console.error(`${fileName} yÃ¼klenemedi:`, err);
              });
            promises.push(promise);
          }
        }

        await Promise.all(promises);
        isPreloading = false;
        console.log("TÃ¼m ses dosyalarÄ± Ã¶n yÃ¼klendi.");
      }

      /**
       * Ses kuyruÄŸundaki dosyalarÄ± sÄ±rayla Ã§alar.
       */
      function playAudioFromQueue() {
        if (isPlayingAudio || audioQueue.length === 0 || !firstInteraction)
          return;

        isPlayingAudio = true;
        const urlToPlay = audioQueue.shift();
        const audioBuffer = audioBuffers[urlToPlay];

        if (!audioBuffer) {
          console.error(`Ses buffer'Ä± bulunamadÄ±: ${urlToPlay}`);
          isPlayingAudio = false; // Hata durumunda durumu sÄ±fÄ±rla
          // HatalÄ± olsa bile sÄ±radakine geÃ§
          setTimeout(playAudioFromQueue, 200);
          return;
        }

        const source = audioContext.createBufferSource();
        source.buffer = audioBuffer;
        source.connect(audioContext.destination);
        source.start(0);

        source.onended = () => {
          isPlayingAudio = false;
          // Sesler arasÄ±nda kÃ¼Ã§Ã¼k bir nefes payÄ± bÄ±rakmak iÃ§in kÄ±sa bir gecikme
          setTimeout(playAudioFromQueue, 200);
        };
      }

      /**
       * Bir satÄ±ra karakter karakter yazma efekti uygular.
       * @param {HTMLTableRowElement} row - Efektin uygulanacaÄŸÄ± satÄ±r.
       * @param {string[]} cellContents - HÃ¼crelere yazÄ±lacak iÃ§erikler.
       * @param {number} speed - Yazma hÄ±zÄ± (ms).
       */
      function typewriterEffect(row, cellContents, speed = 80) {
        // innerHTML yerine textContent kullanarak &nbsp; gibi karakterlerin gÃ¶rÃ¼nmesini engelle
        const textContents = cellContents.map((html) => {
          const tempDiv = document.createElement("div");
          tempDiv.innerHTML = html;
          return tempDiv.textContent || "";
        });
        const totalContent = textContents.join("");
        if (totalContent.length === 0) return;

        // Ã–nce satÄ±rÄ± boÅŸalt ve imleci ekle
        const cells = row.querySelectorAll("td");
        let charIndex = 0;

        // --- YENÄ° Ä°YÄ°LEÅTÄ°RME: SÃ¼tun kaymasÄ±nÄ± engelleme ---
        // Animasyon baÅŸlamadan Ã¶nce hÃ¼crelere tam iÃ§eriÄŸi gÃ¶rÃ¼nmez bir ÅŸekilde yÃ¼kleyip
        // tarayÄ±cÄ±nÄ±n sÃ¼tun geniÅŸliklerini hesaplamasÄ±nÄ± saÄŸla, sonra temizle.
        cells.forEach((cell, i) => {
          cell.style.visibility = "hidden";
          cell.innerHTML = cellContents[i];
        });
        // TarayÄ±cÄ±nÄ±n DOM'u gÃ¼ncellemesi iÃ§in kÄ±sa bir gecikme
        setTimeout(() => {
          cells.forEach((cell) => {
            cell.style.visibility = "visible";
            cell.innerHTML = "";
          });
          type(); // Animasyonu baÅŸlat
        }, 0);

        function type() {
          if (charIndex < totalContent.length) {
            let currentLength = 0;
            for (let i = 0; i < textContents.length; i++) {
              const cellText = textContents[i];
              const remainingLengthInCell = charIndex - currentLength;

              if (remainingLengthInCell >= 0) {
                const currentCellText = cellText.substring(
                  0,
                  remainingLengthInCell + 1
                );
                cells[i].textContent = currentCellText;

                // Ä°mleci sadece son karakterin yazÄ±ldÄ±ÄŸÄ± hÃ¼crede gÃ¼ncelle
                if (charIndex < currentLength + cellText.length) {
                  // --- YENÄ° YÃ–NTEM: Ä°mleÃ§ pozisyonunu Range ile al (Hizalama sorununu Ã§Ã¶zer) ---
                  const range = document.createRange();
                  // HÃ¼crede metin dÃ¼ÄŸÃ¼mÃ¼ varsa onu, yoksa hÃ¼crenin kendisini referans al.
                  const textNode = cells[i].firstChild || cells[i];
                  // Range'i metnin sonuna ayarla.
                  range.setStart(textNode, currentCellText.length);
                  range.collapse(true); // Range'i baÅŸlangÄ±Ã§ noktasÄ±na daralt.

                  const rect = range.getBoundingClientRect();
                  globalCursor.style.top = `${rect.top + window.scrollY}px`;
                  globalCursor.style.left = `${rect.left + window.scrollX}px`;
                }
              }

              currentLength += cellText.length;
              if (charIndex < currentLength) break;
            }

            setTimeout(type, speed);
            charIndex++; // Ã–nce zamanlayÄ±cÄ±yÄ± kur, sonra indeksi artÄ±r
          } else {
            // Efekt bitince orijinal HTML'i geri yÃ¼kle
            cellContents.forEach(
              (content, i) => (cells[i].innerHTML = content)
            );
            globalCursor.style.display = "none"; // YENÄ°: Animasyon bitince global imleci gizle.
            // YENÄ°: Hizalama sorununu kesin olarak Ã§Ã¶zmek iÃ§in, animasyon bittikten sonra
            // tÃ¼m arayÃ¼zÃ¼ en gÃ¼ncel veriyle yeniden Ã§iz. Bu, tarayÄ±cÄ±nÄ±n tablo
            // dÃ¼zenini sÄ±fÄ±rlamasÄ±nÄ± ve doÄŸru hizalamayÄ± yapmasÄ±nÄ± saÄŸlar.
            renderData(latestData);
          }
        }
      }

      /**
       * Bir satÄ±rdan karakter karakter silme efekti uygular.
       * @param {HTMLTableRowElement} row - Efektin uygulanacaÄŸÄ± satÄ±r.
       * @param {Function} onComplete - Silme iÅŸlemi bittiÄŸinde Ã§aÄŸrÄ±lacak fonksiyon.
       * @param {number} speed - Silme hÄ±zÄ± (ms).
       */
      function deleteEffect(row, onComplete, speed = 50) {
        const cells = Array.from(row.querySelectorAll("td"));
        const reversedCells = [...cells].reverse(); // Sondan baÅŸa doÄŸru silmek iÃ§in
        let currentCellIndex = 0;

        // Silinecek metin kalmadÄ±ysa bitir
        if (reversedCells.every((cell) => cell.textContent.length === 0)) {
          onComplete();
          return;
        }

        function deleteFromCell() {
          // TÃ¼m hÃ¼creler boÅŸaldÄ±ysa animasyonu bitir
          if (currentCellIndex >= reversedCells.length) {
            moveCursorToBottom();
            onComplete();
            return;
          }

          let cell = reversedCells[currentCellIndex];

          // EÄŸer mevcut hÃ¼cre zaten boÅŸsa, bir sonrakine geÃ§
          while (cell && cell.textContent.length === 0) {
            currentCellIndex++;
            cell = reversedCells[currentCellIndex];
          }

          // EÄŸer hala geÃ§erli bir hÃ¼cre varsa, silme iÅŸlemine devam et
          if (cell) {
            cell.textContent = cell.textContent.slice(0, -1); // Son karakteri sil

            // YALNIZCA metin varsa imleci gÃ¼ncelle, aksi takdirde Ä±ÅŸÄ±nlanma olur.
            if (cell.firstChild) {
              const range = document.createRange();
              range.setStart(cell.firstChild, cell.textContent.length);
              range.collapse(true);
              const rect = range.getBoundingClientRect();
              globalCursor.style.top = `${rect.top + window.scrollY}px`;
              globalCursor.style.left = `${rect.left + window.scrollX}px`;
            }
            setTimeout(deleteFromCell, speed);
          } else {
            // Silinecek baÅŸka hÃ¼cre kalmadÄ±ysa animasyonu bitir.
            globalCursor.style.display = "none"; // Global imleci gizle.
            moveCursorToBottom(); // Ana imleci ve prompt'u gÃ¶ster.
            onComplete();
          }
        }
        deleteFromCell();
      }

      /**
       * Ä°mleci hedef konuma satÄ±r satÄ±r, sÃ¼tun sÃ¼tun taÅŸÄ±r.
       * @param {number} targetLeft - Hedef sol pozisyon.
       * @param {number} targetTop - Hedef Ã¼st pozisyon.
       * @param {Function} onComplete - Animasyon bittiÄŸinde Ã§alÄ±ÅŸacak fonksiyon.
       */
      function moveCursorStepByStep(targetLeft, targetTop, onComplete) {
        const cursorRect = globalCursor.getBoundingClientRect();
        let currentTop = cursorRect.top + window.scrollY;
        let currentLeft = cursorRect.left + window.scrollX;

        // 1px adÄ±m kullan
        const stepY = 20; // Dikey hÄ±zÄ± artÄ±rmak iÃ§in deÄŸeri yÃ¼kselttim
        const stepX = 15; // Yatay hÄ±zÄ± artÄ±rmak iÃ§in deÄŸeri yÃ¼kselttim

        function animate() {
          let moved = false;

          // Dikey hareket
          if (Math.abs(targetTop - currentTop) > 0.1) {
            const direction = Math.sign(targetTop - currentTop);
            currentTop += direction * stepY;
            // Hedefi geÃ§me kontrolÃ¼
            if (
              direction > 0 ? currentTop > targetTop : currentTop < targetTop
            ) {
              currentTop = targetTop;
            }
            globalCursor.style.top = `${currentTop}px`;
            moved = true;
          }
          // Yatay hareket (dikey bittikten sonra)
          else if (Math.abs(targetLeft - currentLeft) > 0.1) {
            const direction = Math.sign(targetLeft - currentLeft);
            currentLeft += direction * stepX;
            // Hedefi geÃ§me kontrolÃ¼
            if (
              direction > 0
                ? currentLeft > targetLeft
                : currentLeft < targetLeft
            ) {
              currentLeft = targetLeft;
            }
            globalCursor.style.left = `${currentLeft}px`;
            moved = true;
          }

          if (moved) requestAnimationFrame(animate);
          else if (onComplete) onComplete();
        }
        animate();
      }

      /**
       * Ä°mleci hedef satÄ±ra animasyonla taÅŸÄ±r.
       * @param {HTMLElement} targetRow - Hedef satÄ±r elementi.
       * @param {Function} onComplete - Animasyon bittiÄŸinde Ã§alÄ±ÅŸacak fonksiyon.
       */
      function animateCursorToRow(targetRow, onComplete) {
        const promptLine = document.getElementById("prompt-line");
        if (!globalCursor || !targetRow || !promptLine) {
          if (onComplete) onComplete();
          return;
        }

        promptLine.style.display = "none"; // YENÄ°: Animasyon baÅŸlarken komut satÄ±rÄ±nÄ± gizle.

        // YENÄ°: Animasyon baÅŸlarken ana imleci gizle, global imleci gÃ¶ster.
        document
          .getElementById("main-cursor")
          ?.style.setProperty("display", "none");
        globalCursor.style.display = "block";

        const targetRect = targetRow.getBoundingClientRect();
        const targetTop = targetRect.top + window.scrollY;
        const targetLeft = targetRect.left + window.scrollX;

        // YENÄ°: Animasyon bittiÄŸinde komut satÄ±rÄ±nÄ± tekrar gÃ¶ster.
        const animationCompleteCallback = () => {
          promptLine.style.display = "block"; // Komut satÄ±rÄ±nÄ± gÃ¶ster.
          if (onComplete) onComplete();
        };
        moveCursorStepByStep(targetLeft, targetTop, animationCompleteCallback);
      }

      /**
       * Global imleci en alttaki durak kutusunun altÄ±na taÅŸÄ±r.
       */
      function moveCursorToBottom() {
        // YENÄ°: EÄŸer baÅŸlangÄ±Ã§ animasyonu hala Ã§alÄ±ÅŸÄ±yorsa (yani ilk veri henÃ¼z gelmediyse),
        // bu fonksiyonun kendi prompt'unu oluÅŸturmasÄ±nÄ± engelle. Animasyon kendi prompt'unu yÃ¶netir.
        if (ENABLE_BOOT_SEQUENCE && !latestData) return;

        // YENÄ°: Prompt iÃ§in bir element oluÅŸtur (eÄŸer yoksa)
        let promptLine = document.getElementById("prompt-line");
        if (!promptLine) {
          promptLine = document.createElement("div");
          promptLine.id = "prompt-line";
          promptLine.innerHTML = `<span style="color: #00ff41;">kucukpark@taksi</span><span style="color: white;">:</span><span style="color: #5c99ff;">~</span><span style="color: white;">$&nbsp;</span><span id="main-cursor" class="blinking-cursor">â–ˆ</span>`;
          const mainContainer = document.getElementById("main-container");
          if (mainContainer) mainContainer.appendChild(promptLine);
        }

        // YENÄ°: Prompt'u mutlak konumlandÄ±rmak yerine normal akÄ±ÅŸta bÄ±rak.
        promptLine.style.position = "static";
        promptLine.style.display = "block"; // Veya 'inline-block'
        mainContainer.appendChild(promptLine); // Her zaman sonda olduÄŸundan emin ol
        mainContainer.scrollTop = mainContainer.scrollHeight; // En alta kaydÄ±r

        // Ä°mleci prompt'un sonuna konumlandÄ±r
        const promptRect = promptLine.getBoundingClientRect();
        // YENÄ°: ArtÄ±k global imleÃ§ burada konumlanmÄ±yor, sadece ana imleÃ§ gÃ¶steriliyor.
        globalCursor.style.display = "none";
        document
          .getElementById("main-cursor")
          ?.style.setProperty("display", "inline");
      }

      function runBootSequence(onComplete) {
        const container = document.getElementById("main-container");
        container.innerHTML = ""; // Ana iÃ§eriÄŸi temizle

        // YENÄ°: Komut satÄ±rÄ±nÄ± ve imleci animasyon sÄ±rasÄ±nda yÃ¶netmek iÃ§in oluÅŸtur.
        const promptLine = document.createElement("div");
        promptLine.id = "prompt-line";

        // YENÄ°: Yatay ve dikey mod iÃ§in farklÄ± padding deÄŸerleri ayarla.
        const aspectRatio = window.innerWidth / window.innerHeight;
        // YENÄ°: Metinleri sola yaslamak iÃ§in yatay padding kaldÄ±rÄ±ldÄ±.
        const paddingStyle = "0 0.2vw";

        promptLine.style.padding =
          "0"; /* YENÄ°: Padding'i sÄ±fÄ±rla, hizalama iÃ§in span'e ekle */
        promptLine.style.whiteSpace = "pre";
        promptLine.innerHTML = `<span style="padding: 0 0.1vw; display: inline-block;"><span style="color: #00ff41;">kucukpark@taksi</span><span style="color: white;">:</span><span style="color: #5c99ff;">~</span><span style="color: white;">$&nbsp;</span><span id="main-cursor" class="blinking-cursor">â–ˆ</span></span>`;
        container.appendChild(promptLine);

        const modules = [
          "core-services",
          "network-interfaces",
          "security-protocols",
          "audio-subsystem",
          "geolocation-api",
          "data-sync-manager",
          "ui-renderer",
          "voice-assistant-module",
          "realtime-listeners",
          "asset-preloader",
        ];

        let moduleIndex = 0;

        function loadNextModule() {
          if (moduleIndex < modules.length) {
            const moduleName = modules[moduleIndex];

            // YENÄ°: YÃ¼kleme metni ve progress bar iÃ§in ayrÄ± elementler oluÅŸtur.
            const textElement = document.createElement("div");
            textElement.style.padding = paddingStyle;
            textElement.style.whiteSpace = "pre";
            textElement.textContent = `Loading ${moduleName}...`;

            const barContainer = document.createElement("div");
            barContainer.style.padding = paddingStyle;
            barContainer.style.whiteSpace = "pre";

            // Elementleri komut satÄ±rÄ±nÄ±n Ã¼stÃ¼ne ekle.
            container.insertBefore(textElement, promptLine);
            container.insertBefore(barContainer, promptLine);

            let progress = 0;
            const totalAnimationTime = 300; // Her bar iÃ§in toplam animasyon sÃ¼resi (ms)

            // YENÄ°: Progress bar geniÅŸliÄŸini, Ã¼stÃ¼ndeki metnin uzunluÄŸuna gÃ¶re ayarla.
            // Bu, ekran geniÅŸliÄŸinden baÄŸÄ±msÄ±z, tutarlÄ± bir gÃ¶rÃ¼nÃ¼m saÄŸlar.
            const progressBarWidth =
              textElement.textContent.length - "[] 100%".length;
            const stepDelay = totalAnimationTime / progressBarWidth;

            function updateProgress() {
              if (progress <= progressBarWidth) {
                const bar =
                  "[" +
                  "â–ˆ".repeat(progress) +
                  "â”€".repeat(progressBarWidth - progress) +
                  "]"; // YENÄ°: TaÅŸma sorununu Ã§Ã¶zmek iÃ§in karakter deÄŸiÅŸtirildi.
                const percentage = Math.floor(
                  (progress / progressBarWidth) * 100
                );
                barContainer.textContent = `${bar} ${percentage}%`;

                container.scrollTop = container.scrollHeight;

                progress++;
                setTimeout(updateProgress, stepDelay);
              } else {
                // YÃ¼kleme tamamlandÄ±, [OK] gÃ¶ster
                textElement.innerHTML += ` <span style="color: #00ff41;">[OK]</span>`;
                barContainer.remove(); // Progress bar'Ä± kaldÄ±r.
                moduleIndex++;
                setTimeout(loadNextModule, Math.random() * 150 + 50);
              }
            }
            updateProgress();
          } else {
            // TÃ¼m modÃ¼ller yÃ¼klendi
            const finalMsg = document.createElement("div");
            finalMsg.style.padding = paddingStyle;
            finalMsg.style.color = "#ffc800";
            finalMsg.textContent = "\nSystem ready. Welcome, operator.";
            container.insertBefore(finalMsg, promptLine); // YENÄ°: MesajÄ± komut satÄ±rÄ±nÄ±n Ã¼zerine ekle.

            container.scrollTop = container.scrollHeight;
            if (!HALT_AFTER_BOOT) {
              setTimeout(onComplete, 700);
            }
          }
        }
        loadNextModule();
      }

      function renderData(data, options = { playSound: true }) {
        // En son veriyi global olarak sakla
        latestData = data;

        // YÃ¼kleme simgesini gizle ve gÃ¼ncelleme metinlerini gÃ¶ster
        loaderElement.style.display = "none";
        infoTable.style.display = "table";

        // GÃ¼ncelleme zamanÄ±nÄ± ve GPS bilgi metnini ayarla
        infoUpdateTime.textContent = data.son_guncelleme;
        infoGps.textContent = "TÃ¼m araÃ§lardaki sorunlar dÃ¼zeltildi."; // Metin zaten doÄŸru, teyit edildi.
        infoClosedVehicle.textContent =
          "KÄ±rmÄ±zÄ± renkteki araÃ§lar kapalÄ±dÄ±r, sÄ±raya dahil deÄŸildir.";

        // Hava durumu verisini sadece ana veri yÃ¼klendikten sonra Ã§ek ve gÃ¶ster
        fetchWeather();

        // Dinamik font bÃ¼yÃ¼klÃ¼ÄŸÃ¼ sÄ±nÄ±flarÄ± iÃ§in stilleri dinamik olarak ekle
        // "AraÃ§ DurumlarÄ±" satÄ±rÄ±na metalik parlama efekti ekle
        infoGps.parentElement.classList.add("metal-effect");

        const contentDiv = document.querySelector(".content");
        const aspectRatio = window.innerWidth / window.innerHeight;

        // Durak bilgilerini iÅŸle
        // --- ANÄ°MASYON Ä°YÄ°LEÅTÄ°RMESÄ° ---
        // Silme animasyonunun bozulmamasÄ± iÃ§in, eÄŸer silme iÅŸlemi yapÄ±lmÄ±yorsa veya zaten durak yoksa DOM'u temizle.
        // Silme iÅŸlemi sÄ±rasÄ±nda DOM temizlenmeyecek, sadece ilgili satÄ±r animasyonla silinecek.
        duraklarContainer.innerHTML = "";
        const duraklar = data.duraklar;
        // YENÄ°: Trafik bandÄ±nÄ± render et
        renderTrafficBanner(data);

        const durak_names = {
          suvari: "SÃ¼vari",
          merkez: "Merkez",
          metro: "Metro",
        };

        // Ortalama kalkÄ±ÅŸ sÃ¼relerini topla ve sÄ±rala
        const averageTimes = orderedDuraks
          .map((key) => ({
            key,
            time: duraklar[key].ortalama_kalkis,
          }))
          .sort((a, b) => a.time - b.time);

        // En hÄ±zlÄ±, orta ve en yavaÅŸ duraklarÄ± belirle
        const fastest = averageTimes[0].key;
        const middle = averageTimes[1].key;
        const slowest = averageTimes[2].key;

        // --- YENÄ° ORANTISAL YÃœKSEKLÄ°K HESAPLAMA MANTIÄI ---
        // 1. TÃ¼m duraklardaki araÃ§ sayÄ±larÄ±nÄ± al
        const vehicleCounts = {
          merkez: duraklar.merkez.liste ? duraklar.merkez.liste.length : 0,
          metro: duraklar.metro.liste ? duraklar.metro.liste.length : 0,
          suvari: duraklar.suvari.liste ? duraklar.suvari.liste.length : 0,
        };
        const totalVehicles =
          vehicleCounts.merkez + vehicleCounts.metro + vehicleCounts.suvari;

        // DeÄŸiÅŸiklik tespiti (Ekleme/Silme)
        if (previousData) {
          for (const key of orderedDuraks) {
            const prevList = previousData.duraklar[key].liste || [];
            const newList = data.duraklar[key].liste || [];

            // Eklenen araÃ§ tespiti
            const addedVehicle = newList.find(
              (n) => !prevList.some((p) => p.plate === n.plate)
            );
            if (addedVehicle) {
              lastModifiedVehicle = {
                durakKey: key,
                plate: addedVehicle.plate,
                action: "add",
              };
              break; // Ä°lk deÄŸiÅŸikliÄŸi bul ve Ã§Ä±k
            }
          }
        }

        const newVehicleCounts = {};
        // --- SESLÄ° BÄ°LDÄ°RÄ°M (Sadece playSound true ise Ã§alÄ±ÅŸÄ±r) ---
        if (options.playSound) {
          const priorityOrder = ["suvari", "merkez", "metro"]; // Ã–ncelik sÄ±rasÄ±
          orderedDuraks.forEach((key) => {
            const aracSayisi = data.duraklar[key].liste
              ? data.duraklar[key].liste.filter((arac) => !arac.is_closed)
                  .length
              : 0;
            newVehicleCounts[key] = aracSayisi;
          });

          // Ã–ncelik sÄ±rasÄ±na gÃ¶re sesleri kuyruÄŸa ekle
          priorityOrder.forEach((key) => {
            if (
              // Ã–nceki araÃ§ sayÄ±sÄ± tanÄ±mlÄ±ysa ve yeni sayÄ± Ã¶ncekinden farklÄ±ysa anonsu tetikle.
              // Bu, hem araÃ§ eklendiÄŸinde hem de Ã§Ä±karÄ±ldÄ±ÄŸÄ±nda (0'a dÃ¼ÅŸse bile) Ã§alÄ±ÅŸÄ±r.
              previousVehicleCounts[key] !== undefined && // Ã–nceki sayÄ±nÄ±n tanÄ±mlÄ± olduÄŸundan emin ol
              previousVehicleCounts[key] !== newVehicleCounts[key] &&
              !stationMuteStatus[key] // EÄŸer ses kapalÄ± deÄŸilse
            ) {
              const audioUrl = `https://raw.githubusercontent.com/tektekno/deneme_yeni/master/voices/${key}${newVehicleCounts[key]}.opus`;

              // Kuyrukta aynÄ± duraÄŸa ait eski bir ses varsa onu kaldÄ±r.
              audioQueue = audioQueue.filter((url) => !url.includes(`/${key}`));
              audioQueue.push(audioUrl);
            } else if (
              previousVehicleCounts[key] === 0 &&
              newVehicleCounts[key] > 0
            ) {
              // Durak boÅŸ durumdan Ã§Ä±ktÄ±ÄŸÄ± iÃ§in "boÅŸ kaldÄ±" anonsunu ve zamanlayÄ±cÄ±sÄ±nÄ± iptal et.
              clearTimeout(emptyStationTimers[key].timerId);
              emptyStationTimers[key].timerId = null;
              emptyStationTimers[key].lastAnnounced = 0;
              const emptyAudioUrl = `https://raw.githubusercontent.com/tektekno/deneme_yeni/master/voices/${key}0.opus`;
              audioQueue = audioQueue.filter((url) => url !== emptyAudioUrl);
            }
          });

          if (audioQueue.length > 0 && !isPlayingAudio) {
            playAudioFromQueue();
          }
        }

        // Bir sonraki kontrol iÃ§in mevcut sayÄ±larÄ± kaydet
        previousVehicleCounts = newVehicleCounts;
        // Bir sonraki render iÃ§in tam veriyi kaydet
        previousData = JSON.parse(JSON.stringify(data));

        // Her bir durak iÃ§in ayrÄ± ayrÄ± hizalama uzunluÄŸunu belirle
        orderedDuraks.forEach((key) => {
          if (duraklar.hasOwnProperty(key)) {
            const durak = duraklar[key];
            const durakDiv = document.createElement("div");
            durakDiv.className = "durak";

            // HÄ±z durumuna gÃ¶re sÄ±nÄ±f ekle
            if (key === fastest) {
              durakDiv.classList.add("hizli");
            } else if (key === middle) {
              durakDiv.classList.add("orta");
            } else if (key === slowest) {
              durakDiv.classList.add("yavas");
            }

            let htmlContent = "";

            const aracListesi = durak.liste || [];
            const activeVehicles = aracListesi.filter(
              (arac) => !arac.is_closed
            );
            const closedVehicles = aracListesi.filter((arac) => arac.is_closed);
            const aracSayisi = activeVehicles.length; // Sadece aktif araÃ§larÄ± say

            // BaÅŸlÄ±k satÄ±rÄ±
            const speakerIcon = stationMuteStatus[key] ? "ğŸ”‡" : "ğŸ”Š";
            htmlContent += `<span class="speaker-icon" data-durak-key="${key}">${speakerIcon}</span>`;

            htmlContent += `${durak_names[key]} (${aracSayisi})<br>`;

            // Ortalama kalkÄ±ÅŸ satÄ±rÄ±
            const formattedAverageDeparture = formatDuration(
              durak.ortalama_kalkis
            );
            htmlContent += `Ortalama KalkÄ±ÅŸ: ${formattedAverageDeparture}<br>`;

            // --- YENÄ° STÄ°L MANTIÄI ---
            // Ekran yÃ¶nÃ¼ne gÃ¶re duraklar container'Ä±nÄ±n stillerini ayarla
            if (aspectRatio < 1.1) {
              // Dikey mod iÃ§in JS ile stil ata
              duraklarContainer.style.flexDirection = "column";
              duraklarContainer.style.alignItems = "center";
              duraklarContainer.style.gap = "2.4vh";
            } else {
              // Yatay moda geÃ§ildiÄŸinde, dikey mod iÃ§in JS ile eklenen stilleri sÄ±fÄ±rla.
              // Bu, CSS media query'nin Ã§alÄ±ÅŸmasÄ±nÄ± saÄŸlar.
              duraklarContainer.style.flexDirection = "";
              duraklarContainer.style.alignItems = "";
              duraklarContainer.style.gap = "";
            }

            // --- AKIÅKAN FORMÃœL Ä°LE STÄ°L HESAPLAMA ---

            // 1. AkÄ±ÅŸkan Font Boyutu: Ekran daraldÄ±kÃ§a (aspectRatio kÃ¼Ã§Ã¼ldÃ¼kÃ§e) font bÃ¼yÃ¼r.
            const fluidFontSize = `clamp(1.4vw, ${2 / aspectRatio}vw, 4.5vw)`;

            // 2. AkÄ±ÅŸkan GeniÅŸlik: Ekran daraldÄ±kÃ§a geniÅŸlik artar.
            const fluidWidth = `clamp(30vw, ${50 / aspectRatio}vw, 85vw)`;

            // 3. Hesaplanan deÄŸerleri CSS deÄŸiÅŸkenleri olarak ata
            durakDiv.style.setProperty("--durak-font-size", fluidFontSize);
            durakDiv.style.setProperty("--durak-width", fluidWidth);

            // Bilgi tablosunun geniÅŸliÄŸini de duraklarla aynÄ± yapmak iÃ§in
            document.documentElement.style.setProperty(
              "--durak-width",
              fluidWidth
            );

            // 4. Dikey/Yatay dÃ¼zene gÃ¶re flex-grow ve height ayarla
            if (aspectRatio < 1.1) {
              // Sadece Dikey DÃ¼zen iÃ§in JS ayarÄ±
              durakDiv.style.height = "auto";
              durakDiv.style.minHeight = "11vh"; // YENÄ°: Dikey modda minimum yÃ¼kseklik saÄŸlar.
              let flexGrowValue = 1;
              if (totalVehicles > 0) {
                flexGrowValue = 1 + (vehicleCounts[key] / totalVehicles) * 10;
              }
              durakDiv.style.flexGrow = flexGrowValue.toFixed(2);
            } else {
              // Yatay DÃ¼zen iÃ§in JS ayarlarÄ±nÄ± sÄ±fÄ±rla (CSS yÃ¶netecek)
              durakDiv.style.height = "";
              durakDiv.style.minHeight = "";
              durakDiv.style.maxHeight = "";
              durakDiv.style.flexGrow = "";
            }

            // AyÄ±rÄ±cÄ± Ã§izgi
            htmlContent += `<hr class="separator-line">`;

            // AraÃ§ listesi
            if (aracListesi.length > 0) {
              htmlContent += '<table class="vehicle-table"><tbody>';

              // TÃ¼m araÃ§lar iÃ§in (aktif ve kapalÄ±) hangi zaman birimlerinin gÃ¶sterileceÄŸini belirle
              const showDays = aracListesi.some(
                (a) => a.entry_duration >= 86400
              );
              const showHours = aracListesi.some(
                (a) => a.entry_duration >= 3600
              );
              const showMinutes = aracListesi.some(
                (a) => a.entry_duration >= 60
              );

              // 1. KapalÄ± araÃ§larÄ± render et
              closedVehicles.forEach((arac) => {
                const rowStyle = 'style="color: #FF4C4C;"'; // Her zaman kÄ±rmÄ±zÄ±
                const totalSeconds = arac.entry_duration;
                const days = Math.floor(totalSeconds / (24 * 60 * 60));
                const hours = Math.floor(
                  (totalSeconds % (24 * 60 * 60)) / (60 * 60)
                );
                const minutes = Math.floor((totalSeconds % (60 * 60)) / 60);
                const seconds = totalSeconds % 60;

                htmlContent += `<tr ${rowStyle}>`;
                htmlContent += `<td>K)</td>`; // Ã–n ek "K)"
                htmlContent += `<td>${arac.code}</td>`;
                htmlContent += `<td>${arac.plate}</td>`;

                // SÃ¼re gÃ¶sterimi (aktif araÃ§larla aynÄ± formatta)
                if (showDays && days > 0) {
                  htmlContent += `<td class="right-align">${padTimeDisplay(
                    days,
                    "gn"
                  )}</td>`;
                }
                if (showHours) {
                  htmlContent += `<td class="right-align">${padTimeDisplay(
                    hours,
                    "sa"
                  )}</td>`;
                  htmlContent += `<td class="right-align">${padTimeDisplay(
                    minutes,
                    "dk"
                  )}</td>`;
                  htmlContent += `<td class="right-align">${padTimeDisplay(
                    seconds,
                    "sn",
                    true
                  )}</td>`;
                } else if (showMinutes) {
                  htmlContent += `<td class="right-align">${padTimeDisplay(
                    minutes,
                    "dk"
                  )}</td>`;
                  htmlContent += `<td class="right-align">${padTimeDisplay(
                    seconds,
                    "sn",
                    true
                  )}</td>`;
                } else {
                  htmlContent += `<td class="right-align">${padTimeDisplay(
                    seconds,
                    "sn",
                    true
                  )}</td>`;
                }

                htmlContent += `</tr>`;
              });

              // KapalÄ± ve aktif araÃ§lar arasÄ±nda ayÄ±rÄ±cÄ±
              if (closedVehicles.length > 0 && activeVehicles.length > 0) {
                htmlContent += `<tr><td colspan="7"><hr class="sub-separator-line"></td></tr>`;
              }

              // 2. Aktif araÃ§larÄ± render et
              activeVehicles.forEach((arac, index) => {
                const totalSeconds = arac.entry_duration;
                const days = Math.floor(totalSeconds / (24 * 60 * 60));
                const hours = Math.floor(
                  (totalSeconds % (24 * 60 * 60)) / (60 * 60)
                );
                const minutes = Math.floor((totalSeconds % (60 * 60)) / 60);
                const seconds = totalSeconds % 60;

                // Gizli mod aktifse kod ve plaka gÃ¶sterimini deÄŸiÅŸtir
                const displayCode = currentHiddenMode ? "**" : arac.code;
                const displayPlate =
                  currentHiddenMode && arac.plate.includes("T")
                    ? arac.plate.substring(0, arac.plate.indexOf("T") + 1) +
                      "****"
                    : arac.plate;

                // SatÄ±ra Ã¶zel ID ekle
                const rowId = `vehicle-${arac.plate.replace(/\s/g, "")}`;

                htmlContent += `<tr id="${rowId}">`;
                htmlContent += `<td>${index + 1})</td>`; // NumaralÄ± Ã¶n ek
                htmlContent += `<td>${displayCode}</td>`;
                htmlContent += `<td>${displayPlate}</td>`;

                if (showDays && days > 0) {
                  htmlContent += `<td class="right-align">${padTimeDisplay(
                    days,
                    "gn"
                  )}</td>`;
                }
                if (showHours) {
                  htmlContent += `<td class="right-align">${padTimeDisplay(
                    hours,
                    "sa"
                  )}</td>`;
                  htmlContent += `<td class="right-align">${padTimeDisplay(
                    minutes,
                    "dk"
                  )}</td>`;
                  htmlContent += `<td class="right-align">${padTimeDisplay(
                    seconds,
                    "sn",
                    true
                  )}</td>`;
                } else if (showMinutes) {
                  htmlContent += `<td class="right-align">${padTimeDisplay(
                    minutes,
                    "dk"
                  )}</td>`;
                  htmlContent += `<td class="right-align">${padTimeDisplay(
                    seconds,
                    "sn",
                    true
                  )}</td>`;
                } else {
                  htmlContent += `<td class="right-align">${padTimeDisplay(
                    seconds,
                    "sn",
                    true
                  )}</td>`;
                }

                htmlContent += `</tr>`;
              });

              htmlContent += "</tbody></table>";
            } else {
              htmlContent += "BoÅŸ"; // HiÃ§ araÃ§ yoksa
            }

            // YENÄ°: Sadece kapalÄ± araÃ§ varsa, altÄ±na Ã§izgi ve "BoÅŸ" yazÄ±sÄ± ekle
            if (closedVehicles.length > 0 && activeVehicles.length === 0) {
              htmlContent += `<hr class="sub-separator-line">`;
              htmlContent += "BoÅŸ";
            }

            durakDiv.innerHTML = htmlContent;

            // YENÄ°: Mevcut durak div'ini bul ve yenisiyle deÄŸiÅŸtir, yoksa ekle.
            // Bu, innerHTML = "" kullanmaktan daha gÃ¼venlidir ve prompt'u korur.
            const existingDurakDiv = Array.from(
              duraklarContainer.children
            ).find((child) => child.querySelector(`[data-durak-key="${key}"]`));
            if (existingDurakDiv) {
              duraklarContainer.replaceChild(durakDiv, existingDurakDiv);
            } else {
              duraklarContainer.appendChild(durakDiv);
            }
          }
        });

        // --- EKLEME EFEKTÄ° UYGULAMA ---
        if (lastModifiedVehicle.action === "add" && lastModifiedVehicle.plate) {
          const plateId = lastModifiedVehicle.plate.replace(/\s/g, "");
          const rowElement = document.getElementById(`vehicle-${plateId}`);
          if (rowElement) {
            const cells = Array.from(rowElement.querySelectorAll("td"));
            const cellContents = cells.map((td) => td.innerHTML);
            rowElement.innerHTML = "<td>&nbsp;</td>".repeat(cells.length);
            animateCursorToRow(rowElement, () => {
              typewriterEffect(rowElement, cellContents);
            });
          }
          // Efekt uygulandÄ±ktan sonra sÄ±fÄ±rla
          lastModifiedVehicle = { durakKey: null, plate: null, action: null };
        } else {
          // EÄŸer ekleme/silme efekti yoksa, imleci direkt hareket ettir.
          // renderData'nÄ±n DOM'u gÃ¼ncellemesi iÃ§in kÃ¼Ã§Ã¼k bir gecikme bÄ±rak.
          setTimeout(moveCursorToBottom, 100);
        }

        // YENÄ°: Veri her gÃ¼ncellendiÄŸinde boÅŸ durak kontrolÃ¼nÃ¼ de tetikle.
        if (options.playSound) {
          manageEmptyStationAnnouncements();
        }
      }

      // --- DEBUG MODU ---
      // Test verilerini kullanmak iÃ§in `true`, gerÃ§ek zamanlÄ± Firebase verilerini kullanmak iÃ§in `false` yapÄ±n.
      const DEBUG_MODE = false;

      // --- GÄ°ZLÄ° MOD AYARLARI ---

      // ZamanlayÄ±cÄ±yÄ± aktif etmek iÃ§in `true`, manuel kontrol iÃ§in `false` yapÄ±n.
      const HIDDEN_MODE_TIMER = false;

      // ZamanlayÄ±cÄ± kapalÄ±yken (HIDDEN_MODE_TIMER = false) gizli modu manuel aÃ§Ä±p kapatmak iÃ§in bu ayarÄ± kullanÄ±n.
      const HIDDEN_MODE_MANUAL = false;

      // ZamanlayÄ±cÄ± ayarlarÄ± (Sadece HIDDEN_MODE_TIMER = true ise geÃ§erlidir)
      const HIDDEN_MODE_START_HOUR = 16;
      const HIDDEN_MODE_START_MINUTE = 0;
      const HIDDEN_MODE_END_HOUR = 5;
      const HIDDEN_MODE_END_MINUTE = 30;

      // --- GÄ°ZLÄ° MOD KONTROL MANTIÄI ---
      function isHiddenModeActive() {
        if (!HIDDEN_MODE_TIMER) {
          return HIDDEN_MODE_MANUAL;
        }

        const now = new Date();
        // UTC saatini alÄ±p Ã¼zerine 3 saat ekleyerek TÃ¼rkiye saatini buluyoruz.
        // Bu metod, tarayÄ±cÄ± saat dilimi ayarÄ±ndan baÄŸÄ±msÄ±z olarak UTC+3 saatini hesaplar.
        const turkeyHour = (now.getUTCHours() + 3) % 24;
        const turkeyMinute = now.getUTCMinutes();

        // Saat baÅŸlangÄ±Ã§ saatinden sonra mÄ±? (BaÅŸlangÄ±Ã§ dakikasÄ± dahildir: >=)
        const isAfterStart =
          turkeyHour > HIDDEN_MODE_START_HOUR ||
          (turkeyHour === HIDDEN_MODE_START_HOUR &&
            turkeyMinute >= HIDDEN_MODE_START_MINUTE);

        // Saat bitiÅŸ saatinden Ã¶nce mi? (BitiÅŸ dakikasÄ± dahil deÄŸildir: <)
        // DÃœZELTME: Gizli modun bitiÅŸ saatinde (Ã¶rn. 05:30) kapanmasÄ± iÃ§in minute kontrolÃ¼nÃ¼ '<' yaptÄ±k.
        const isBeforeEnd =
          turkeyHour < HIDDEN_MODE_END_HOUR ||
          (turkeyHour === HIDDEN_MODE_END_HOUR &&
            turkeyMinute < HIDDEN_MODE_END_MINUTE);

        // Gece yarÄ±sÄ±nÄ± geÃ§en bir aralÄ±k mÄ± kontrolÃ¼ (Ã¶rn: 16:00 - 05:30)
        if (HIDDEN_MODE_START_HOUR > HIDDEN_MODE_END_HOUR) {
          // Ya baÅŸlangÄ±Ã§tan sonra (aynÄ± gÃ¼n) YA DA bitiÅŸten Ã¶nce (ertesi gÃ¼n)
          return isAfterStart || isBeforeEnd;
        }
        // AynÄ± gÃ¼n iÃ§indeki aralÄ±k kontrolÃ¼ (Ã¶rn: 09:00 - 17:00)
        else {
          // Hem baÅŸlangÄ±Ã§tan sonra HEM DE bitiÅŸten Ã¶nce olmalÄ±
          return isAfterStart && isBeforeEnd;
        }
      }

      // BaÅŸlangÄ±Ã§ta gizli mod durumunu hesapla ve sakla
      let currentHiddenMode = isHiddenModeActive();

      /**
       * Gizli mod durumunu 5 saniyede bir kontrol eder ve arayÃ¼zÃ¼ gÃ¼nceller.
       */
      function checkHiddenModeAndRefresh() {
        const newHiddenMode = isHiddenModeActive();

        // EÄŸer gizli mod durumu deÄŸiÅŸtiyse VEYA DEBUG modunda isek (mock data'yÄ± gÃ¼ncellemek iÃ§in)
        if (newHiddenMode !== currentHiddenMode || DEBUG_MODE) {
          currentHiddenMode = newHiddenMode;
          // Yeni durumla birlikte arayÃ¼zÃ¼ yeniden Ã§iz
          if (latestData) {
            renderData(latestData);
          } else if (DEBUG_MODE) {
            // DEBUG modunda mockData'yÄ± tekrar render et
            // MockData'nÄ±n gÃ¼ncel HiddenMode ile Ã§alÄ±ÅŸmasÄ±nÄ± saÄŸla
            renderData(mockData);
          }
        }
      }

      // Her 5 saniyede bir gizli mod durumunu kontrol et
      setInterval(checkHiddenModeAndRefresh, 5000);

      // YENÄ°: Her 10 saniyede bir boÅŸ duraklarÄ± kontrol et
      setInterval(manageEmptyStationAnnouncements, 10000);

      // --- YENÄ°: Firebase Dinleyici FonksiyonlarÄ± (Global Kapsam) ---
      // Bu fonksiyonlarÄ± global kapsama taÅŸÄ±yarak, DOM yeniden oluÅŸturulduÄŸunda bile
      // referanslarÄ±nÄ±n kaybolmamasÄ±nÄ± saÄŸlÄ±yoruz.
      const firebaseListener = (snapshot) => {
        const data = snapshot.val();
        if (!data || !data.duraklar) {
          console.error("Veri alÄ±namadÄ± veya 'duraklar' anahtarÄ± bulunamadÄ±.");
          if (duraklarContainer) {
            duraklarContainer.innerHTML =
              '<p style="color:red; text-align:center;">Veri alÄ±namadÄ±. LÃ¼tfen Python betiÄŸinin Ã§alÄ±ÅŸtÄ±ÄŸÄ±ndan emin olun.</p>';
          }
          return;
        }

        if (previousData) {
          const removedVehicleInfo = orderedDuraks
            .map((key) => {
              const prevList = previousData.duraklar[key].liste || [];
              const newList = data.duraklar[key].liste || [];
              const removed = prevList.find(
                (p) => !newList.some((n) => n.plate === p.plate)
              );
              return removed ? { durakKey: key, ...removed } : null;
            })
            .find(Boolean);

          if (removedVehicleInfo) {
            const plateId = removedVehicleInfo.plate.replace(/\s/g, "");
            const rowElement = document.getElementById(`vehicle-${plateId}`);
            if (rowElement) {
              animateCursorToRow(rowElement, () => {
                deleteEffect(rowElement, () => renderData(data));
              });
              return;
            }
          }
        }
        renderData(data);
      };

      const firebaseErrorCallback = (error) => {
        console.error("Veri okuma hatasÄ±: ", error);
        if (duraklarContainer) {
          duraklarContainer.innerHTML =
            '<p style="color:red; text-align:center;">Veri okuma hatasÄ± oluÅŸtu. Konsolu kontrol edin.</p>';
        }
      };

      if (DEBUG_MODE) {
        // --- DEBUG MODU Ä°Ã‡Ä°N KONTROL VE VERÄ° YAPISI ---

        // 1. ButonlarÄ± ve kontrol panelini gÃ¶rÃ¼nÃ¼r yap
        const debugControls = document.getElementById("debug-controls");
        const STORAGE_KEY = "debugVehicleState";
        debugControls.style.display = "flex";
        document.getElementById("debug-warning").style.display = "block";

        // 2. TÃ¼m olasÄ± araÃ§larÄ± iÃ§eren bir havuz oluÅŸtur
        const allVehicles = [
          { code: "21", plate: "35T7575" },
          { code: "22", plate: "35T5702" },
          { code: "23", plate: "35T6619" },
          { code: "24", plate: "35T7734" },
          { code: "25", plate: "35T5595" },
          { code: "26", plate: "35T6913" },
          { code: "27", plate: "35T6581" },
          { code: "28", plate: "35T6272" },
          { code: "29", plate: "35T5023" },
          { code: "30", plate: "35T7274" },
          { code: "32", plate: "35T6383" },
          { code: "33", plate: "35T7623" },
          { code: "34", plate: "35T6975" },
          { code: "35", plate: "35T5601" },
          { code: "36", plate: "35T7812" },
          { code: "37", plate: "35T5071" },
        ];

        // 3. localStorage'dan kayÄ±tlÄ± durumu yÃ¼kle veya baÅŸlangÄ±Ã§ verisini oluÅŸtur
        const savedState = localStorage.getItem(STORAGE_KEY);
        const initialDuraklarState = savedState
          ? JSON.parse(savedState)
          : {
              merkez: { liste: [], ortalama_kalkis: 6200 },
              metro: { liste: [], ortalama_kalkis: 950 },
              suvari: {
                liste: [{ code: "27", plate: "35T6581", entry_duration: 40 }],
                ortalama_kalkis: 40,
              },
            };

        const mockData = {
          son_guncelleme: "18.09.2023 | 10:00:00 (Test Verisi)",
          duraklar: initialDuraklarState,
        };

        // 4. Butonlara olay dinleyicileri ekle
        document
          .getElementById("add-merkez")
          .addEventListener("click", () => addVehicle("merkez"));
        document
          .getElementById("add-closed-merkez")
          .addEventListener("click", () => addVehicle("merkez", true));
        document
          .getElementById("remove-merkez")
          .addEventListener("click", () => removeVehicle("merkez"));

        document
          .getElementById("add-metro")
          .addEventListener("click", () => addVehicle("metro"));
        document
          .getElementById("add-closed-metro")
          .addEventListener("click", () => addVehicle("metro", true));
        document
          .getElementById("remove-metro")
          .addEventListener("click", () => removeVehicle("metro"));

        document
          .getElementById("add-suvari")
          .addEventListener("click", () => addVehicle("suvari"));
        document
          .getElementById("add-closed-suvari")
          .addEventListener("click", () => addVehicle("suvari", true));
        document
          .getElementById("remove-suvari")
          .addEventListener("click", () => removeVehicle("suvari"));

        function saveState() {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(mockData.duraklar));
        }

        function getTotalVehicleCount() {
          return (
            mockData.duraklar.merkez.liste.length +
            mockData.duraklar.metro.liste.length +
            mockData.duraklar.suvari.liste.length
          );
        }

        function addVehicle(durakKey, isClosed = false) {
          if (mockData.duraklar[durakKey].liste.length >= 10) {
            // Not: alert() yerine daha iyi bir yÃ¶ntem kullanÄ±lmalÄ±dÄ±r, ancak debug iÃ§in kabul edilebilir.
            console.error("Bu duraÄŸa daha fazla araÃ§ eklenemez (maksimum 10)!");
            return;
          }

          if (getTotalVehicleCount() >= 16) {
            console.error("Toplam araÃ§ sayÄ±sÄ± 16'yÄ± geÃ§emez!");
            return;
          }

          // HenÃ¼z duraklarda olmayan bir araÃ§ bul
          const assignedPlates = [
            ...mockData.duraklar.merkez.liste,
            ...mockData.duraklar.metro.liste,
            ...mockData.duraklar.suvari.liste,
          ].map((v) => v.plate);
          const availableVehicle = allVehicles.find(
            (v) => !assignedPlates.includes(v.plate)
          );

          if (availableVehicle) {
            const newVehicle = {
              ...availableVehicle,
              entry_duration: Math.floor(Math.random() * 10000),
              is_closed: isClosed, // KapalÄ± olup olmadÄ±ÄŸÄ±nÄ± ayarla
            };
            mockData.duraklar[durakKey].liste.push(newVehicle);
            saveState(); // Durumu localStorage'a kaydet
            renderData(mockData); // ArayÃ¼zÃ¼ gÃ¼ncelle
          }
        }

        function removeVehicle(durakKey) {
          if (mockData.duraklar[durakKey].liste.length > 0) {
            // 1. Silinecek aracÄ± belirle
            const vehicleToRemove = mockData.duraklar[durakKey].liste.pop(); // .pop() hem siler hem de silineni dÃ¶ndÃ¼rÃ¼r.

            // 2. Animasyon iÃ§in satÄ±rÄ± DOM'dan bul ve klonla (veri silindikten SONRA).
            const plateId = vehicleToRemove.plate.replace(/\s/g, "");
            const rowElement = document.getElementById(`vehicle-${plateId}`);

            // 3. ArayÃ¼zÃ¼ gÃ¼ncel veriyle (araÃ§ silinmiÅŸ haliyle) yeniden Ã§iz.
            renderData(mockData);

            // 4. KlonlanmÄ±ÅŸ satÄ±r varsa (yani DOM'da bulunduysa) animasyonu baÅŸlat.
            if (rowElement) {
              const clonedRow = rowElement.cloneNode(true);
              const durakDiv = document.querySelector(
                `[data-durak-key="${durakKey}"]`
              )?.parentElement;
              const tableBody = durakDiv?.querySelector(".vehicle-table tbody");

              if (tableBody) {
                // Klonu animasyon iÃ§in geÃ§ici olarak ekle
                tableBody.appendChild(clonedRow);
                // Silme animasyonunu baÅŸlat ve bittiÄŸinde klonu kaldÄ±r
                animateCursorToRow(clonedRow, () => {
                  deleteEffect(clonedRow, () => {
                    clonedRow.remove();
                  });
                });
              }
            }

            saveState(); // State'i kaydet
          } else {
            console.error(`${durakKey} duraÄŸÄ±nda silinecek araÃ§ yok.`);
          }
        }

        // 5. Sayfa ilk yÃ¼klendiÄŸinde mock veriyi render et
        renderData(mockData);
      } else {
        // GerÃ§ek zamanlÄ± dinleyiciyi baÅŸlat
        ref.on("value", firebaseListener, firebaseErrorCallback);

        // Sayfa gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼ deÄŸiÅŸtiÄŸinde dinleyiciyi yÃ¶net
        document.addEventListener("visibilitychange", () => {
          if (document.hidden) {
            // Sayfa arka plana alÄ±ndÄ±: dinleyiciyi kapat ve sesleri temizle
            ref.off("value", firebaseListener);
            audioQueue = [];
            console.log("Uygulama askÄ±ya alÄ±ndÄ±, veri akÄ±ÅŸÄ± durduruldu.");
          } else {
            // Sayfa Ã¶n plana geldi: veriyi sessizce Ã§ek, sonra dinleyiciyi yeniden baÅŸlat
            console.log("Uygulama devam ediyor, veriler yenileniyor...");
            // Ã–nceki araÃ§ sayÄ±larÄ±nÄ±, ses Ã§almadan gÃ¼ncel durumla doldur.
            // Bu, bir sonraki gerÃ§ek gÃ¼ncellemede doÄŸru karÅŸÄ±laÅŸtÄ±rma yapÄ±lmasÄ±nÄ± saÄŸlar.
            ref.once("value", (snapshot) => {
              const data = snapshot.val();
              if (data && data.duraklar) {
                orderedDuraks.forEach((key) => {
                  previousVehicleCounts[key] = data.duraklar[key].liste
                    ? data.duraklar[key].liste.filter((arac) => !arac.is_closed)
                        .length
                    : 0;
                });
                renderData(data, { playSound: false });
              }
            });
            ref.on("value", firebaseListener, firebaseErrorCallback);
          }
        });
      }

      // Sayfa yÃ¼klendiÄŸinde ve pencere yeniden boyutlandÄ±rÄ±ldÄ±ÄŸÄ±nda tÃ¼m ayarlarÄ± yap
      window.addEventListener("load", () => {
        // --- Matrix Arka Plan Animasyonu ---
        const canvas = document.getElementById("matrix-canvas");
        const ctx = canvas.getContext("2d");

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const katakana =
          "ã‚¢ã‚¡ã‚«ã‚µã‚¿ãƒŠãƒãƒãƒ¤ãƒ£ãƒ©ãƒ¯ã‚¬ã‚¶ãƒ€ãƒãƒ‘ã‚¤ã‚£ã‚­ã‚·ãƒãƒ‹ãƒ’ãƒŸãƒªãƒ°ã‚®ã‚¸ãƒ‚ãƒ“ãƒ”ã‚¦ã‚¥ã‚¯ã‚¹ãƒ„ãƒŒãƒ•ãƒ ãƒ¦ãƒ¥ãƒ«ã‚°ã‚ºãƒ–ãƒ…ãƒ—ã‚¨ã‚§ã‚±ã‚»ãƒ†ãƒãƒ˜ãƒ¡ãƒ¬ãƒ±ã‚²ã‚¼ãƒ‡ãƒ™ãƒšã‚ªã‚©ã‚³ã‚½ãƒˆãƒãƒ›ãƒ¢ãƒ¨ãƒ§ãƒ­ãƒ²ã‚´ã‚¾ãƒ‰ãƒœãƒãƒ´ãƒƒãƒ³";
        const latin = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
        const nums = "0123456789";
        const alphabet = katakana + latin + nums;

        const fontSize = 16;
        const columns = canvas.width / fontSize;
        const rainDrops = [];

        for (let x = 0; x < columns; x++) {
          // YENÄ°: DamlalarÄ±n rastgele dikey konumlarda baÅŸlamasÄ±nÄ± saÄŸla
          rainDrops[x] = Math.floor(Math.random() * (canvas.height / fontSize));
        }

        const drawMatrix = () => {
          ctx.fillStyle = "rgba(0, 0, 0, 0.05)";
          ctx.fillRect(0, 0, canvas.width, canvas.height);

          ctx.fillStyle = "#00ff41"; // Matrix yeÅŸili
          ctx.font = fontSize + "px monospace";

          for (let i = 0; i < rainDrops.length; i++) {
            const text = alphabet.charAt(
              Math.floor(Math.random() * alphabet.length)
            );
            ctx.fillText(text, i * fontSize, rainDrops[i] * fontSize);

            if (
              rainDrops[i] * fontSize > canvas.height &&
              Math.random() > 0.975
            ) {
              rainDrops[i] = 0;
            }
            rainDrops[i]++;
          }
        };

        const matrixInterval = setInterval(drawMatrix, 33);

        // GiriÅŸ ekranÄ± iÃ§in olay dinleyicisi
        const introOverlay = document.getElementById("intro-overlay");
        const introButton = document.querySelector(".intro-button");

        introButton.addEventListener(
          "click",
          function () {
            // Ses motorunu "uyandÄ±r"
            function startApp() {
              if (!firstInteraction) {
                firstInteraction = true;
                // AudioContext'i oluÅŸtur veya devam ettir
                audioContext = new (window.AudioContext ||
                  window.webkitAudioContext)({ latencyHint: "playback" });
                audioContext.resume(); // KullanÄ±cÄ± etkileÅŸiminden sonra baÅŸlat

                // DiÄŸer sesleri arka planda yÃ¼kle
                preloadAudioFiles();
              }
              // Global imleci gÃ¶ster
              globalCursor.style.display = "block";
              // Terminal iÃ§eriÄŸini gÃ¶ster
              terminalContent.style.display = "flex";
              // GiriÅŸ ekranÄ±nÄ± yavaÅŸÃ§a gizle
              introOverlay.style.opacity = "0";
              // Animasyon bittikten sonra DOM'dan kaldÄ±r
              setTimeout(() => {
                if (introOverlay) {
                  clearInterval(matrixInterval); // Animasyonu durdur
                  introOverlay.remove();
                }
              }, 500);

              // EÄŸer boot animasyonu aktif deÄŸilse, imleci direkt aÅŸaÄŸÄ± taÅŸÄ±.
              // Aktifse, animasyon bittiÄŸinde veri zaten Ã§izileceÄŸi iÃ§in imleÃ§ de konumlanacak.
              if (!ENABLE_BOOT_SEQUENCE) {
                moveCursorToBottom();
              }
            }

            if (ENABLE_BOOT_SEQUENCE) {
              // Ã–nce arayÃ¼zÃ¼ hazÄ±rla, sonra animasyonu baÅŸlat.
              startApp();
              // Animasyon bittiÄŸinde, Firebase'den gelen ilk verinin Ã§izilmesini bekle.
              // Firebase listener zaten veriyi alÄ±nca renderData'yÄ± Ã§aÄŸÄ±racak.
              runBootSequence(() => {
                // Animasyon bittiÄŸinde ana container'Ä± temizle ki asÄ±l iÃ§erik gelsin.
                document.getElementById("main-container").innerHTML = `
                  <div class="updatetime-container">
                    <div id="loader" class="loader"></div>
                    <table id="info-table" style="display: none">
                      <tbody>
                        <tr><td class="info-key">Son GÃ¼ncelleme:</td><td id="info-updatetime" class="info-value"></td></tr>
                        <tr><td class="info-key">AraÃ§ DurumlarÄ±:</td><td id="info-gps" class="info-value"></td></tr>
                        <tr><td class="info-key">Duyuru:</td><td id="info-closed-vehicle" class="info-value"></td></tr>
                        <tr><td class="info-key">Hava Durumu:</td><td id="info-weather" class="info-value"></td></tr>
                      </tbody>
                    </table>
                  </div>
                  <div id="traffic-banner-container" style="display: none;"><div id="traffic-banner-content"></div></div>
                  <div id="duraklar-container" class="container"></div>
                `;
                // YENÄ°: DOM elementleri yeniden oluÅŸturulduÄŸu iÃ§in referanslarÄ± gÃ¼ncelle.
                mainContainer = document.getElementById("main-container");
                duraklarContainer =
                  document.getElementById("duraklar-container");
                loaderElement = document.getElementById("loader");
                infoTable = document.getElementById("info-table");
                infoUpdateTime = document.getElementById("info-updatetime");
                infoGps = document.getElementById("info-gps");
                infoClosedVehicle = document.getElementById(
                  "info-closed-vehicle"
                );
                infoWeather = document.getElementById("info-weather");

                // EÄŸer veri Ã§oktan geldiyse (animasyon sÄ±rasÄ±nda), hemen Ã§iz.
                if (latestData) {
                  renderData(latestData, { playSound: false });
                }
              });
            } else {
              // Animasyon kapalÄ±ysa, uygulamayÄ± direkt baÅŸlat.
              startApp();
            }
          },
          { once: true }
        ); // Olay dinleyicisi sadece bir kez Ã§alÄ±ÅŸsÄ±n

        // Ses kontrol ikonlarÄ± iÃ§in olay dinleyicisi
        document.body.addEventListener("click", function (e) {
          if (e.target && e.target.classList.contains("speaker-icon")) {
            const durakKey = e.target.getAttribute("data-durak-key");
            if (durakKey && stationMuteStatus.hasOwnProperty(durakKey)) {
              // Ses durumunu tersine Ã§evir
              stationMuteStatus[durakKey] = !stationMuteStatus[durakKey];
              // Ä°konu gÃ¼ncelle
              e.target.textContent = stationMuteStatus[durakKey] ? "ğŸ”‡" : "ğŸ”Š";
            }
          }
        });

        // YENÄ°: Tam ekran butonu iÃ§in olay dinleyicisi
        const fullscreenBtn = document.getElementById("fullscreen-btn");
        fullscreenBtn.addEventListener("click", () => {
          if (!document.fullscreenElement) {
            // Tam ekranda deÄŸilse, tam ekrana geÃ§
            document.documentElement.requestFullscreen().catch((err) => {
              alert(
                `Tam ekran moduna geÃ§ilemedi: ${err.message} (${err.name})`
              );
            });
          } else {
            // Tam ekrandaysa, Ã§Ä±k
            if (document.exitFullscreen) {
              document.exitFullscreen();
            }
          }
        });
      });

      // Pencere boyutu deÄŸiÅŸtiÄŸinde viewport bilgisini gÃ¼ncelle
      window.addEventListener("resize", () => {
        // YENÄ°: SayfayÄ± yeniden yÃ¼klemek yerine arayÃ¼zÃ¼ yeniden Ã§iz.
        // Bu, tam ekran veya dÃ¶ndÃ¼rme sÄ±rasÄ±nda baÅŸlangÄ±Ã§ ekranÄ±na dÃ¶nmeyi engeller.
        // Sadece giriÅŸ yapÄ±ldÄ±ysa ve veri varsa yeniden Ã§iz.
        if (!firstInteraction || !latestData) return;

        // Efektlerin ve animasyonlarÄ±n yeniden tetiklenmesini Ã¶nlemek iÃ§in
        // Ã¶nceki veri durumunu ve son iÅŸlem bilgisini sÄ±fÄ±rla.
        previousData = null; // Bu, renderData iÃ§indeki deÄŸiÅŸiklik tespitini sÄ±fÄ±rlar.
        lastModifiedVehicle = { durakKey: null, plate: null, action: null }; // AnimasyonlarÄ± sÄ±fÄ±rlar.

        // ArayÃ¼zÃ¼ mevcut veriyle yeniden Ã§iz.
        renderData(latestData);
      });

      // YENÄ°: Kayan trafik bandÄ±nÄ± oluÅŸturan fonksiyon
      function renderTrafficBanner(data) {
        if (!data || !data.trafik_durumu) return;

        const bannerContainer = document.getElementById(
          "traffic-banner-container"
        );
        const bannerContent = document.getElementById("traffic-banner-content");

        bannerContent.innerHTML = getTrafficStatusVertical(data.trafik_durumu);
        bannerContainer.style.display = "block";
      }
    </script>
  </body>
</html>
